<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生活動通告系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            font-size: 14px; 
        }
        .container { max-width: 1100px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        h1 { font-size: 1.7em; text-align: center; margin-bottom: 18px;}
        h2 { font-size: 1.4em; margin-top: 22px; margin-bottom:12px; border-bottom: 2px solid #3498db; padding-bottom: 7px;}
        h3 { font-size: 1.15em; margin-top: 18px; margin-bottom:8px; color: #3498db;}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="time"], .form-group input[type="number"], .form-group select, .form-group textarea {
            padding: 9px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; width: 100%; font-size: 0.95em; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3498db; outline: none; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .checkbox-group label, .radio-group label { margin-right: 12px; font-weight: normal; font-size: 0.95em; }
        .checkbox-group input, .radio-group input { margin-right: 4px; vertical-align: middle;}
        .button-group { margin-top: 25px; padding-top: 18px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        button, .file-input-label {
            background-color: #3498db; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em; transition: background-color 0.3s; text-align: center;
        }
        button:hover, .file-input-label:hover { background-color: #2980b9; }
        button.secondary { background-color: #95a5a6; }
        button.secondary:hover { background-color: #7f8c8d; }
        .file-input-hidden { display: none; }
        .student-list-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .student-list-table th, .student-list-table td { border: 1px solid #ddd; padding: 7px; text-align: left; font-size: 0.9em;}
        .student-list-table th { background-color: #f2f2f2; font-size: 0.85em; }
        .student-list-table input[type="text"], .student-list-table select { width: calc(100% - 8px); padding: 4px; font-size: 0.9em; }
        .student-list-table button { padding: 4px 7px; font-size: 0.75em; margin-top: 4px; background-color: #e74c3c;}
        .student-list-table button:hover { background-color: #c0392b;}
        .advanced-mode-toggle { display: flex; align-items: center; margin-bottom: 18px; justify-content: flex-end; }
        .advanced-mode-toggle label { margin-right: 8px; font-weight: bold; font-size: 0.95em;}
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; } 
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } 
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(22px); } 
        .hidden { display: none !important; }
        
        .pdf-page-render {
            display: none; 
            width: 210mm; 
            padding: 8mm; 
            box-sizing: border-box;
            background: white;
            color: black;
            font-family: 'KaiTi', '標楷體', 'MingLiU', 'PMingLiU', serif !important;
            font-size: 11.5pt; 
            line-height: 1.65; 
            position: relative; 
        }
        .pdf-page-render *, .pdf-page-render *:before, .pdf-page-render *:after {
            font-family: 'KaiTi', '標楷體', 'MingLiU', 'PMingLiU', serif !important;
            color: black !important;
            box-sizing: border-box;
        }
        .pdf-page-render p,
        .pdf-page-render li,
        .pdf-page-render div:not(#pdf-template-notice .notice-details-grid):not(#pdf-template-notice .reply-slip-details-grid):not(#pdf-template-notice .notice-date-principal-moved), /* More specific exclusions for grid/flex parents */
        .pdf-page-render span, 
        .pdf-page-render td,
        .pdf-page-render th
         { 
            page-break-inside: avoid !important; 
            -webkit-region-break-inside: avoid !important; 
            break-inside: avoid !important;
        }

        .pdf-page-render table { width: 100%; border-collapse: collapse; font-size: 10.5pt; margin-top: 1.5mm; margin-bottom: 1.5mm;}
        .pdf-page-render th, .pdf-page-render td { border: 0.5px solid black; padding: 1mm 1.5mm; vertical-align: top; word-break: break-all; }
        .pdf-page-render .header { text-align: center; font-size: 16pt; font-weight: bold; margin-bottom: 2.5mm; line-height: 1.2;}
        .pdf-page-render .sub-header { text-align: center; font-size: 13pt; font-weight: bold; margin-bottom: 4mm; line-height: 1.2;}
        .pdf-page-render .small-text { font-size: 9pt; line-height: 1.25;}
        .pdf-page-render .bold { font-weight: bold; }
        .pdf-page-render .align-right { text-align: right; }
        .pdf-page-render .section { margin-bottom: 3mm; }
        .pdf-page-render .grid-container { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 0.8mm; margin-bottom: 2.5mm;}
        .pdf-page-render .grid-item label { font-weight: bold; }
        .pdf-page-render .signature-area { margin-top: 5mm; }
        .pdf-page-render .signature-line { border-bottom: 0.5px solid black; display: inline-block; min-height: 1em; vertical-align: bottom;} 
        .underline-value { border-bottom: 0.5px solid black; padding: 0 1mm; display: inline-block; min-height: 1.2em; vertical-align: bottom; }

        /* === Specific styles for #pdf-template-notice === */
        #pdf-template-notice > div:first-child { 
            min-height: 20mm !important; 
            position: relative; /* Needed for absolute positioning of children */
        }
        #pdf-template-notice .school-logo-img { 
            position: absolute;
            top: 4mm !important; 
            left: 8mm !important; /* Keep original left padding */
            height: 20mm !important; 
            width: auto;   
            object-fit: contain; 
        }
        #pdf-template-notice .notice-top-right-container { 
            position: absolute;
            top: 4mm !important; 
            right: 8mm !important; /* Keep original right padding */
            text-align: right; font-size: 11.5pt;
        }
        
        #pdf-template-notice .notice-main-header { text-align: center; font-size: 18pt; font-weight: bold; margin-top: 0 !important; margin-bottom: 1mm !important; line-height: 1.2;}
        #pdf-template-notice .notice-sub-header { 
            text-align: center; font-size: 14pt; font-weight: bold; 
            margin-top:0; margin-bottom: 1.5mm !important; 
            line-height: 1.2; border-bottom: 1px solid black; 
            padding-bottom: 1.5mm !important; text-decoration: none; 
        }
        
        #pdf-template-notice .notice-to { margin-top: 2mm !important; margin-bottom: 1.5mm !important; font-size: 11.5pt;}
        #pdf-template-notice .notice-body { 
            text-align: left; margin-bottom: 1mm !important; 
            line-height: 1.4 !important; font-size: 11.5pt;
        }
        
        #pdf-template-notice .notice-closing-block { 
            margin-top: 2mm !important; /* Adjusted from 1.5mm for a bit more space */
        }
        #pdf-template-notice .notice-date-principal-moved { 
            display: flex; justify-content: space-between; align-items: baseline; 
            margin-bottom: 1.5mm !important; font-size: 11.5pt; 
        }
        #pdf-template-notice .notice-date-principal-moved .date-moved { border-bottom: 0.5px solid black; min-width: 50mm;}
        #pdf-template-notice .notice-date-principal-moved .principal-name { margin-left: auto; /* Ensures it pushes to the right */ }
        #pdf-template-notice .notice-date-principal-moved .principal-name span { border-bottom: 0.5px solid black; padding-left: 30mm; }

        #pdf-template-notice .notice-school-name-right { 
            text-align: right; font-weight: bold; font-size: 11.5pt; 
            margin-bottom: 3mm !important; 
        }
        
        #pdf-template-notice .notice-closing-block + hr { 
            display: none !important; 
        }
        
        #pdf-template-notice .activity-details-box { 
            border: 0.5px solid black; padding: 2mm !important; /* slightly increased padding */
            margin: 3mm 0 !important; 
        }
        #pdf-template-notice .activity-details-box * { 
            line-height: 1.35 !important; 
        }
        #pdf-template-notice .notice-details-header {
            font-weight: bold; margin-bottom: 2mm !important; /* slightly increased */
            font-size: 11.5pt; text-align: center;
        }
        #pdf-template-notice .notice-details-grid { 
            display: grid !important; /* Ensure grid is applied */
            grid-template-columns: auto 1fr auto 1fr !important; 
            gap: 1mm 4mm !important; /* Adjusted gap */
            margin-bottom: 1.5mm !important; font-size: 11.5pt;
        }
        #pdf-template-notice .notice-details-grid > span { page-break-inside: avoid !important; } 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+1), 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+3) 
        { 
            font-weight: bold; white-space: nowrap; padding-right:1mm; text-align: left;
        }
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+2), 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n)    
        { 
             border-bottom: 0.5px solid black; min-width: 40mm; padding-left:1mm; 
        }
        #pdf-template-notice .notice-remarks-container { 
            margin-top: 1.5mm !important; /* Adjusted */
            display: flex; font-size: 11.5pt;
        }
        #pdf-template-notice .notice-remarks-container .label { font-weight: bold; white-space: nowrap; padding-right:1mm; flex-shrink: 0;}
        #pdf-template-notice .notice-remarks-container .value { border-bottom: 0.5px solid black; display: inline-block; flex-grow: 1; min-height: 1.2em; vertical-align: bottom; padding-left:1mm;}
        #pdf-template-notice .notice-cost-info {
            margin: 2mm 0 1mm 0 !important; font-size: 11.5pt; text-align: left; padding-left: 1mm;
        }

        #pdf-template-notice .notice-signatures-container { 
            display: flex !important; /* Ensure flex */
            justify-content: space-between !important; 
            align-items: flex-start; 
            margin-top: 4mm !important; /* Adjusted */
            min-height: auto !important; 
            padding-bottom: 2mm !important; /* Adjusted */
        }
        #pdf-template-notice .notice-school-stamp-area { font-size: 11.5pt; flex-basis: 45%; text-align: left;}
        #pdf-template-notice .notice-school-stamp-box { 
            border: none !important; 
            height: auto !important; 
            line-height: normal !important;
            margin-top:1mm; text-align:center; font-size:9pt; color:#aaa !important; margin-left:0;
        }
        #pdf-template-notice .notice-teacher-signature-area { 
            font-size: 11.5pt; text-align:left; flex-basis: 50%;
        }
        #pdf-template-notice .teacher-sig-line { border-bottom: 0.5px solid black; min-width: 50mm; display:inline-block; text-align: center;}
        
        #pdf-template-notice .reply-slip-section-wrapper {
            page-break-inside: avoid !important; 
            break-inside: avoid-page !important; 
        }
        #pdf-template-notice .reply-slip-section-wrapper * { 
            line-height: 1.35 !important; 
        }
        #pdf-template-notice .reply-slip-header { 
            text-align: center; font-size: 13pt; font-weight: bold; 
            margin: 4mm 0 2mm 0 !important; /* Adjusted */
            border-top: 1px dashed black !important; /* Ensure dashed line */
            padding-top: 3mm !important; /* Adjusted */
        }
        #pdf-template-notice .reply-slip-body { 
            font-size: 11.5pt; margin-bottom: 1mm !important;
        }
        #pdf-template-notice .reply-slip-activity-name { 
            border-bottom: 0.5px solid black; font-weight:bold; text-align:center; 
            display:block; margin: 1.5mm auto !important; width: 75% !important;
        }
        #pdf-template-notice .reply-slip-school-right { 
            margin-top: 3mm !important; /* Adjusted */
            text-align:right; font-size: 11.5pt; 
        }
        #pdf-template-notice .reply-slip-details-grid { 
            display: grid !important; /* Ensure grid */
            grid-template-columns: auto 1fr !important; 
            gap: 1.5mm !important; margin-top: 2mm !important; /* Adjusted */
            font-size: 11.5pt;
        }
        #pdf-template-notice .reply-slip-details-grid > span { page-break-inside: avoid !important; padding-top: 0.5mm; padding-bottom: 0.5mm; }
        #pdf-template-notice .reply-slip-details-grid > span:nth-child(odd) { font-weight: normal; white-space:nowrap; }
        #pdf-template-notice .reply-slip-details-grid > span:nth-child(even) { border-bottom: 0.5px solid black; }
        #pdf-template-notice .reply-slip-details-grid div .class-no-span { border-bottom: 0.5px solid black; padding: 0 5mm; margin: 0 2mm;}

        /* === End of specific styles for #pdf-template-notice === */

        #pdf-template-e-notice .enotice-version {text-align:right; font-size: 8.5pt; margin-bottom: 2mm;}
        #pdf-template-e-notice .grid-container-enotice { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 1mm; margin-bottom: 3mm; font-size: 9.5pt;}
        #pdf-template-e-notice .grid-item-enotice-full { grid-column: 1 / -1; }
        #pdf-template-e-notice .enotice-section-a {font-size:10pt; margin-bottom: 1mm;}
        #pdf-template-e-notice .enotice-instruction { margin-bottom: 4mm; font-size: 8.5pt; padding-left: 3.5mm;}
        #pdf-template-e-notice .signature-grid-enotice { display: grid; grid-template-columns: 1fr 1fr; gap: 4mm 5mm; margin-top: 6mm; font-size: 9.5pt;}
        #pdf-template-e-notice .signature-grid-enotice div { margin-bottom: 1.2mm;}
        #pdf-template-e-notice .signature-grid-enotice .signature-line { width: 50%;}

        #pdf-template-external-org .grid-container-ext { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 1mm; margin-bottom: 2.5mm; font-size: 9.5pt;}
        #pdf-template-external-org .ext-data-source-label { margin-right: 1mm; font-weight: normal !important; }
        #pdf-template-external-org .ext-data-details { margin-top:1mm; padding:1mm; border:0.5px solid #ccc; min-height:8mm; font-size: 9.5pt; }
        #pdf-template-external-org .ext-signature-item { margin-bottom: 3mm; font-size: 9.5pt;}
        #pdf-template-external-org .ext-signature-item .signature-line { width: 50mm;}
        #pdf-template-external-org .ext-guidelines { margin-top: 4mm; font-size: 9pt;}
        #pdf-template-external-org .ext-guidelines ol { padding-left: 3.5mm; margin-top: 1mm;}
        #pdf-template-external-org .ext-guidelines li { margin-bottom: 0.7mm;}

        #pdf-template-slp-form .slp-top-container { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0;}
        #pdf-template-slp-form .slp-main-header { text-align:left; margin-bottom:0; font-size:13pt; } 
        #pdf-template-slp-form .slp-top-right { text-align:right; font-size:9pt; margin-top: 1mm;} 
        #pdf-template-slp-form .slp-sub-header { text-align:center; margin-top:0; margin-bottom:3.5mm; font-size: 10.5pt;} 
        #pdf-template-slp-form .slp-section-title { font-weight: bold; margin-top: 2.5mm; margin-bottom: 1.2mm; font-size: 9pt; } 
        #pdf-template-slp-form .slp-field { margin-bottom: 0.6mm; font-size: 8.5pt; display: flex; align-items: baseline;} 
        #pdf-template-slp-form .slp-field label { font-weight: bold; min-width: 25mm; display: inline-block; flex-shrink: 0; } 
        #pdf-template-slp-form .slp-field span { word-break: break-all; }
        #pdf-template-slp-form .slp-checkbox-group { display: flex; flex-wrap: wrap; gap: 0.7mm 1.8mm; margin-left: 0px; font-size: 8.5pt;}
        #pdf-template-slp-form .slp-checkbox-item { margin-right: 1mm; white-space: nowrap;}
        #pdf-template-slp-form .slp-value-scope-group { display:block; font-size: 8.5pt; column-count: 2; column-gap: 3mm; margin-top:0.6mm;}
        #pdf-template-slp-form .slp-value-scope-item { margin-bottom: 0.6mm; white-space: nowrap;}
        #pdf-template-slp-form .slp-student-table { margin-top: 1.8mm; font-size: 8pt;}
        #pdf-template-slp-form .slp-student-table th, #pdf-template-slp-form .slp-student-table td { padding: 0.7mm 1mm; border: 0.5px solid #333; text-align: center;}
        #pdf-template-slp-form .slp-student-table td:nth-child(1) {width: 5mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(2) {width: 11mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(3) {width: 11mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(4) { text-align: left; width: auto;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(5),td:nth-child(6),td:nth-child(7),td:nth-child(8) {width: 11mm;} 
        #pdf-template-slp-form .slp-notes { margin-top: 3.5mm; font-size: 8pt; } 
        #pdf-template-slp-form .slp-notes ol { padding-left: 2.5mm; margin-top: 0.6mm;} 
        #pdf-template-slp-form .slp-notes li { margin-bottom: 0.3mm;} 
        #pdf-template-slp-form .slp-signatures { margin-top: 4mm; display: flex; justify-content: space-between; font-size: 9.5pt;}
        #pdf-template-slp-form .slp-signature-item { min-width: 38mm; } 
        #pdf-template-slp-form .slp-signature-item .signature-line {width: 50%;}

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;}
        .loading-spinner { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay.hidden { display: none !important; }
        
        .temp-render-container-styles {
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            background: white !important; 
            color: black !important;
            /* display: block !important; /* This is now set dynamically in JS */
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.6em; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
            button, .file-input-label { font-size: 0.95em; padding: 10px 15px;}
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden"> <div class="loading-spinner"></div> </div>
    <div class="container">
        <h1>學生活動通告系統</h1>
        <div class="advanced-mode-toggle">
            <label for="advanced-mode-checkbox">進階模式</label>
            <label class="switch"> <input type="checkbox" id="advanced-mode-checkbox"> <span class="slider"></span> </label>
        </div>
        <form id="activity-form">
            <h2>活動基本資料</h2>
            <div class="form-grid">
                <div class="form-group"> <label for="responsible-dept">負責科/組/會社:</label> <input type="text" id="responsible-dept" name="responsible-dept"> </div>
                <div class="form-group"> <label for="activity-name">活動名稱:</label> <input type="text" id="activity-name" name="activity-name"> </div>
                <div class="form-group"> <label for="responsible-teacher">負責老師:</label> <input type="text" id="responsible-teacher" name="responsible-teacher"> </div>
                <div class="form-group"> <label for="responsible-teacher-position">負責老師職位:</label> <select id="responsible-teacher-position" name="responsible-teacher-position"> <option value="CM">CM</option> <option value="GM">GM</option> <option value="SGM">SGM</option> <option value="PGM">PGM</option> </select> </div>
                <div class="form-group"> <label for="leading-teacher">領隊老師 (樣式：陳小明):</label> <input type="text" id="leading-teacher" name="leading-teacher"> </div>
                <div class="form-group"> <label for="organizer">主辦/合作機構:</label> <input type="text" id="organizer" name="organizer"> </div>
                <div class="form-group"> <label for="activity-date">活動日期 (樣式：2023年9月1日):</label> <input type="date" id="activity-date" name="activity-date"> </div>
                <div class="form-group"> <label for="activity-time">活動時間 (樣式：上午9:00至下午5:00):</label> <input type="text" id="activity-time" name="activity-time"> </div>
                <div class="form-group"> <label for="activity-duration">活動時數 (樣式：8小時):</label> <input type="text" id="activity-duration" name="activity-duration"> </div>
                <div class="form-group"> <label for="assembly-time">集合時間 (樣式：上午9:00):</label> <input type="time" id="assembly-time" name="assembly-time"> </div>
                <div class="form-group"> <label for="dismissal-time">解散時間 (樣式：下午5:00):</label> <input type="time" id="dismissal-time" name="dismissal-time"> </div>
                <div class="form-group"> <label for="assembly-point">集合地點:</label> <input type="text" id="assembly-point" name="assembly-point"> </div>
                <div class="form-group"> <label for="dismissal-point">解散地點:</label> <input type="text" id="dismissal-point" name="dismissal-point"> </div>
                <div class="form-group"> <label for="activity-location">活動地點:</label> <input type="text" id="activity-location" name="activity-location"> </div>
                <div class="form-group"> <label for="affects-lessons">會否影響課堂:</label> <select id="affects-lessons" name="affects-lessons"> <option value="否">否</option> <option value="會">會</option> </select> </div>
                <div class="form-group"> <label for="activity-scope">活動範圍:</label> <select id="activity-scope" name="activity-scope"> <option value="校內">校內</option> <option value="校外">校外</option> </select> </div>
                <div class="form-group"> <label for="activity-scale">活動規模:</label> <select id="activity-scale" name="activity-scale"> <option value="會社及小組">會社及小組</option> <option value="班際">班際</option> <option value="級際">級際</option> <option value="全校">全校</option> <option value="校際">校際</option> <option value="區際">區際</option> <option value="全港">全港</option> <option value="全國">全國</option> <option value="世界性">世界性</option> <option value="其他">其他</option> </select> </div>
                <div class="form-group form-group-span-2"> <label>活動類別 (最多可選 3 項):</label> <div id="activity-category-checkboxes" class="checkbox-group"> <label><input type="checkbox" name="activity-category" value="活動"> 活動</label> <label><input type="checkbox" name="activity-category" value="服務"> 服務</label> <label><input type="checkbox" name="activity-category" value="比賽"> 比賽</label> <label><input type="checkbox" name="activity-category" value="獎學金"> 獎學金</label> <label><input type="checkbox" name="activity-category" value="外遊"> 外遊</label> <label><input type="checkbox" name="activity-category" value="其他"> 其他</label> </div> </div>
                <div class="form-group"> <label for="needs-slp">是否需要輸入SLP:</label> <select id="needs-slp" name="needs-slp"> <option value="需要">需要</option> <option value="不需要">不需要</option> </select> </div>
                <div class="form-group"> <label for="involves-external">會否涉及校外機構或人士:</label> <select id="involves-external" name="involves-external"> <option value="否">否</option> <option value="會">會</option> </select> </div>
            </div>
            <h2>通告相關資料</h2>
            <div class="form-grid">
                <div class="form-group"> <label for="notice-number">通告編號:</label> <input type="text" id="notice-number" name="notice-number"> </div>
                <div class="form-group"> <label for="notice-type">通告類別:</label> <select id="notice-type" name="notice-type"> <option value="無需收費通告">無需收費通告</option> <option value="需收費通告">需收費通告</option> </select> </div>
                <div class="form-group" id="activity-original-price-group"> <label for="activity-original-price">活動原價（$） (每位同學計，無需填寫"$"):</label> <input type="number" id="activity-original-price" name="activity-original-price" step="0.1"> </div>
                <div class="form-group"> <label for="notice-issue-date">擬發出通告日期:</label> <input type="date" id="notice-issue-date" name="notice-issue-date"> </div>
                <div class="form-group"> <label for="e-notice-end-date">結束電子通告日期:</label> <input type="date" id="e-notice-end-date" name="e-notice-end-date"> </div>
                <div class="form-group"> <label for="notice-target">通告對象:</label> <select id="notice-target" name="notice-target"> <option value="全校">全校</option> <option value="中一">中一</option> <option value="中二">中二</option> <option value="中三">中三</option> <option value="中四">中四</option> <option value="中五">中五</option> <option value="中六">中六</option> <option value="指定學生名單（請附名單）">指定學生名單（請附名單）</option> </select> </div>
                <div class="form-group"> <label for="needs-parent-options">是否需要提供家長選項:</label> <select id="needs-parent-options" name="needs-parent-options"> <option value="是">是</option> <option value="否">否</option> </select> </div>
                <div class="form-group" id="parent-options-group"> <label for="parent-options-content">請列出家長的選項內容:</label> <select id="parent-options-content" name="parent-options-content"> <option value="同意/不同意">同意/不同意</option> <option value="參加/不參加">參加/不參加</option> <option value="出席/不出席">出席/不出席</option> <option value="其他">其他</option> </select> <input type="text" id="parent-options-other" name="parent-options-other" placeholder="其他選項內容" class="hidden" style="margin-top:5px;"> </div>
                <div class="form-group"> <label for="notice-remarks">通告備註:</label> <textarea id="notice-remarks" name="notice-remarks"></textarea> </div>
                <div class="form-group"> <label for="external-org-data-source">外間組織/人士的資料提供方式:</label> <select id="external-org-data-source" name="external-org-data-source"> <option value="不適用">不適用 (如不涉及)</option> <option value="見附件">提供附件</option> <option value="見以下資料">於下方填寫</option> </select> </div>
                <div class="form-group form-group-span-2" id="external-org-details-group"> <label for="external-org-details">外間組織/人士的資料 (如選擇"於下方填寫"):</label> <textarea id="external-org-details" name="external-org-details"></textarea> </div>
            </div>
            <h3>全港性校際比賽 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid"> <label><input type="checkbox" name="inter-school-competition" value="國民教育"> 國民教育</label> <label><input type="checkbox" name="inter-school-competition" value="STEAM教育"> STEAM教育</label> <label><input type="checkbox" name="inter-school-competition" value="兩文三語"> 兩文三語</label> <label><input type="checkbox" name="inter-school-competition" value="體藝"> 體藝</label> <label><input type="checkbox" name="inter-school-competition" value="其他"> 其他 <input type="text" name="inter-school-competition-other" placeholder="請註明" style="width:150px; margin-left:5px;"></label> </div>
            <h3>活動包含價值教育 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid"> <label><input type="checkbox" name="value-education" value="堅毅"> 堅毅</label> <label><input type="checkbox" name="value-education" value="尊重他人"> 尊重他人</label> <label><input type="checkbox" name="value-education" value="責任感"> 責任感</label> <label><input type="checkbox" name="value-education" value="國民身份認同"> 國民身份認同</label> <label><input type="checkbox" name="value-education" value="承擔精神"> 承擔精神</label> <label><input type="checkbox" name="value-education" value="誠信"> 誠信</label> <label><input type="checkbox" name="value-education" value="關愛"> 關愛</label> <label><input type="checkbox" name="value-education" value="守法"> 守法</label> <label><input type="checkbox" name="value-education" value="同理心"> 同理心</label> <label><input type="checkbox" name="value-education" value="勤勞"> 勤勞</label> </div>
            <h3>價值相關學習範圍 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));"> <label><input type="checkbox" name="value-learning-scope" value="品德及倫理範疇"> 品德及倫理範疇</label> <label><input type="checkbox" name="value-learning-scope" value="公民教育"> 公民教育</label> <label><input type="checkbox" name="value-learning-scope" value="國民教育"> 國民教育</label> <label><input type="checkbox" name="value-learning-scope" value="《憲法》及《基本法》教育"> 《憲法》及《基本法》教育</label> <label><input type="checkbox" name="value-learning-scope" value="國家安全教育"> 國家安全教育</label> <label><input type="checkbox" name="value-learning-scope" value="禁毒教育"> 禁毒教育</label> <label><input type="checkbox" name="value-learning-scope" value="生命教育"> 生命教育</label> <label><input type="checkbox" name="value-learning-scope" value="性教育"> 性教育</label> <label><input type="checkbox" name="value-learning-scope" value="媒體及資訊素養教育"> 媒體及資訊素養教育</label> <label><input type="checkbox" name="value-learning-scope" value="可持續發展教育"> 可持續發展教育</label> <label><input type="checkbox" name="value-learning-scope" value="人權教育"> 人權教育</label> <label><input type="checkbox" name="value-learning-scope" value="誠信教育"> 誠信教育</label> <label><input type="checkbox" name="value-learning-scope" value="守法教育"> 守法教育</label> <label><input type="checkbox" name="value-learning-scope" value="健康生活教育"> 健康生活教育</label> <label><input type="checkbox" name="value-learning-scope" value="家庭生活教育"> 家庭生活教育</label> </div>
            <h3>出席學生名單及擔任角色 (如有)</h3>
            <table id="student-list-table" class="student-list-table">
                <thead> <tr> <th>序號</th> <th>班別</th> <th>學號</th> <th>姓名</th> <th>活動角色</th> <th>操作</th> </tr> </thead>
                <tbody id="student-list-tbody"></tbody>
            </table>
            <button type="button" id="add-student-row" class="secondary" style="margin-top:10px; font-size:0.9em; padding: 8px 12px;">新增學生</button>
            <div class="button-group">
                <button type="button" id="generate-pdf-main">下載 PDF</button>
                <button type="button" id="export-inputs-excel">匯出目前輸入 (Excel)</button>
                <label for="import-excel-input" class="file-input-label secondary">匯入已存輸入 (Excel)</label>
                <input type="file" id="import-excel-input" class="file-input-hidden" accept=".xlsx">
                <label for="attachments-input" class="file-input-label secondary">上載附件</label>
                <input type="file" id="attachments-input" class="file-input-hidden" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                <div id="attachment-names" style="font-size:0.9em; color:#555; width:100%; text-align:center; margin-top:5px;"></div>
                <button type="button" id="download-original-template" class="secondary hidden">下載原始Excel範本</button>
            </div>
        </form>
    </div>

    <div id="pdf-template-notice" class="pdf-page-render">
        <div style="position: relative; width: 100%; min-height: 20mm;"> 
            <img src="School logo.png" alt="School Logo" class="school-logo-img"/>
            <div class="notice-top-right-container">家長通告 <span id="pdf-notice-num-header"></span> 號</div>
        </div>
        <div class="notice-main-header header">佛 教 何 南 金 中 學</div>
        <div class="notice-sub-header sub-header">學 生 活 動 通 知 家 長 信(PL1)</div>
        
        <div class="notice-to">敬啟者：</div>
        <div class="notice-body"> 貴子弟已報名參加以下活動以裨益身心。是項活動由老師帶領，各學生務須服從指示，注意安全。出發前須留意可能影響活動進行的因素，如天氣、身體狀況及學校宣佈。如貴子弟因身體不適及過往病歷不適合運動或需特別照顧，務須於活動前知會負責老師。 </div>
        <div class="notice-body"> 至於貴子弟屆時是否參加，謹聽台端決定。學校籌辦活動所需資源不菲，同學應盡責出席，無故缺席以致未能完成有關活動，學校有可能要求同學補付原價全費。請將附函按時填覆，俾憑辦理，如有疑問，可致電 2340 0871 查詢。此致 </div>
        
        <div class="notice-closing-block">
            <div class="notice-date-principal-moved">
                <span>日期：<span id="pdf-notice-issue-date-moved" class="underline-value" style="min-width:50mm;"></span></span>
                <span class="principal-name" style="margin-left: auto;">馬寶紅校長：<span class="underline-value" style="min-width:35mm; margin-left:1mm;">&nbsp;</span></span>
            </div>
            <div class="notice-school-name-right">佛 教 何 南 金 中 學</div>
        </div>
        
        <hr style="border: none; border-top: 1px solid black; margin: 6mm 0;">
        
        <div class="activity-details-box">
            <div class="notice-details-header">貴 子 弟 報 名 參 加 之 活 動 情 況 如 下 :-</div>
            <div class="notice-details-grid">
                <span>活動名稱：</span><span id="pdf-activity-name"></span> 
                <span>負責老師：</span><span id="pdf-responsible-teacher-detail"></span>
                <span>舉行地點：</span><span id="pdf-activity-location"></span> 
                <span>舉行日期：</span><span id="pdf-activity-date"></span>
                <span>集合時間：</span><span id="pdf-assembly-time"></span> 
                <span>集合地點：</span><span id="pdf-assembly-point"></span>
                <span>解散時間：</span><span id="pdf-dismissal-time"></span> 
                <span>解散地點：</span><span id="pdf-dismissal-point"></span>
            </div>
            <div class="notice-remarks-container">
                <span class="label">備註：</span><span id="pdf-notice-remarks" class="value"></span>
            </div>
            <div class="notice-cost-info" id="pdf-notice-cost-info-container">
                {/* Content dynamically inserted by JavaScript */}
            </div>
        </div>
        
        <div class="notice-signatures-container">
            <div class="notice-school-stamp-area">學校蓋印: <div class="notice-school-stamp-box"></div></div>
            <div class="notice-teacher-signature-area">負責老師： <span id="pdf-responsible-teacher-sig" class="teacher-sig-line"></span></div>
        </div>

        <div class="reply-slip-section-wrapper"> <!-- Wrapper for the entire reply slip section -->
            <div class="reply-slip-header">學 生 活 動 家 長 回 條</div>
            <div class="reply-slip-body">敬覆者：領悉家長通告第 <span id="pdf-notice-num-reply" class="underline-value" style="min-width:20mm;">&nbsp;</span> 號文內各節，茲 <span id="pdf-parent-choice-action" class="underline-value" style="min-width:30mm;">&nbsp;</span> 敝子弟參加</div>
            <div id="pdf-activity-name-reply" class="reply-slip-activity-name"></div>
            <div class="reply-slip-body">活動，並會提醒其於進行活動時應遵守各安全規則。本人明白無故缺席以致未能完成有關活動，學校有可能要求同學補付原價全費。此覆</div>
            <div class="reply-slip-school-right">佛教何南金中學</div>
            <div class="reply-slip-details-grid">
                <span>學生姓名：</span><span></span>
                <span>學生班別及學號：</span>
                <div><span class="class-no-span">&nbsp;</span>班 <span class="class-no-span">&nbsp;</span>號</div>
                <span>家長 / 監護人簽署：</span><span></span>
                <span>家長 / 監護人姓名：</span><span></span>
                <span>家長 / 監護人電話：</span><span></span>
                <span>日期：</span><span></span>
            </div>
        </div>
    </div>

    <div id="pdf-template-e-notice" class="pdf-page-render">
        <div class="enotice-version">表格版本:20230821</div>
        <div class="header">佛教何南金中學</div>
        <div class="sub-header">電子通告申請書</div>
        <div class="grid-container-enotice" style="margin-bottom: 12px;">
            <label>通告編號</label><span id="pdf-en-notice-no"></span>
            <label>負責老師</label><span id="pdf-en-resp-teacher"></span>
            <label>所屬委員會 / 科目 / 組別</label><span id="pdf-en-dept"></span>
            <label>通告類別</label><span id="pdf-en-notice-type"></span>
        </div>
        <hr style="margin-bottom: 8px;">
        <p class="enotice-section-a"><span class="bold">甲部：</span> <span id="pdf-en-notice-type-detail" style="font-weight:bold;"></span></p>
        <p class="enotice-instruction">填妥後請連同通告文本及所有附件(包括紙本、檔案及學生名單(如有))交校務處張淑儀小姐。</p>
        <div class="grid-container-enotice">
            <label>電子通告標題</label><span id="pdf-en-title"></span>
            <label>擬發出通告日期</label><span id="pdf-en-issue-date"></span>
            <label>結束電子通告日期</label><span id="pdf-en-end-date"></span>
            <label>通告對象</label><span id="pdf-en-target"></span>
            <label class="grid-item-enotice-full">通告內容</label><span class="grid-item-enotice-full" style="font-weight:normal !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(見附件通告文本)</span>
            <label>是否需要提供家長選項</label><span id="pdf-en-parent-option-needed"></span>
            <label>請列出家長的選項內容</label><span id="pdf-en-parent-option-content"></span>
        </div>
        <div class="signature-grid-enotice" style="margin-top: 35px;">
            <div><span style="font-weight:bold;">發電子收費通告前</span></div> <div><span style="font-weight:bold;">發電子通告後</span></div>
            <div>擬通告負責老師簽署：<span class="signature-line"></span></div> <div>發還電子收費報告日期：<span class="signature-line"></span></div>
            <div>填寫電子通告申請表日期：<span class="signature-line"></span></div> <div>負責老師簽收報告：<span class="signature-line"></span></div>
            <div>設定通告同事簽署：<span class="signature-line"></span></div> <div></div>
            <div>檢查通告後老師簽署：<span class="signature-line"></span></div> <div></div>
        </div>
    </div>

    <div id="pdf-template-external-org" class="pdf-page-render">
        <div class="header">佛教何南金中學</div>
        <div class="sub-header">外間機構出外參觀/活動/講座/工作坊/教學申請</div>
        <div class="grid-container-ext">
            <label>會否涉及校外機構或人士</label><span id="pdf-ext-involved"></span>
            <label>外間團體</label><span id="pdf-ext-org-name"></span>
            <label>活動名稱</label><span id="pdf-ext-activity-name"></span>
            <label>活動地點</label><span id="pdf-ext-activity-date-location"></span>
            <label>校內負責人姓名</label><span id="pdf-ext-internal-resp-name"></span>
            <label>校內負責人職位</label><span id="pdf-ext-internal-resp-pos"></span>
            <label>所屬組別</label><span id="pdf-ext-dept"></span>
            <label>活動/講座/工作坊/教學日期</label><span id="pdf-ext-real-activity-date"></span>
        </div>
        <hr style="margin: 8px 0;">
        <p class="small-text" style="line-height:1.5; margin-bottom:8px;">本人為是次活動的負責人， 已閱「校內負責老師須知」及「外間組織/團體須知」， 並了解任何團體/人士曾經、正在或有機會作出違法行為皆不可進行活動/講座/工作坊/教學。</p>
        <div class="section">
            <p class="bold" style="font-size:11pt;">外間組織/人士的資料:</p>
            <div style="margin-left:10px; font-size:10pt; line-height:1.7;">
                <span id="pdf-ext-data-attachment-tick" class="ext-data-source-label"></span> 見附件&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;或<br>
                <span id="pdf-ext-data-below-tick" class="ext-data-source-label"></span> 見以下資料
                <div id="pdf-ext-data-details-content" class="ext-data-details"></div>
            </div>
        </div>
        <div class="signature-area ext-signature-item" style="margin-top:25px;">
            <div>校內負責同事姓名：<span id="pdf-ext-internal-colleague-name" style="border-bottom:1px solid black; padding: 0 15px;"></span></div>
            <div style="margin-top:20px;">校內負責同事簽名：<span class="signature-line" style="width:220px;"></span></div>
            <div style="margin-top:20px;">上級校長層同事簽名：<span class="signature-line" style="width:180px;"></span> (如不涉及外間機構無需簽名)</div>
            <div style="margin-top:20px;">日期：<span class="signature-line" style="width:220px;"></span></div>
        </div>
        <hr style="margin-top:15px;">
        <div class="ext-guidelines">
            <p class="bold" style="font-size:10pt;">校內負責老師須知</p>
            <ol>
                <li>查閱時間是否有空。</li>
                <li>最少兩星期前向校長提出。</li>
                <li>需了解該團體/地點之背景， 合乎香港法律， 任何團體/組織曾經、正在或有機會作出違法行為皆不可進行活動/講座/工作坊/教學。</li>
                <li>向學校提供該機構背景的書面資料</li>
                <li>需將「出外參觀/活動/講座/工作坊/教學申請」交回校務處， 並通知校務處。</li>
                <li>需安排同事當值， 活動、講座、工作坊期間須有校內老師在場。</li>
                <li>發Teams正式通知全體老師活動/講座/工作坊細節。</li>
            </ol>
        </div>
    </div>

    <div id="pdf-template-slp-form" class="pdf-page-render">
        <div class="slp-top-container">
             <div class="slp-main-header header">佛教何南金中學</div>
             <div class="slp-top-right"><span id="pdf-slp-needs-slp"></span></div>
        </div>
        <div class="slp-sub-header sub-header">活動記錄及學生學習概覽登記(活動前)</div>

        <div class="slp-section-title" style="margin-top: 5px;">A. 活動基本資料：</div>
        <div class="slp-field"><label>負責科/組/會社:</label><span id="pdf-slp-dept"></span></div>
        <div class="slp-field"><label>活動名稱:</label><span id="pdf-slp-activity-name"></span></div>
        <div class="slp-field"><label>負責老師:</label><span id="pdf-slp-resp-teacher"></span></div>
        <div class="slp-field"><label>活動隨隊老師:</label><span id="pdf-slp-leading-teacher"></span></div>
        <div class="slp-field"><label>主辦 /合作機構:</label><span id="pdf-slp-organizer"></span></div>
        <div class="slp-field"><label>活動日期:</label><span id="pdf-slp-activity-date"></span></div>
        <div class="slp-field"><label>活動時間:</label><span id="pdf-slp-activity-time"></span></div>
        <div class="slp-field"><label>活動時數:</label><span id="pdf-slp-activity-duration"></span></div>
        <div class="slp-field"><label>活動地點:</label><span id="pdf-slp-activity-location"></span></div>
        <div class="slp-field"><label>會否影響課堂:</label><span id="pdf-slp-affects-lessons"></span></div>
        <div class="slp-field"><label>活動範圍:</label><span id="pdf-slp-activity-scope"></span></div>
        <div class="slp-field"><label>活動規模:</label><span id="pdf-slp-activity-scale"></span></div>
        <div class="slp-field"><label>活動類別:</label><span id="pdf-slp-activity-categories"></span></div>

        <div class="slp-section-title">B. 全港性校際比賽：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-inter-school-comp" class="slp-checkbox-group"></div>

        <div class="slp-section-title">C. 活動包含價值教育：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-value-edu" class="slp-checkbox-group"></div>
        
        <div class="slp-section-title">D. 價值相關學習範圍：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-value-learning-scope" class="slp-value-scope-group"></div>

        <div class="slp-section-title">E. 出席學生名單及擔任角色</div>
        <table id="pdf-slp-student-list-table" class="slp-student-table">
            <thead><tr><th></th><th>班別</th><th>學號</th><th>姓名</th><th>主席</th><th>組長</th><th>參加者</th><th>其他<br>(請註明)</th></tr></thead>
            <tbody id="pdf-slp-student-list-tbody"></tbody>
        </table>

        <div class="slp-notes">
            <p class="bold" style="font-size:10pt;">負責老師注意事項：</p>
            <ol>
                <li>無論校內或校外舉辦活動，均須提交本表格</li>
                <li>活動前一星期填妥此表交校長批核</li>
                <li>已囑咐學生聯絡受影響科任老師交代課堂安排</li>
                <li>已發「學生活動通知家長信」及通知家長相關安排（如需要）</li>
                <li>通知警方備案(如需要)</li>
                <li>實體與電子版本的通告及本表格已交校務處MOON存檔記錄</li>
                <li>活動後，請提交下列電子版本文件：
                    <ul style="list-style-type: disc; margin-left:18px; margin-top:1px; margin-bottom:1px;">
                        <li>約10張具代表性的活動相片（必須提交）</li>
                        <li>活動後參加名單修正（如需要, 請填B表）</li>
                        <li>比賽獎項記錄表（如需要，請填B表），實體版本文件請交校長</li>
                    </ul>
                </li>
                <li>請為活動製作網頁，網頁內容交所屬科組助理協助製作</li>
                <li>傳訊組或會到活動中進行採訪或拍攝，但未必可以全程參與，故同事仍需為活動安排拍攝</li>
            </ol>
        </div>
        <div class="slp-signatures">
            <div class="slp-signature-item">負責老師簽署：<span class="signature-line"></span></div>
            <div class="slp-signature-item">校長簽署：<span class="signature-line"></span></div>
            <div class="slp-signature-item">日期：<span class="signature-line"></span></div>
        </div>
    </div>
    
    <script>
        const { jsPDF } = window.jspdf;
        let attachedFiles = [];
        
        let currentGlobalPdfY = 0; 
        let isFirstPageOfEntireDocumentGlobal = true;

        async function addCanvasToPdfWithSlicing(pdfInstance, canvasToAdd, startY, 
                                                isFirstPageOfDoc, marginX, marginYTop, 
                                                pagePrintableWidth, pagePrintableHeight) {
            let currentY = startY;
            let isCurrentlyFirstPageOfDoc = isFirstPageOfDoc;

            if (!canvasToAdd || canvasToAdd.width === 0 || canvasToAdd.height === 0) {
                console.warn("addCanvasToPdfWithSlicing called with an invalid or zero-dimension canvas. Skipping.", canvasToAdd);
                return { finalY: currentY, isDocStillFirstPage: isCurrentlyFirstPageOfDoc };
            }

            const masterCanvasWidth = canvasToAdd.width;
            const masterCanvasHeight = canvasToAdd.height;
            const sliceHeightInMasterCanvasPx = (pagePrintableHeight * masterCanvasWidth) / pagePrintableWidth;
            const numSlices = Math.max(1, Math.ceil(masterCanvasHeight / sliceHeightInMasterCanvasPx));

            for (let k = 0; k < numSlices; k++) {
                if (k > 0) { 
                    pdfInstance.addPage();
                    isCurrentlyFirstPageOfDoc = false;
                    currentY = marginYTop;
                } else if (isCurrentlyFirstPageOfDoc) {
                     currentY = marginYTop; 
                }
                
                const sy = k * sliceHeightInMasterCanvasPx; 
                const sHeightPx = Math.min(sliceHeightInMasterCanvasPx, masterCanvasHeight - sy); 

                const segmentCanvas = document.createElement('canvas');
                segmentCanvas.width = masterCanvasWidth;
                segmentCanvas.height = sHeightPx;
                const segmentCtx = segmentCanvas.getContext('2d');
                if (!segmentCtx) {
                     console.error("Failed to get 2D context for segment canvas");
                     continue; 
                }
                segmentCtx.drawImage(canvasToAdd, 0, sy, masterCanvasWidth, sHeightPx, 0, 0, masterCanvasWidth, sHeightPx);
                
                const segmentImgData = segmentCanvas.toDataURL('image/png', 1.0);
                const imageActualHeightInPdfMm = (sHeightPx * pagePrintableWidth) / masterCanvasWidth;

                if (currentY !== marginYTop && (currentY + imageActualHeightInPdfMm > marginYTop + pagePrintableHeight + 0.1)) { 
                    pdfInstance.addPage();
                    isCurrentlyFirstPageOfDoc = false;
                    currentY = marginYTop;
                }
                
                pdfInstance.addImage(segmentImgData, 'PNG', marginX, currentY, pagePrintableWidth, imageActualHeightInPdfMm, undefined, 'FAST');
                currentY += imageActualHeightInPdfMm;
                isCurrentlyFirstPageOfDoc = false; 
            }
            return { finalY: currentY, isDocStillFirstPage: isCurrentlyFirstPageOfDoc };
        }


        document.addEventListener('DOMContentLoaded', function() {
            const advancedModeCheckbox = document.getElementById('advanced-mode-checkbox');
            const downloadOriginalTemplateBtn = document.getElementById('download-original-template');
            const activityOriginalPriceGroup = document.getElementById('activity-original-price-group');
            const noticeTypeSelect = document.getElementById('notice-type');
            const parentOptionsGroup = document.getElementById('parent-options-group');
            const needsParentOptionsSelect = document.getElementById('needs-parent-options');
            const parentOptionsContentSelect = document.getElementById('parent-options-content');
            const parentOptionsOtherInput = document.getElementById('parent-options-other');
            const externalOrgDataSourceSelect = document.getElementById('external-org-data-source');
            const externalOrgDetailsGroup = document.getElementById('external-org-details-group');
            const attachmentsInput = document.getElementById('attachments-input');
            const attachmentNamesDiv = document.getElementById('attachment-names');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            function showLoader() { if(loadingOverlay) loadingOverlay.classList.remove('hidden'); }
            function hideLoader() { if(loadingOverlay) loadingOverlay.classList.add('hidden'); }

            function toggleAdvancedMode() {
                const isAdvanced = advancedModeCheckbox.checked;
                downloadOriginalTemplateBtn.classList.toggle('hidden', !isAdvanced);
                if (isAdvanced) { activityOriginalPriceGroup.classList.remove('hidden'); } 
                else { toggleOriginalPriceVisibility(); }
            }

            function toggleOriginalPriceVisibility() {
                if (!advancedModeCheckbox.checked) {
                     activityOriginalPriceGroup.classList.toggle('hidden', noticeTypeSelect.value === '無需收費通告');
                }
            }
            
            function toggleParentOptionsVisibility() {
                const needsOptions = needsParentOptionsSelect.value === '是';
                parentOptionsGroup.classList.toggle('hidden', !needsOptions);
                if (!needsOptions) { parentOptionsOtherInput.classList.add('hidden'); } 
                else { toggleParentOptionsOtherVisibility(); }
            }

            function toggleParentOptionsOtherVisibility() {
                if (needsParentOptionsSelect.value === '是') {
                    parentOptionsOtherInput.classList.toggle('hidden', parentOptionsContentSelect.value !== '其他');
                }
            }
            
            function toggleExternalOrgDetailsVisibility() {
                externalOrgDetailsGroup.classList.toggle('hidden', externalOrgDataSourceSelect.value !== '見以下資料');
            }

            advancedModeCheckbox.addEventListener('change', toggleAdvancedMode);
            noticeTypeSelect.addEventListener('change', toggleOriginalPriceVisibility);
            needsParentOptionsSelect.addEventListener('change', toggleParentOptionsVisibility);
            parentOptionsContentSelect.addEventListener('change', toggleParentOptionsOtherVisibility);
            externalOrgDataSourceSelect.addEventListener('change', toggleExternalOrgDetailsVisibility);

            const studentListTbody = document.getElementById('student-list-tbody');
            const addStudentRowBtn = document.getElementById('add-student-row');
            let studentCounter = 0;

            function addStudentRow() {
                studentCounter++;
                const row = studentListTbody.insertRow();
                row.innerHTML = `
                    <td>${studentCounter}</td>
                    <td><input type="text" name="student-class-${studentCounter}" class="student-class"></td>
                    <td><input type="text" name="student-id-${studentCounter}" class="student-id"></td>
                    <td><input type="text" name="student-name-${studentCounter}" class="student-name"></td>
                    <td>
                        <select name="student-role-${studentCounter}" class="student-role">
                            <option value="參加者">參加者</option> <option value="主席">主席</option> <option value="組長">組長</option> <option value="其他">其他</option>
                        </select>
                        <input type="text" name="student-role-other-${studentCounter}" class="student-role-other" placeholder="請註明其他角色" style="display:none; margin-top:3px;">
                    </td>
                    <td><button type="button" class="remove-student-row">移除</button></td>
                `;
                const roleSelect = row.querySelector('.student-role');
                const roleOtherInput = row.querySelector('.student-role-other');
                roleSelect.addEventListener('change', function() { roleOtherInput.style.display = this.value === '其他' ? 'block' : 'none'; });
                row.querySelector('.remove-student-row').addEventListener('click', function() { this.closest('tr').remove(); });
            }
            addStudentRowBtn.addEventListener('click', addStudentRow);
            addStudentRow(); 

            const activityCategoryCheckboxes = document.querySelectorAll('#activity-category-checkboxes input[type="checkbox"]');
            activityCategoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = Array.from(activityCategoryCheckboxes).filter(cb => cb.checked).length;
                    if (checkedCount > 3) { this.checked = false; alert('活動類別最多只可選 3 項。'); }
                });
            });
            
            attachmentsInput.addEventListener('change', function(event) {
                attachedFiles = Array.from(event.target.files);
                attachmentNamesDiv.innerHTML = attachedFiles.length > 0 ? '已選附件：' + attachedFiles.map(f => f.name).join(', ') : '';
            });

            toggleOriginalPriceVisibility(); toggleParentOptionsVisibility(); toggleExternalOrgDetailsVisibility(); toggleAdvancedMode(); 

            async function generatePdf() {
                showLoader();
                await new Promise(resolve => setTimeout(resolve, 100)); 

                const pdf = new jsPDF('p', 'mm', 'a4');
                const PDF_MARGIN_X_MM = 8;
                const PDF_MARGIN_Y_TOP_MM = 8;
                const PDF_MARGIN_Y_BOTTOM_MM = 8;
                const pdfPageWidth = pdf.internal.pageSize.getWidth();
                const pdfPageHeight = pdf.internal.pageSize.getHeight();
                const printablePdfWidth = pdfPageWidth - (PDF_MARGIN_X_MM * 2);
                const printablePdfHeight = pdfPageHeight - PDF_MARGIN_Y_TOP_MM - PDF_MARGIN_Y_BOTTOM_MM;

                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM; 
                isFirstPageOfEntireDocumentGlobal = true;  

                const pdfTemplates = [
                    { id: 'pdf-template-notice', populateFunc: populateNoticeTemplate }, 
                    { id: 'pdf-template-e-notice', populateFunc: populateENoticeTemplate },
                    { id: 'pdf-template-external-org', populateFunc: populateExternalOrgTemplate }, 
                    { id: 'pdf-template-slp-form', populateFunc: populateSlpFormTemplate }
                ];

                try {
                    for (let templateIndex = 0; templateIndex < pdfTemplates.length; templateIndex++) {
                        const template = pdfTemplates[templateIndex];
                        template.populateFunc();
                        const element = document.getElementById(template.id);
                        if (!element) { console.error(`PDF template element with ID '${template.id}' not found.`); continue; }

                        if (template.id === 'pdf-template-notice') {
                            const noticeElement = element;
                            const replySlipWrapper = noticeElement.querySelector('.reply-slip-section-wrapper');
                            if (!replySlipWrapper) {
                                console.error("Reply slip wrapper not found in notice template!");
                                throw new Error("Reply slip wrapper not found.");
                            }
                            
                            const prevDisplayNotice = noticeElement.style.display;
                            noticeElement.style.display = 'block'; 
                            const noticeElementWidthForOffscreenRendering = noticeElement.offsetWidth;
                            const computedNoticeStyle = window.getComputedStyle(noticeElement);
                            noticeElement.style.display = prevDisplayNotice; 

                            const originalWrapperDisplay = replySlipWrapper.style.display; 
                            replySlipWrapper.style.display = 'none'; 
                            noticeElement.style.display = 'block'; 
                            noticeElement.style.height = 'auto';
                            noticeElement.style.overflow = 'visible';

                            const mainCanvas = await html2canvas(noticeElement, { scale: 3, useCORS: true, logging: false, imageTimeout: 5000, removeContainer: false, height: noticeElement.scrollHeight, windowHeight: noticeElement.scrollHeight });
                            
                            if (mainCanvas.width === 0 || mainCanvas.height === 0) {
                                console.error("Main canvas for noticeElement has zero dimensions!", noticeElement);
                                replySlipWrapper.style.display = originalWrapperDisplay; 
                                noticeElement.style.display = 'none'; 
                                throw new Error("Main canvas rendered with zero dimensions for notice template.");
                            }
                            
                            noticeElement.style.display = 'none'; 
                            
                            let mainRenderState = await addCanvasToPdfWithSlicing(pdf, mainCanvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = mainRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = mainRenderState.isDocStillFirstPage;
                            
                            const tempOriginalNoticeDisplay_forClone = noticeElement.style.display; 
                            const tempOriginalWrapperDisplay_forClone = replySlipWrapper.style.display;

                            noticeElement.style.display = 'block';    
                            replySlipWrapper.style.display = 'block'; 
                            await new Promise(resolve => requestAnimationFrame(resolve)); 

                            const replySlipCloneForRender = replySlipWrapper.cloneNode(true);

                            replySlipWrapper.style.display = tempOriginalWrapperDisplay_forClone; 
                            noticeElement.style.display = tempOriginalNoticeDisplay_forClone;   


                            const tempRenderContainer = document.createElement('div');
                            tempRenderContainer.className = 'temp-render-container-styles'; 
                            tempRenderContainer.style.display = 'block'; 
                            tempRenderContainer.id = 'pdf-template-notice'; 

                            tempRenderContainer.style.width = noticeElementWidthForOffscreenRendering > 0 ? noticeElementWidthForOffscreenRendering + 'px' : (printablePdfWidth / 25.4 * 96) + 'px';
                            tempRenderContainer.style.fontFamily = computedNoticeStyle.fontFamily;
                            tempRenderContainer.style.fontSize = computedNoticeStyle.fontSize;
                            tempRenderContainer.style.lineHeight = computedNoticeStyle.lineHeight;
                            tempRenderContainer.style.padding = computedNoticeStyle.padding; 
                            tempRenderContainer.style.boxSizing = computedNoticeStyle.boxSizing;
                            tempRenderContainer.style.background = 'white'; 
                            
                            replySlipCloneForRender.style.display = 'block'; 
                            replySlipCloneForRender.style.width = '100%';    
                            replySlipCloneForRender.style.height = 'auto';
                            replySlipCloneForRender.style.overflow = 'visible';

                            tempRenderContainer.appendChild(replySlipCloneForRender);
                            document.body.appendChild(tempRenderContainer);
                            
                            const replyCanvas = await new Promise((resolve, reject) => {
                                requestAnimationFrame(() => { 
                                    requestAnimationFrame(async () => { 
                                        try {
                                            const cloneWidth = replySlipCloneForRender.offsetWidth;
                                            const cloneHeight = replySlipCloneForRender.scrollHeight;
                                            if (cloneWidth === 0 || cloneHeight === 0) {
                                                console.warn(`Reply slip clone has zero dimensions before html2canvas. Width: ${cloneWidth}, Height: ${cloneHeight}. Inspect tempRenderContainer and clone.`, tempRenderContainer, replySlipCloneForRender);
                                                const errorCanvas = document.createElement('canvas'); errorCanvas.width = 1; errorCanvas.height = 1; 
                                                resolve(errorCanvas); 
                                                return;
                                            }
                                            const canvas = await html2canvas(replySlipCloneForRender, {
                                                scale: 3, useCORS: true, logging: false, imageTimeout: 5000,
                                                height: cloneHeight, width: cloneWidth,
                                                windowWidth: replySlipCloneForRender.scrollWidth, windowHeight: cloneHeight
                                            });
                                            resolve(canvas);
                                        } catch (e) {
                                            console.error("Error during html2canvas for reply slip:", e);
                                            reject(e);
                                        }
                                    });
                                });
                            });
                            
                            tempRenderContainer.id = ''; 
                            document.body.removeChild(tempRenderContainer);
                            replySlipWrapper.style.display = originalWrapperDisplay; 

                            if (replyCanvas.width <= 1 && replyCanvas.height <= 1) { 
                                console.error("Reply canvas has effectively zero/minimal dimensions AFTER requestAnimationFrame! PDF part might be missing or tiny.");
                            }

                            const replyHeightInPdfMm = (replyCanvas.height * printablePdfWidth) / replyCanvas.width;
                            let spaceLeftOnCurrentPageMm = printablePdfHeight - (currentGlobalPdfY - PDF_MARGIN_Y_TOP_MM);

                            if (currentGlobalPdfY <= PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                spaceLeftOnCurrentPageMm = printablePdfHeight;
                            }
                            
                            if (replyCanvas.width > 1 && replyCanvas.height > 1 && 
                                replyHeightInPdfMm > spaceLeftOnCurrentPageMm + 0.1 && 
                                currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                pdf.addPage();
                                isFirstPageOfEntireDocumentGlobal = false;
                                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM; 
                            }
                            
                            let replyRenderState = await addCanvasToPdfWithSlicing(pdf, replyCanvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = replyRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = replyRenderState.isDocStillFirstPage;

                        } else { 
                            element.style.display = 'block';
                            element.style.height = 'auto';
                            element.style.overflow = 'visible';
                            const canvas = await html2canvas(element, { scale: 3, useCORS: true, logging: false, imageTimeout: 5000, removeContainer: true, height: element.scrollHeight, windowHeight: element.scrollHeight });
                            
                            if (canvas.width === 0 || canvas.height === 0) {
                                console.error(`Canvas for template ${template.id} has zero dimensions!`, element);
                                element.style.display = 'none';
                                throw new Error(`Canvas for ${template.id} rendered with zero dimensions.`);
                            }
                            element.style.display = 'none';
                            
                            let standardRenderState = await addCanvasToPdfWithSlicing(pdf, canvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = standardRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = standardRenderState.isDocStillFirstPage;
                        }

                        if (template.id === 'pdf-template-notice' && templateIndex < pdfTemplates.length - 1) {
                            if (currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1 || (currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM && !isFirstPageOfEntireDocumentGlobal) ) { 
                                pdf.addPage();
                                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                isFirstPageOfEntireDocumentGlobal = false; 
                            }
                        }
                    } 


                    for (const file of attachedFiles) {
                        const textLineHeightMm = 7; 
                        const spaceForAttachmentHeader = textLineHeightMm * 2;

                        if (currentGlobalPdfY !== PDF_MARGIN_Y_TOP_MM && (currentGlobalPdfY + spaceForAttachmentHeader > PDF_MARGIN_Y_TOP_MM + printablePdfHeight) ) { 
                             pdf.addPage(); isFirstPageOfEntireDocumentGlobal = false; currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                        } else if (isFirstPageOfEntireDocumentGlobal && currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM) {
                        } else if (!isFirstPageOfEntireDocumentGlobal && currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM){
                        }


                        pdf.setFontSize(12); let fileTypeDescription = "其他附件";
                        if (file.type.startsWith('image/')) fileTypeDescription = "圖像附件";
                        else if (file.type === 'application/pdf') fileTypeDescription = "PDF附件";
                        else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || file.name.toLowerCase().endsWith('.doc') || file.name.toLowerCase().endsWith('.docx')) fileTypeDescription = "Word文件附件";
                        else if (file.type === 'application/vnd.ms-excel' || file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx')) fileTypeDescription = "Excel文件附件";
                        
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            await new Promise((resolve, reject) => {
                                reader.onload = function(e) {
                                    try {
                                        if (!isFirstPageOfEntireDocumentGlobal || currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                            pdf.addPage(); currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                        }
                                        isFirstPageOfEntireDocumentGlobal = false;

                                        const imgProps = pdf.getImageProperties(e.target.result);
                                        const imgRatio = imgProps.width / imgProps.height;
                                        let imgWidth = printablePdfWidth;
                                        let imgHeight = imgWidth / imgRatio;
                                        if (imgHeight > printablePdfHeight) {
                                            imgHeight = printablePdfHeight;
                                            imgWidth = imgHeight * imgRatio;
                                        }
                                        const x = PDF_MARGIN_X_MM + (printablePdfWidth - imgWidth) / 2;
                                        const y = PDF_MARGIN_Y_TOP_MM + (printablePdfHeight - imgHeight) / 2; 
                                        pdf.addImage(e.target.result, file.type.split('/')[1].toUpperCase(), x, y, imgWidth, imgHeight);
                                        currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM + printablePdfHeight; 
                                        resolve();
                                    } catch (error) { reject(error); }
                                };
                                reader.onerror = reject; reader.readAsDataURL(file);
                            });
                        } else { 
                            pdf.text(`${fileTypeDescription}: ${file.name}`, PDF_MARGIN_X_MM, currentGlobalPdfY);
                            currentGlobalPdfY += textLineHeightMm; 
                            if (currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + printablePdfHeight) { 
                                pdf.addPage(); isFirstPageOfEntireDocumentGlobal = false; currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                 pdf.text(`${fileTypeDescription}: ${file.name}`, PDF_MARGIN_X_MM, currentGlobalPdfY); 
                                 currentGlobalPdfY += textLineHeightMm;
                            }
                            pdf.text("此類附件將不會在PDF中直接顯示。", PDF_MARGIN_X_MM, currentGlobalPdfY);
                            currentGlobalPdfY += textLineHeightMm;
                            isFirstPageOfEntireDocumentGlobal = false;
                        }
                    }
                    pdf.save('學生活動通告_綜合.pdf');
                } catch (error) {
                    console.error("生成PDF時發生錯誤:", error);
                    alert("生成PDF時發生錯誤，請檢查瀏覽器控制台以獲取更多資訊。\n" + (error.message || error));
                } finally { 
                    pdfTemplates.forEach(template => {
                        const el = document.getElementById(template.id);
                        if (el) { el.style.display = 'none'; } 
                    });
                    hideLoader(); 
                }
            }

            document.getElementById('generate-pdf-main').addEventListener('click', () => generatePdf());
            
            function getFormValue(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
            function getFormDate(id) { 
                const val = getFormValue(id); if (!val) return '';
                try { const date = new Date(val); if (isNaN(date.getTime())) return ''; return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`; } catch (e) { return ''; }
            }
            function getFormTime(id) {
                const val = getFormValue(id); if (!val) return '';
                const [hours, minutes] = val.split(':'); if (hours === undefined || minutes === undefined) return '';
                const H = parseInt(hours); if (isNaN(H)) return '';
                const ampm = H >= 12 ? '下午' : '上午'; const displayH = H % 12 || 12;
                return `${ampm}${displayH}:${minutes.padStart(2, '0')}`;
            }

            function setElementText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text || ''; }
            function setElementHtml(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html || ''; }

            function populateNoticeTemplate() {
                setElementText('pdf-notice-num-header', getFormValue('notice-number'));
                setElementText('pdf-notice-issue-date-moved', getFormDate('notice-issue-date') || ' ');
                setElementText('pdf-activity-name', getFormValue('activity-name')|| ' ');
                setElementText('pdf-responsible-teacher-detail', getFormValue('responsible-teacher')|| ' ');
                setElementText('pdf-activity-location', getFormValue('activity-location')|| ' ');
                setElementText('pdf-activity-date', getFormDate('activity-date')|| ' ');
                setElementText('pdf-assembly-time', getFormTime('assembly-time')|| ' ');
                setElementText('pdf-assembly-point', getFormValue('assembly-point')|| ' ');
                setElementText('pdf-dismissal-time', getFormTime('dismissal-time')|| ' ');
                setElementText('pdf-dismissal-point', getFormValue('dismissal-point')|| ' ');
                setElementText('pdf-notice-remarks', getFormValue('notice-remarks') || ' '); 
                
                const originalPrice = getFormValue('activity-original-price') || '0'; 
                const numPrice = parseFloat(originalPrice);
                const formattedPrice = numPrice % 1 === 0 ? numPrice.toFixed(0) : numPrice.toFixed(1);
                
                const costInfoEl = document.getElementById('pdf-notice-cost-info-container');
                if (costInfoEl) {
                    if (getFormValue('notice-type') === '無需收費通告') { 
                        costInfoEl.innerHTML = `是項活動原價全費為 $${formattedPrice}，經學校及其他津貼現無需收取費用。`; 
                    } else { 
                        costInfoEl.innerHTML = `是項活動費用為每位港幣 $${formattedPrice}，經學校及其他津貼現無需收取費用。`; 
                    }
                }
                setElementText('pdf-responsible-teacher-sig', getFormValue('responsible-teacher')|| ' ');
                setElementText('pdf-notice-num-reply', getFormValue('notice-number') ? getFormValue('notice-number') : " ");
                setElementText('pdf-activity-name-reply', getFormValue('activity-name') || " ");
                let parentChoice = "批准 / 不批准";
                if (getFormValue('needs-parent-options') === '是') {
                    const optionContent = getFormValue('parent-options-content');
                    if (optionContent === '其他') { parentChoice = getFormValue('parent-options-other') || " "; } 
                    else { parentChoice = optionContent; }
                }
                setElementText('pdf-parent-choice-action', parentChoice);
            }

            function populateENoticeTemplate() {
                setElementText('pdf-en-notice-no', getFormValue('notice-number'));
                setElementText('pdf-en-resp-teacher', getFormValue('responsible-teacher'));
                setElementText('pdf-en-dept', getFormValue('responsible-dept'));
                setElementText('pdf-en-notice-type', getFormValue('notice-type'));
                setElementText('pdf-en-notice-type-detail', getFormValue('notice-type'));
                setElementText('pdf-en-title', getFormValue('activity-name'));
                setElementText('pdf-en-issue-date', getFormDate('notice-issue-date'));
                setElementText('pdf-en-end-date', getFormDate('e-notice-end-date'));
                setElementText('pdf-en-target', getFormValue('notice-target'));
                setElementText('pdf-en-parent-option-needed', getFormValue('needs-parent-options'));
                let parentOptContent = getFormValue('parent-options-content');
                if(parentOptContent === '其他') parentOptContent = getFormValue('parent-options-other');
                setElementText('pdf-en-parent-option-content', getFormValue('needs-parent-options') === '是' ? parentOptContent : '不適用');
            }

            function populateExternalOrgTemplate() {
                setElementText('pdf-ext-involved', getFormValue('involves-external'));
                setElementText('pdf-ext-org-name', getFormValue('involves-external') === '會' ? getFormValue('organizer') : '不適用');
                setElementText('pdf-ext-activity-name', getFormValue('activity-name'));
                setElementText('pdf-ext-activity-date-location', getFormValue('activity-location')); 
                setElementText('pdf-ext-real-activity-date', getFormDate('activity-date')); 
                setElementText('pdf-ext-internal-resp-name', getFormValue('responsible-teacher'));
                setElementText('pdf-ext-internal-resp-pos', getFormValue('responsible-teacher-position'));
                setElementText('pdf-ext-dept', getFormValue('responsible-dept'));
                setElementText('pdf-ext-internal-colleague-name', getFormValue('responsible-teacher'));
                const dataSource = getFormValue('external-org-data-source');
                const detailsContentEl = document.getElementById('pdf-ext-data-details-content');
                setElementText('pdf-ext-data-attachment-tick', dataSource === '見附件' ? '✓' : '\u00A0\u00A0');
                setElementText('pdf-ext-data-below-tick', dataSource === '見以下資料' ? '✓' : '\u00A0\u00A0');
                if (detailsContentEl) {
                    if (dataSource === '見以下資料') { detailsContentEl.innerText = getFormValue('external-org-details'); detailsContentEl.style.display = 'block'; } 
                    else { detailsContentEl.innerText = ''; detailsContentEl.style.display = 'none'; }
                }
            }

            function populateSlpFormTemplate() {
                setElementText('pdf-slp-needs-slp', getFormValue('needs-slp') + " 輸入SLP");
                setElementText('pdf-slp-dept', getFormValue('responsible-dept'));
                setElementText('pdf-slp-activity-name', getFormValue('activity-name'));
                setElementText('pdf-slp-resp-teacher', getFormValue('responsible-teacher'));
                setElementText('pdf-slp-leading-teacher', getFormValue('leading-teacher'));
                setElementText('pdf-slp-organizer', getFormValue('organizer'));
                setElementText('pdf-slp-activity-date', getFormDate('activity-date'));
                setElementText('pdf-slp-activity-time', getFormValue('activity-time'));
                setElementText('pdf-slp-activity-duration', getFormValue('activity-duration'));
                setElementText('pdf-slp-activity-location', getFormValue('activity-location'));
                setElementText('pdf-slp-affects-lessons', getFormValue('affects-lessons'));
                setElementText('pdf-slp-activity-scope', getFormValue('activity-scope'));
                setElementText('pdf-slp-activity-scale', getFormValue('activity-scale'));
                const activityCategories = Array.from(document.querySelectorAll('input[name="activity-category"]:checked')).map(cb => cb.value).join(', ');
                setElementText('pdf-slp-activity-categories', activityCategories);

                const interSchoolCompOrder = ["國民教育", "STEAM教育", "兩文三語", "體藝", "其他"];
                let compHtml = '';
                interSchoolCompOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="inter-school-competition"][value="${val}"]`);
                    if (cb) {
                        compHtml += `<span class="slp-checkbox-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}`;
                        if (val === "其他" && cb.checked) { const otherText = document.querySelector('input[name="inter-school-competition-other"]').value; compHtml += ` (${otherText || '未註明'})`; }
                        else if (val === "其他" && !cb.checked) { const otherText = document.querySelector('input[name="inter-school-competition-other"]').value; if(otherText) compHtml += ` (${otherText})` }
                        compHtml += `</span>`;
                    }
                });
                setElementHtml('pdf-slp-inter-school-comp', compHtml || '無');

                let valueEduHtml = '';
                const valueEduOrder = ["堅毅", "尊重他人", "責任感", "國民身份認同", "承擔精神", "誠信", "關愛", "守法", "同理心", "勤勞"];
                valueEduOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="value-education"][value="${val}"]`);
                    if (cb) { valueEduHtml += `<span class="slp-checkbox-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}</span>`; }
                });
                setElementHtml('pdf-slp-value-edu', valueEduHtml || '無');
                
                let valueLearnHtml = '';
                const valueLearnOrder = [ "品德及倫理範疇", "公民教育", "國民教育", "《憲法》及《基本法》教育", "國家安全教育", "禁毒教育", "生命教育", "性教育", "媒體及資訊素養教育", "可持續發展教育", "人權教育", "誠信教育", "守法教育", "健康生活教育", "家庭生活教育"];
                valueLearnOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="value-learning-scope"][value="${val}"]`);
                    if (cb) { valueLearnHtml += `<div class="slp-value-scope-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}</div>`;}
                });
                setElementHtml('pdf-slp-value-learning-scope', valueLearnHtml || '無');

                const slpStudentTbody = document.getElementById('pdf-slp-student-list-tbody');
                if (slpStudentTbody) slpStudentTbody.innerHTML = ''; 
                const studentRows = studentListTbody.querySelectorAll('tr');
                studentRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('input, select');
                    const studentClass = cells[0].value; const studentId = cells[1].value; const studentName = cells[2].value;
                    const roleSelect = cells[3]; const roleOtherInput = cells[4];
                    let roleChairman = '', roleLeader = '', roleParticipant = '', roleOtherText = '';
                    if (roleSelect.value === '主席') roleChairman = '✓'; else if (roleSelect.value === '組長') roleLeader = '✓';
                    else if (roleSelect.value === '參加者') roleParticipant = '✓'; else if (roleSelect.value === '其他') roleOtherText = roleOtherInput.value || '✓';
                    if (slpStudentTbody) {
                        const slpRow = slpStudentTbody.insertRow();
                        slpRow.innerHTML = `<td>${index + 1}.</td><td>${studentClass}</td><td>${studentId}</td><td>${studentName}</td><td>${roleChairman}</td><td>${roleLeader}</td><td>${roleParticipant}</td><td>${roleOtherText}</td>`;
                    }
                });
                if (slpStudentTbody && studentRows.length < 10) {
                    for (let i = studentRows.length + 1; i <= 10; i++) {
                        const emptyRow = slpStudentTbody.insertRow();
                        emptyRow.innerHTML = `<td>${i}.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
                    }
                }
            }
            
            document.getElementById('export-inputs-excel').addEventListener('click', function() {
                const data = [ ["欄位", "內容"], ["負責科/組/會社", getFormValue('responsible-dept')], ["活動名稱", getFormValue('activity-name')], ["負責老師", getFormValue('responsible-teacher')], ["負責老師職位", getFormValue('responsible-teacher-position')], ["領隊老師", getFormValue('leading-teacher')], ["主辦/合作機構", getFormValue('organizer')], ["活動日期", getFormValue('activity-date')], ["活動時間", getFormValue('activity-time')], ["活動時數", getFormValue('activity-duration')], ["集合時間", getFormValue('assembly-time')], ["解散時間", getFormValue('dismissal-time')], ["集合地點", getFormValue('assembly-point')], ["解散地點", getFormValue('dismissal-point')], ["活動地點", getFormValue('activity-location')], ["會否影響課堂", getFormValue('affects-lessons')], ["活動範圍", getFormValue('activity-scope')], ["活動規模", getFormValue('activity-scale')], ["活動類別1", document.querySelectorAll('input[name="activity-category"]:checked')[0]?.value || ''], ["活動類別2", document.querySelectorAll('input[name="activity-category"]:checked')[1]?.value || ''], ["活動類別3", document.querySelectorAll('input[name="activity-category"]:checked')[2]?.value || ''], ["是否需要輸入SLP", getFormValue('needs-slp')], ["會否涉及校外機構或人士", getFormValue('involves-external')], ["通告編號", getFormValue('notice-number')], ["通告類別", getFormValue('notice-type')], ["活動原價（$）", getFormValue('activity-original-price')], ["擬發出通告日期", getFormValue('notice-issue-date')], ["結束電子通告日期", getFormValue('e-notice-end-date')], ["通告對象", getFormValue('notice-target')], ["是否需要提供家長選項", getFormValue('needs-parent-options')], ["家長的選項內容", getFormValue('parent-options-content')], ["家長選項其他", getFormValue('parent-options-other')], ["通告備註", getFormValue('notice-remarks')], ["外間組織/人士的資料提供方式", getFormValue('external-org-data-source')], ["外間組織/人士的資料", getFormValue('external-org-details')],];
                const interSchoolComp = []; document.querySelectorAll('input[name="inter-school-competition"]').forEach(cb => { if (cb.type === 'checkbox') interSchoolComp.push(`${cb.value}:${cb.checked}`); else if (cb.type === 'text') interSchoolComp.push(`other_text:${cb.value}`); });
                data.push(["全港性校際比賽", interSchoolComp.join(',')]);
                const valueEducation = Array.from(document.querySelectorAll('input[name="value-education"]:checked')).map(cb => cb.value).join(','); data.push(["活動包含價值教育", valueEducation]);
                const valueLearningScope = Array.from(document.querySelectorAll('input[name="value-learning-scope"]:checked')).map(cb => cb.value).join(','); data.push(["價值相關學習範圍", valueLearningScope]);
                const students = []; studentListTbody.querySelectorAll('tr').forEach(row => { students.push(JSON.stringify({ class: row.querySelector('.student-class').value, id: row.querySelector('.student-id').value, name: row.querySelector('.student-name').value, role: row.querySelector('.student-role').value, roleOther: row.querySelector('.student-role-other').value,}));});
                data.push(["出席學生名單", students.join('||')]); 
                const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "活動資料收集_Save"); XLSX.writeFile(wb, "活動通告輸入備份.xlsx");
            });

            document.getElementById('import-excel-input').addEventListener('change', function(event) {
                const file = event.target.files[0]; 
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0]; 
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); const formData = {};
                        jsonData.slice(1).forEach(row => { if(row[0] && row[1] !== undefined) formData[row[0]] = row[1];});
                        function setFormValue(id, value) { if(document.getElementById(id) && value !== undefined && value !== null) document.getElementById(id).value = value; }
                        setFormValue('responsible-dept', formData['負責科/組/會社']); setFormValue('activity-name', formData['活動名稱']); setFormValue('responsible-teacher', formData['負責老師']); setFormValue('responsible-teacher-position', formData['負責老師職位']); setFormValue('leading-teacher', formData['領隊老師']); setFormValue('organizer', formData['主辦/合作機構']); setFormValue('activity-date', formData['活動日期']); setFormValue('activity-time', formData['活動時間']); setFormValue('activity-duration', formData['活動時數']); setFormValue('assembly-time', formData['集合時間']); setFormValue('dismissal-time', formData['解散時間']); setFormValue('assembly-point', formData['集合地點']); setFormValue('dismissal-point', formData['解散地點']); setFormValue('activity-location', formData['活動地點']); setFormValue('affects-lessons', formData['會否影響課堂']); setFormValue('activity-scope', formData['活動範圍']); setFormValue('activity-scale', formData['活動規模']);
                        document.querySelectorAll('input[name="activity-category"]').forEach(cb => cb.checked = false);
                        const cat1 = formData['活動類別1']; if(cat1) { const cb = document.querySelector(`input[name="activity-category"][value="${cat1}"]`); if(cb) cb.checked = true; }
                        const cat2 = formData['活動類別2']; if(cat2) { const cb = document.querySelector(`input[name="activity-category"][value="${cat2}"]`); if(cb) cb.checked = true; }
                        const cat3 = formData['活動類別3']; if(cat3) { const cb = document.querySelector(`input[name="activity-category"][value="${cat3}"]`); if(cb) cb.checked = true; }
                        setFormValue('needs-slp', formData['是否需要輸入SLP']); setFormValue('involves-external', formData['會否涉及校外機構或人士']); setFormValue('notice-number', formData['通告編號']); setFormValue('notice-type', formData['通告類別']); setFormValue('activity-original-price', formData['活動原價（$）']); setFormValue('notice-issue-date', formData['擬發出通告日期']); setFormValue('e-notice-end-date', formData['結束電子通告日期']); setFormValue('notice-target', formData['通告對象']); setFormValue('needs-parent-options', formData['是否需要提供家長選項']); setFormValue('parent-options-content', formData['家長的選項內容']); setFormValue('parent-options-other', formData['家長選項其他']); setFormValue('notice-remarks', formData['通告備註']); setFormValue('external-org-data-source', formData['外間組織/人士的資料提供方式']); setFormValue('external-org-details', formData['外間組織/人士的資料']);
                        if (formData['全港性校際比賽']) { const compData = formData['全港性校際比賽'].toString().split(','); document.querySelectorAll('input[name="inter-school-competition"]').forEach(cb => { if (cb.type === 'checkbox') { cb.checked = !!compData.find(d => d === `${cb.value}:true`); } else if (cb.type === 'text' && cb.name === 'inter-school-competition-other') { const match = compData.find(d => d.startsWith(`other_text:`)); if (match) cb.value = match.split(':')[1]; }});}
                        if (formData['活動包含價值教育']) { const values = formData['活動包含價值教育'].toString().split(','); document.querySelectorAll('input[name="value-education"]').forEach(cb => cb.checked = values.includes(cb.value));}
                        if (formData['價值相關學習範圍']) { const scopes = formData['價值相關學習範圍'].toString().split(','); document.querySelectorAll('input[name="value-learning-scope"]').forEach(cb => cb.checked = scopes.includes(cb.value));}
                        studentListTbody.innerHTML = ''; studentCounter = 0;
                        if (formData['出席學生名單'] && formData['出席學生名單'].length > 0) {
                            const studentStrings = formData['出席學生名單'].toString().split('||');
                            studentStrings.forEach(s => { if (s) { const student = JSON.parse(s); addStudentRow(); const lastRow = studentListTbody.lastElementChild; lastRow.querySelector('.student-class').value = student.class; lastRow.querySelector('.student-id').value = student.id; lastRow.querySelector('.student-name').value = student.name; const roleSelect = lastRow.querySelector('.student-role'); roleSelect.value = student.role; const roleOtherInput = lastRow.querySelector('.student-role-other'); roleOtherInput.value = student.roleOther; roleOtherInput.style.display = student.role === '其他' ? 'block' : 'none'; }});
                        } if (studentListTbody.children.length === 0) { addStudentRow(); }
                        noticeTypeSelect.dispatchEvent(new Event('change')); needsParentOptionsSelect.dispatchEvent(new Event('change')); parentOptionsContentSelect.dispatchEvent(new Event('change')); externalOrgDataSourceSelect.dispatchEvent(new Event('change'));
                        alert('資料已成功匯入！');
                    };
                    reader.readAsArrayBuffer(file); 
                    event.target.value = null; 
                }
            });

            document.getElementById('download-original-template').addEventListener('click', function() {
                const link = document.createElement('a'); link.href = 'PL1 通告綜合版_無需收費__BLANK_20250214.xlsx'; link.download = 'PL1 通告綜合版_無需收費__BLANK_20250214.xlsx';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
        }); 
    </script>
</body>
</html>
