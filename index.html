<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生活動通告系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            font-size: 14px; 
        }
        .container { max-width: 1100px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        h1 { font-size: 1.7em; text-align: center; margin-bottom: 18px;}
        h2 { font-size: 1.4em; margin-top: 22px; margin-bottom:12px; border-bottom: 2px solid #3498db; padding-bottom: 7px;}
        h3 { font-size: 1.15em; margin-top: 18px; margin-bottom:8px; color: #3498db;}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="time"], .form-group input[type="number"], .form-group select, .form-group textarea {
            padding: 9px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; width: 100%; font-size: 0.95em; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3498db; outline: none; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .checkbox-group label, .radio-group label { margin-right: 12px; font-weight: normal; font-size: 0.95em; }
        .checkbox-group input, .radio-group input { margin-right: 4px; vertical-align: middle;}
        .button-group { margin-top: 25px; padding-top: 18px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        button, .file-input-label {
            background-color: #3498db; color: white; padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em; transition: background-color 0.3s; text-align: center;
        }
        button:hover, .file-input-label:hover { background-color: #2980b9; }
        button.secondary { background-color: #95a5a6; }
        button.secondary:hover { background-color: #7f8c8d; }
        .file-input-hidden { display: none; }
        
        .student-table-wrapper {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .student-list-table { width: 100%; border-collapse: collapse; margin-top: 0px; table-layout: auto; min-width: 1000px; } /* min-width for horizontal scroll */
        .student-list-table th, .student-list-table td { border: 1px solid #ddd; padding: 7px; text-align: left; font-size: 0.9em;}
        .student-list-table th { background-color: #f2f2f2; font-size: 0.85em; white-space: nowrap;}
        .student-list-table input[type="text"], .student-list-table input[type="time"], .student-list-table select, .student-list-table textarea { width: calc(100% - 8px); padding: 4px; font-size: 0.9em; box-sizing: border-box; min-width: 80px; }
        .student-list-table textarea { min-height: 40px; resize: vertical;}
        .student-list-table button { padding: 4px 7px; font-size: 0.75em; margin-top: 4px; background-color: #e74c3c;}
        .student-list-table button:hover { background-color: #c0392b;}
        .student-list-table .after-activity-col { display: none; }
        .student-list-table .after-activity-input-container { display: none; }
        body.after-activity-mode .student-list-table .after-activity-col { display: table-cell; }
        body.after-activity-mode .student-list-table .after-activity-input-container { display: block; }
        body.after-activity-mode .student-list-table .student-role-other { display: block; }
        .student-list-table td.col-checkbox, .student-list-table th.col-checkbox { width: 30px; text-align: center; min-width: 30px;}
        .student-list-table td.col-seq { width: 40px; text-align: center; min-width: 40px;}
        .student-list-table td.col-actions { width: 60px; text-align: center; min-width: 60px;}


        .mode-toggle-container { display: flex; align-items: center; margin-bottom: 18px; justify-content: flex-end; }
        .mode-toggle-container label { margin-right: 8px; font-weight: bold; font-size: 0.95em;}
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; } 
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } 
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(22px); } 
        .hidden { display: none !important; }
        
        .pdf-page-render {
            display: none; 
            width: 210mm; 
            padding: 8mm; 
            box-sizing: border-box;
            background: white;
            color: black;
            font-family: 'KaiTi', '標楷體', 'MingLiU', 'PMingLiU', serif !important;
            font-size: 11.5pt; 
            line-height: 1.65; 
            position: relative; 
        }
        .pdf-page-render *, .pdf-page-render *:before, .pdf-page-render *:after {
            font-family: 'KaiTi', '標楷體', 'MingLiU', 'PMingLiU', serif !important;
            color: black !important;
            box-sizing: border-box;
        }
        .pdf-page-render p,
        .pdf-page-render li,
        .pdf-page-render div:not(#pdf-template-notice .notice-details-grid):not(#pdf-template-notice .reply-slip-details-grid):not(#pdf-template-notice .notice-date-principal-moved):not(#pdf-template-b-form .b-form-photo-grid),
        .pdf-page-render span, 
        .pdf-page-render td,
        .pdf-page-render th
         { 
            page-break-inside: avoid !important; 
            -webkit-region-break-inside: avoid !important; 
            break-inside: avoid !important;
        }

        .pdf-page-render table { width: 100%; border-collapse: collapse; font-size: 10.5pt; margin-top: 1.5mm; margin-bottom: 1.5mm;}
        .pdf-page-render th, .pdf-page-render td { border: 0.5px solid black; padding: 1mm 1.5mm; vertical-align: top; word-break: break-all; }
        .pdf-page-render .header { text-align: center; font-size: 16pt; font-weight: bold; margin-bottom: 2.5mm; line-height: 1.2;}
        .pdf-page-render .sub-header { text-align: center; font-size: 13pt; font-weight: bold; margin-bottom: 4mm; line-height: 1.2;}
        .pdf-page-render .small-text { font-size: 9pt; line-height: 1.25;}
        .pdf-page-render .bold { font-weight: bold; }
        .pdf-page-render .align-right { text-align: right; }
        .pdf-page-render .section { margin-bottom: 3mm; }
        .pdf-page-render .grid-container { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 0.8mm; margin-bottom: 2.5mm;}
        .pdf-page-render .grid-item label { font-weight: bold; }
        .pdf-page-render .signature-area { margin-top: 5mm; }
        .pdf-page-render .signature-line { border-bottom: 0.5px solid black; display: inline-block; min-height: 1em; vertical-align: bottom;} 
        .underline-value { border-bottom: 0.5px solid black; padding: 0 1mm; display: inline-block; min-height: 1.35em; vertical-align: bottom; }

        #pdf-template-notice > div:first-child { 
            min-height: 20mm !important; 
            position: relative; 
        }
        #pdf-template-notice .school-logo-img { 
            position: absolute;
            top: 4mm !important; 
            left: 8mm !important; 
            height: 20mm !important; 
            width: auto;   
            object-fit: contain; 
        }
        #pdf-template-notice .notice-top-right-container { 
            position: absolute;
            top: 4mm !important; 
            right: 8mm !important; 
            text-align: right; font-size: 11.5pt;
        }
        
        #pdf-template-notice .notice-main-header { text-align: center; font-size: 18pt; font-weight: bold; margin-top: 0 !important; margin-bottom: 1mm !important; line-height: 1.2;}
        #pdf-template-notice .notice-sub-header { 
            text-align: center; font-size: 14pt; font-weight: bold; 
            margin-top:0; margin-bottom: 1.5mm !important; 
            line-height: 1.2; border-bottom: 1px solid black; 
            padding-bottom: 1.5mm !important; text-decoration: none; 
        }
        
        #pdf-template-notice .notice-to { margin-top: 2mm !important; margin-bottom: 1.5mm !important; font-size: 11.5pt;}
        #pdf-template-notice .notice-body { 
            text-align: left; margin-bottom: 1mm !important; 
            line-height: 1.4 !important; font-size: 11.5pt;
        }
        
        #pdf-template-notice .notice-closing-block { 
            margin-top: 2mm !important; 
        }
        #pdf-template-notice .notice-date-principal-moved { 
            display: flex !important; justify-content: space-between !important; align-items: baseline !important; 
            margin-bottom: 1.5mm !important; font-size: 11.5pt; 
        }
        #pdf-template-notice .notice-date-principal-moved .principal-name { margin-left: auto; }

        #pdf-template-notice .notice-school-name-right { 
            text-align: right; font-weight: bold; font-size: 11.5pt; 
            margin-bottom: 3mm !important; 
        }
        
        #pdf-template-notice .notice-closing-block + hr { 
            display: none !important; 
        }
        
        #pdf-template-notice .activity-details-box { 
            border: 0.5px solid black; padding: 2mm !important; 
            margin: 3mm 0 !important; 
        }
        #pdf-template-notice .activity-details-box * { 
            line-height: 1.35 !important; 
        }
        #pdf-template-notice .notice-details-header {
            font-weight: bold; margin-bottom: 2mm !important; 
            font-size: 11.5pt; text-align: center;
        }
        #pdf-template-notice .notice-details-grid { 
            display: grid !important; 
            grid-template-columns: auto minmax(45mm, 1fr) auto minmax(45mm, 1fr) !important; 
            gap: 1mm 4mm !important; 
            margin-bottom: 1.5mm !important; font-size: 11.5pt;
        }
        #pdf-template-notice .notice-details-grid > span { page-break-inside: avoid !important; min-height: 1.35em; vertical-align: bottom; display: flex; flex-direction: column; justify-content: flex-end;} 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+1), 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+3) 
        { 
            font-weight: bold; white-space: nowrap; padding-right:1mm; text-align: left;
        }
        #pdf-template-notice .notice-details-grid > span:nth-child(4n+2), 
        #pdf-template-notice .notice-details-grid > span:nth-child(4n)    
        { 
             border-bottom: 0.5px solid black; padding-left:1mm; 
             width: 100%; 
        }
        #pdf-template-notice .notice-details-grid > span > div { min-height: 1.35em; } 
        #pdf-template-notice .notice-details-grid #pdf-activity-date {
            display: block; 
        }

        #pdf-template-notice .notice-remarks-container { 
            margin-top: 1.5mm !important; 
            display: flex !important; font-size: 11.5pt;
        }
        #pdf-template-notice .notice-remarks-container .label { font-weight: bold; white-space: nowrap; padding-right:1mm; flex-shrink: 0;}
        #pdf-template-notice .notice-remarks-container .value { border-bottom: 0.5px solid black; display: inline-block; width: 100%; min-height: 1.35em; vertical-align: bottom; padding-left:1mm;}
        #pdf-template-notice .notice-cost-info {
            margin: 2mm 0 1mm 0 !important; font-size: 11.5pt; text-align: left; padding-left: 1mm;
        }

        #pdf-template-notice .notice-signatures-container { 
            display: flex !important; 
            justify-content: space-between !important; 
            align-items: flex-start; 
            margin-top: 4mm !important; 
            min-height: auto !important; 
            padding-bottom: 2mm !important; 
        }
        #pdf-template-notice .notice-school-stamp-area { font-size: 11.5pt; flex-basis: 45%; text-align: left;}
        #pdf-template-notice .notice-school-stamp-box { 
            border: none !important; 
            height: auto !important; 
            line-height: normal !important;
            margin-top:1mm; text-align:center; font-size:9pt; color:#aaa !important; margin-left:0;
        }
        #pdf-template-notice .notice-teacher-signature-area { 
            font-size: 11.5pt; text-align:left; flex-basis: 50%;
        }
        #pdf-template-notice .teacher-sig-line { border-bottom: 0.5px solid black; min-width: 40mm; display:inline-block; text-align: center; min-height: 1.35em; vertical-align: bottom;}
        
        #pdf-template-notice .reply-slip-section-wrapper {
            page-break-inside: avoid !important; 
            break-inside: avoid-page !important; 
        }
        #pdf-template-notice .reply-slip-section-wrapper * { 
            line-height: 1.35 !important; 
        }
        #pdf-template-notice .reply-slip-header { 
            text-align: center; font-size: 13pt; font-weight: bold; 
            margin: 4mm 0 2mm 0 !important; 
            border-top: 1px dashed black !important; 
            padding-top: 3mm !important; 
        }
        #pdf-template-notice .reply-slip-body { 
            font-size: 11.5pt; margin-bottom: 1mm !important;
        }
        #pdf-template-notice .reply-slip-activity-name { 
            border-bottom: 0.5px solid black; font-weight:bold; text-align:center; 
            display:block; margin: 1.5mm auto !important; width: 75% !important; min-height: 1.35em;
        }
        #pdf-template-notice .reply-slip-school-right { 
            margin-top: 3mm !important; 
            text-align:right; font-size: 11.5pt; 
        }
        #pdf-template-notice .reply-slip-details-grid { 
            display: grid !important; 
            grid-template-columns: auto 1fr !important; 
            gap: 1.5mm !important; margin-top: 2mm !important; 
            font-size: 11.5pt;
        }
        #pdf-template-notice .reply-slip-details-grid > span,
        #pdf-template-notice .reply-slip-details-grid > div { page-break-inside: avoid !important; padding-top: 0.5mm; padding-bottom: 0.5mm; min-height: 1.35em; vertical-align: bottom;}
        #pdf-template-notice .reply-slip-details-grid > span:nth-child(odd) { font-weight: normal; white-space:nowrap; }
        #pdf-template-notice .reply-slip-details-grid .reply-underline-dynamic-container > .reply-underline-dynamic {
            display: inline-block; border-bottom: 0.5px solid black; padding: 0 1mm; min-width: 60mm; min-height: 1.35em; vertical-align: bottom;
        }
        #pdf-template-notice .reply-slip-details-grid div .class-no-span { border-bottom: 0.5px solid black; padding: 0 2mm; margin: 0 2mm; min-width:15mm; display:inline-block; min-height:1.35em; vertical-align:bottom;}


        #pdf-template-e-notice .enotice-version {text-align:right; font-size: 8.5pt; margin-bottom: 2mm;}
        #pdf-template-e-notice .grid-container-enotice { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 1mm; margin-bottom: 3mm; font-size: 9.5pt;}
        #pdf-template-e-notice .grid-item-enotice-full { grid-column: 1 / -1; }
        #pdf-template-e-notice .enotice-section-a {font-size:10pt; margin-bottom: 1mm;}
        #pdf-template-e-notice .enotice-instruction { margin-bottom: 4mm; font-size: 8.5pt; padding-left: 3.5mm;}
        #pdf-template-e-notice .signature-grid-enotice { display: grid; grid-template-columns: 1fr 1fr; gap: 4mm 5mm; margin-top: 6mm; font-size: 9.5pt;}
        #pdf-template-e-notice .signature-grid-enotice div { margin-bottom: 1.2mm;}
        #pdf-template-e-notice .signature-grid-enotice .signature-line { width: 50%;}

        #pdf-template-external-org .grid-container-ext { display: grid; grid-template-columns: auto 1fr; column-gap: 1.5mm; row-gap: 1mm; margin-bottom: 2.5mm; font-size: 9.5pt;}
        #pdf-template-external-org .ext-data-source-label { margin-right: 1mm; font-weight: normal !important; }
        #pdf-template-external-org .ext-data-details { margin-top:1mm; padding:1mm; border:0.5px solid #ccc; min-height:8mm; font-size: 9.5pt; }
        #pdf-template-external-org .ext-signature-item { margin-bottom: 3mm; font-size: 9.5pt;}
        #pdf-template-external-org .ext-signature-item .signature-line { width: 50mm;}
        #pdf-template-external-org .ext-guidelines { margin-top: 4mm; font-size: 9pt;}
        #pdf-template-external-org .ext-guidelines ol { padding-left: 3.5mm; margin-top: 1mm;}
        #pdf-template-external-org .ext-guidelines li { margin-bottom: 0.7mm;}

        #pdf-template-slp-form .slp-top-container { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0;}
        #pdf-template-slp-form .slp-main-header { text-align:left; margin-bottom:0; font-size:13pt; } 
        #pdf-template-slp-form .slp-top-right { text-align:right; font-size:9pt; margin-top: 1mm;} 
        #pdf-template-slp-form .slp-sub-header { text-align:center; margin-top:0; margin-bottom:3.5mm; font-size: 10.5pt;} 
        #pdf-template-slp-form .slp-section-title { font-weight: bold; margin-top: 2.5mm; margin-bottom: 1.2mm; font-size: 9pt; } 
        #pdf-template-slp-form .slp-field { margin-bottom: 0.6mm; font-size: 8.5pt; display: flex; align-items: baseline;} 
        #pdf-template-slp-form .slp-field label { font-weight: bold; min-width: 25mm; display: inline-block; flex-shrink: 0; } 
        #pdf-template-slp-form .slp-field span { word-break: break-all; }
        #pdf-template-slp-form .slp-checkbox-group { display: flex; flex-wrap: wrap; gap: 0.7mm 1.8mm; margin-left: 0px; font-size: 8.5pt;}
        #pdf-template-slp-form .slp-checkbox-item { margin-right: 1mm; white-space: nowrap;}
        #pdf-template-slp-form .slp-value-scope-group { display:block; font-size: 8.5pt; column-count: 2; column-gap: 3mm; margin-top:0.6mm;}
        #pdf-template-slp-form .slp-value-scope-item { margin-bottom: 0.6mm; white-space: nowrap;}
        #pdf-template-slp-form .slp-student-table { margin-top: 1.8mm; font-size: 8pt;}
        #pdf-template-slp-form .slp-student-table th, #pdf-template-slp-form .slp-student-table td { padding: 0.7mm 1mm; border: 0.5px solid #333; text-align: center;}
        #pdf-template-slp-form .slp-student-table td:nth-child(1) {width: 8mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(2) {width: 11mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(3) {width: 11mm;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(4) { text-align: left; width: auto;} 
        #pdf-template-slp-form .slp-student-table td:nth-child(5),td:nth-child(6),td:nth-child(7),td:nth-child(8) {width: 11mm;} 
        #pdf-template-slp-form .slp-notes { margin-top: 3.5mm; font-size: 8pt; } 
        #pdf-template-slp-form .slp-notes ol { padding-left: 2.5mm; margin-top: 0.6mm;} 
        #pdf-template-slp-form .slp-notes li { margin-bottom: 0.3mm;} 
        #pdf-template-slp-form .slp-signatures { margin-top: 4mm; display: flex; justify-content: space-between; font-size: 9.5pt;}
        #pdf-template-slp-form .slp-signature-item { min-width: 38mm; white-space: nowrap; display:flex; align-items: baseline; } 
        #pdf-template-slp-form .slp-signature-item .signature-line {width: 50%; margin-left: 2mm;}
        #pdf-template-slp-form #pdf-slp-activity-date span { display: block; margin-bottom: 0.3mm; } 


        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;}
        .loading-spinner { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay.hidden { display: none !important; }
        
        .temp-render-container-styles {
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            background: white !important; 
            color: black !important;
        }

        .assembly-group-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .assembly-group-item label {
            font-size: 0.85em;
            margin-bottom: 2px;
        }
        .assembly-group-item input {
            width: 100%;
        }
        .assembly-group-item button {
            padding: 6px 10px;
            font-size: 0.8em;
            background-color: #e74c3c;
            align-self: center; 
            margin-top: 18px; 
        }
        .activity-date-entry {
            border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background-color: #fdfdfd;
        }
        .activity-date-entry .form-group { margin-bottom:0 !important; } 

        #photo-upload-section { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        #photo-drop-zone { border: 2px dashed #ccc; border-radius: 4px; padding: 20px; text-align: center; cursor: pointer; background-color: #fff; }
        #photo-drop-zone.dragover { border-color: #3498db; background-color: #e9f5ff; }
        #photo-previews { 
            margin-top: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 15px; 
        }
        .photo-preview-item { 
            position: relative; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            background-color: #fff; 
            width: 100px; 
            height: 100px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .photo-preview-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }
        .remove-photo-btn { 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            background-color: rgba(0, 0, 0, 0.5); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 12px; 
            font-weight: bold;
            line-height: 20px; 
            text-align: center; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .remove-photo-btn:hover { background-color: rgba(231, 76, 60, 1); }


        #pdf-template-b-form .b-form-header { text-align: center; font-size: 16pt; font-weight: bold; margin-bottom: 3mm; }
        #pdf-template-b-form .b-form-sub-header { text-align: center; font-size: 13pt; font-weight: bold; margin-bottom: 5mm; }
        #pdf-template-b-form .b-form-section-title { font-size: 12pt; font-weight: bold; margin-top: 4mm; margin-bottom: 2mm; border-bottom: 1px solid black; padding-bottom: 1mm;}
        #pdf-template-b-form .b-form-grid { display: grid; grid-template-columns: auto 1fr; gap: 1mm 3mm; margin-bottom: 3mm; font-size:11pt; }
        #pdf-template-b-form .b-form-grid label { font-weight: bold; }
        #pdf-template-b-form .b-form-student-table { width:100%; border-collapse:collapse; font-size: 8pt; margin-top:2mm; }
        #pdf-template-b-form .b-form-student-table th, #pdf-template-b-form .b-form-student-table td { border: 0.5px solid black; padding: 0.8mm 1mm; text-align:left; vertical-align:top; word-break:break-all; }
        #pdf-template-b-form .b-form-student-table th { background-color: #f0f0f0; text-align:center; font-size:7.5pt; }
        #pdf-template-b-form .b-form-list { padding-left: 5mm; margin-top:1mm; font-size:10pt; }
        #pdf-template-b-form .b-form-list li { margin-bottom: 0.5mm; }
        #pdf-template-b-form .b-form-photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4mm; margin-top:2mm; }
        #pdf-template-b-form .b-form-photo-item img { width: 100%; height: auto; border: 0.5px solid #ccc; }


        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.6em; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
            button, .file-input-label { font-size: 0.95em; padding: 10px 15px;}
            .container { padding: 15px; }
            .assembly-group-item {
                grid-template-columns: 1fr; 
            }
            .assembly-group-item button {
                margin-top: 5px; 
            }
            .activity-date-entry > div { flex-direction: column; align-items: stretch !important; }
            .activity-date-entry .form-group { min-width: unset !important; width: 100%; margin-bottom: 10px !important; }
            .activity-date-entry button.remove-activity-date-entry { align-self: flex-start !important; margin-top: 5px; }
            /* .student-list-table { font-size: 0.8em; } */ /* Removed to allow browser default scaling with scroll */
            .student-list-table th, .student-list-table td { padding: 5px; }
            .student-list-table input, .student-list-table select, .student-list-table textarea { font-size: 0.9em; }
            #pdf-template-b-form .b-form-photo-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden"> <div class="loading-spinner"></div> </div>
    <div class="container">
        <h1>學生活動通告系統</h1>
        <div class="mode-toggle-container">
            <label for="after-activity-mode-checkbox">活動完成後模式</label>
            <label class="switch"> <input type="checkbox" id="after-activity-mode-checkbox"> <span class="slider"></span> </label>
        </div>
        <form id="activity-form">
            <h2>活動基本資料</h2>
            <div class="form-grid">
                <div class="form-group"> <label for="responsible-dept">負責科/組/會社:</label> <input type="text" id="responsible-dept" name="responsible-dept"> </div>
                <div class="form-group"> <label for="activity-name">活動名稱:</label> <input type="text" id="activity-name" name="activity-name"> </div>
                <div class="form-group"> <label for="responsible-teacher">負責老師:</label> <input type="text" id="responsible-teacher" name="responsible-teacher" required> </div>
                <div class="form-group"> <label for="responsible-teacher-position">負責老師職位:</label> <select id="responsible-teacher-position" name="responsible-teacher-position"> <option value="CM">CM</option> <option value="GM">GM</option> <option value="SGM">SGM</option> <option value="PGM">PGM</option> </select> </div>
                <div class="form-group"> <label for="leading-teacher">領隊老師 (樣式：陳小明):</label> <input type="text" id="leading-teacher" name="leading-teacher"> </div>
                <div class="form-group"> <label for="organizer">主辦/合作機構:</label> <input type="text" id="organizer" name="organizer"> </div>
                
                <div class="form-group form-group-span-2">
                    <label>活動日期/期間 (可新增多個):</label>
                    <div id="activity-dates-container">
                    </div>
                    <button type="button" id="add-activity-date-entry" class="secondary" style="margin-top:10px; font-size:0.9em; padding: 8px 12px; width: auto; flex-grow: 0;">新增日期/期間</button>
                </div>
                
                <div class="form-group form-group-span-2"> 
                    <label style="font-weight:bold; color: #333; margin-bottom: 8px;">集合安排 (可新增多個組別):</label>
                    <div id="assembly-groups-container">
                    </div>
                    <button type="button" id="add-assembly-group" class="secondary" style="margin-top:10px; font-size:0.9em; padding: 8px 12px; width: auto; flex-grow: 0;">新增集合組別</button>
                </div>

                <div class="form-group"> <label for="dismissal-time">解散時間:</label> <input type="time" id="dismissal-time" name="dismissal-time"> </div>
                <div class="form-group"> <label for="dismissal-point">解散地點:</label> <input type="text" id="dismissal-point" name="dismissal-point"> </div>
                <div class="form-group"> <label for="activity-location">活動地點:</label> <input type="text" id="activity-location" name="activity-location"> </div>
                <div class="form-group"> <label for="affects-lessons">會否影響課堂:</label> <select id="affects-lessons" name="affects-lessons"> <option value="否">否</option> <option value="會">會</option> </select> </div>
                <div class="form-group"> <label for="activity-scope">活動範圍:</label> <select id="activity-scope" name="activity-scope"> <option value="校內">校內</option> <option value="校外">校外</option> </select> </div>
                <div class="form-group"> <label for="activity-scale">活動規模:</label> <select id="activity-scale" name="activity-scale"> <option value="會社及小組">會社及小組</option> <option value="班際">班際</option> <option value="級際">級際</option> <option value="全校">全校</option> <option value="校際">校際</option> <option value="區際">區際</option> <option value="全港">全港</option> <option value="全國">全國</option> <option value="世界性">世界性</option> <option value="其他">其他</option> </select> </div>
                <div class="form-group form-group-span-2"> <label>活動類別 (最多可選 3 項):</label> <div id="activity-category-checkboxes" class="checkbox-group"> <label><input type="checkbox" name="activity-category" value="活動"> 活動</label> <label><input type="checkbox" name="activity-category" value="服務"> 服務</label> <label><input type="checkbox" name="activity-category" value="比賽"> 比賽</label> <label><input type="checkbox" name="activity-category" value="獎學金"> 獎學金</label> <label><input type="checkbox" name="activity-category" value="外遊"> 外遊</label> <label><input type="checkbox" name="activity-category" value="其他"> 其他</label> </div> </div>
                <div class="form-group"> <label for="needs-slp">是否需要輸入SLP:</label> <select id="needs-slp" name="needs-slp"> <option value="需要">需要</option> <option value="不需要">不需要</option> </select> </div>
                <div class="form-group"> <label for="involves-external">會否涉及校外機構或人士:</label> <select id="involves-external" name="involves-external"> <option value="否">否</option> <option value="會">會</option> </select> </div>
            </div>
            <h2>通告相關資料</h2>
            <div class="form-grid">
                <div class="form-group"> <label for="notice-number">通告編號:</label> <input type="text" id="notice-number" name="notice-number"> </div>
                <div class="form-group"> <label for="notice-type">通告類別:</label> <select id="notice-type" name="notice-type"> <option value="無需收費通告">無需收費通告</option> <option value="需收費通告">需收費通告</option> </select> </div>
                <div class="form-group" id="activity-original-price-group"> <label for="activity-original-price">活動原價（$） (每位同學計，無需填寫"$"):</label> <input type="number" id="activity-original-price" name="activity-original-price" step="0.1"> </div>
                <div class="form-group"> <label for="notice-issue-date">擬發出通告日期:</label> <input type="date" id="notice-issue-date" name="notice-issue-date"> </div>
                <div class="form-group"> <label for="e-notice-end-date">結束電子通告日期:</label> <input type="date" id="e-notice-end-date" name="e-notice-end-date"> </div>
                <div class="form-group"> <label for="notice-target">通告對象:</label> <select id="notice-target" name="notice-target"> <option value="全校">全校</option> <option value="中一">中一</option> <option value="中二">中二</option> <option value="中三">中三</option> <option value="中四">中四</option> <option value="中五">中五</option> <option value="中六">中六</option> <option value="指定學生名單（請附名單）">指定學生名單（請附名單）</option> </select> </div>
                <div class="form-group"> <label for="needs-parent-options">是否需要提供家長選項:</label> <select id="needs-parent-options" name="needs-parent-options"> <option value="是">是</option> <option value="否">否</option> </select> </div>
                <div class="form-group" id="parent-options-group"> <label for="parent-options-content">請列出家長的選項內容:</label> <select id="parent-options-content" name="parent-options-content"> <option value="同意/不同意">同意/不同意</option> <option value="參加/不參加">參加/不參加</option> <option value="出席/不出席">出席/不出席</option> <option value="其他">其他</option> </select> <input type="text" id="parent-options-other" name="parent-options-other" placeholder="其他選項內容" class="hidden" style="margin-top:5px;"> </div>
                <div class="form-group"> <label for="notice-remarks">通告備註:</label> <textarea id="notice-remarks" name="notice-remarks"></textarea> </div>
                <div class="form-group"> <label for="external-org-data-source">外間組織/人士的資料提供方式:</label> <select id="external-org-data-source" name="external-org-data-source"> <option value="不適用">不適用 (如不涉及)</option> <option value="見附件">提供附件</option> <option value="見以下資料">於下方填寫</option> </select> </div>
                <div class="form-group form-group-span-2" id="external-org-details-group"> <label for="external-org-details">外間組織/人士的資料 (如選擇"於下方填寫"):</label> <textarea id="external-org-details" name="external-org-details"></textarea> </div>
            </div>
            <h3>全港性校際比賽 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid"> <label><input type="checkbox" name="inter-school-competition" value="國民教育"> 國民教育</label> <label><input type="checkbox" name="inter-school-competition" value="STEAM教育"> STEAM教育</label> <label><input type="checkbox" name="inter-school-competition" value="兩文三語"> 兩文三語</label> <label><input type="checkbox" name="inter-school-competition" value="體藝"> 體藝</label> <label><input type="checkbox" name="inter-school-competition" value="其他"> 其他 <input type="text" name="inter-school-competition-other" placeholder="請註明" style="width:150px; margin-left:5px;"></label> </div>
            <h3>活動包含價值教育 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid"> <label><input type="checkbox" name="value-education" value="堅毅"> 堅毅</label> <label><input type="checkbox" name="value-education" value="尊重他人"> 尊重他人</label> <label><input type="checkbox" name="value-education" value="責任感"> 責任感</label> <label><input type="checkbox" name="value-education" value="國民身份認同"> 國民身份認同</label> <label><input type="checkbox" name="value-education" value="承擔精神"> 承擔精神</label> <label><input type="checkbox" name="value-education" value="誠信"> 誠信</label> <label><input type="checkbox" name="value-education" value="關愛"> 關愛</label> <label><input type="checkbox" name="value-education" value="守法"> 守法</label> <label><input type="checkbox" name="value-education" value="同理心"> 同理心</label> <label><input type="checkbox" name="value-education" value="勤勞"> 勤勞</label> </div>
            <h3>價值相關學習範圍 (在適當空格加上剔號，可選多於一項)</h3>
            <div class="checkbox-group form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));"> <label><input type="checkbox" name="value-learning-scope" value="品德及倫理範疇"> 品德及倫理範疇</label> <label><input type="checkbox" name="value-learning-scope" value="公民教育"> 公民教育</label> <label><input type="checkbox" name="value-learning-scope" value="國民教育"> 國民教育</label> <label><input type="checkbox" name="value-learning-scope" value="《憲法》及《基本法》教育"> 《憲法》及《基本法》教育</label> <label><input type="checkbox" name="value-learning-scope" value="國家安全教育"> 國家安全教育</label> <label><input type="checkbox" name="value-learning-scope" value="禁毒教育"> 禁毒教育</label> <label><input type="checkbox" name="value-learning-scope" value="生命教育"> 生命教育</label> <label><input type="checkbox" name="value-learning-scope" value="性教育"> 性教育</label> <label><input type="checkbox" name="value-learning-scope" value="媒體及資訊素養教育"> 媒體及資訊素養教育</label> <label><input type="checkbox" name="value-learning-scope" value="可持續發展教育"> 可持續發展教育</label> <label><input type="checkbox" name="value-learning-scope" value="人權教育"> 人權教育</label> <label><input type="checkbox" name="value-learning-scope" value="誠信教育"> 誠信教育</label> <label><input type="checkbox" name="value-learning-scope" value="守法教育"> 守法教育</label> <label><input type="checkbox" name="value-learning-scope" value="健康生活教育"> 健康生活教育</label> <label><input type="checkbox" name="value-learning-scope" value="家庭生活教育"> 家庭生活教育</label> </div>
            
            <div id="student-list-section">
                <h3>出席學生名單及擔任角色 (如有)</h3>
                <div class="student-table-wrapper">
                    <table id="student-list-table" class="student-list-table">
                        <thead> 
                            <tr> 
                                <th class="col-checkbox"><input type="checkbox" id="select-all-students" title="全選/取消全選"></th>
                                <th class="col-seq">序號</th> 
                                <th>班別</th> <th>學號</th> <th>姓名</th> <th>活動角色</th> 
                                <th class="after-activity-col">獎項</th>
                                <th class="after-activity-col">獎品/獎金</th>
                                <th class="after-activity-col">出席情況</th>
                                <th class="after-activity-col">缺席原因</th>
                                <th class="after-activity-col">遲到原因</th>
                                <th class="after-activity-col">到達時間<br>(如遲到)</th>
                                <th class="after-activity-col">備註</th>
                                <th class="col-actions">操作</th> 
                            </tr> 
                        </thead>
                        <tbody id="student-list-tbody"></tbody>
                    </table>
                </div>
                <div style="margin-top:10px; display:flex; flex-wrap: wrap; gap:10px; justify-content: flex-start; align-items: center;">
                    <button type="button" id="add-student-row" class="secondary" style="font-size:0.9em; padding: 8px 12px;">新增學生</button>
                    <button type="button" id="remove-selected-students" class="secondary" style="font-size:0.9em; padding: 8px 12px; background-color: #e74c3c;">移除已選學生</button>
                    <label for="import-student-list-input" class="file-input-label secondary" style="font-size:0.9em; padding: 8px 12px;">匯入學生名單 (Excel/CSV)</label>
                    <input type="file" id="import-student-list-input" class="file-input-hidden" accept=".xlsx,.csv">
                    <button type="button" id="student-list-help-btn" style="padding: 8px 10px; background-color: #5dade2; border: none; color: white; border-radius: 4px; cursor: pointer; font-size:0.9em;">上載格式要求</button>
                </div>
            </div>

            <div id="after-activity-data-section" class="hidden">
                <h2>活動完成後資料</h2>
                <div id="photo-upload-section">
                    <h3>上載具代表性的活動相片 (最少1張)</h3>
                    <div id="photo-drop-zone">
                        <p>拖放相片到此處 (JPG/JPEG/PNG)，或點擊選擇檔案</p>
                        <input type="file" id="activity-photos-input" class="file-input-hidden" multiple accept="image/jpeg,image/png,image/jpg">
                    </div>
                    <div id="photo-previews"></div>
                </div>
                <div id="award-summary-section" style="margin-top:20px;">
                    <h3>獎項及獎品統計</h3>
                    <p>總獎項數量: <span id="total-awards-count">0</span></p>
                    <p>獎項名稱列表 (不重覆):</p>
                    <ul id="unique-awards-list"><li>尚無獎項</li></ul>
                    <p>獎品/獎金列表 (不重覆):</p>
                    <ul id="unique-prizes-list"><li>尚無獎品/獎金</li></ul>
                </div>
            </div>


            <div class="button-group">
                <button type="button" id="generate-pdf-main">下載通告 PDF</button>
                <button type="button" id="generate-pdf-b" class="hidden">下載B表 PDF</button>
                <button type="button" id="export-inputs-excel">匯出目前輸入 (Excel)</button>
                <label for="import-excel-input" class="file-input-label secondary">匯入已存輸入 (Excel)</label>
                <input type="file" id="import-excel-input" class="file-input-hidden" accept=".xlsx">
                <input type="file" id="attachments-input" class="file-input-hidden" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                <div id="attachment-names" style="font-size:0.9em; color:#555; width:100%; text-align:center; margin-top:5px;"></div>
                <button type="button" id="download-original-template" class="secondary">下載原始Excel範本</button>
            </div>
        </form>
    </div>

    <div id="pdf-template-notice" class="pdf-page-render">
        <div style="position: relative; width: 100%; min-height: 20mm;"> 
            <img src="School logo.png" alt="School Logo" class="school-logo-img"/>
            <div class="notice-top-right-container">家長通告 <span id="pdf-notice-num-header" class="underline-value" style="min-width:20mm;"></span> 號</div>
        </div>
        <div class="notice-main-header header">佛 教 何 南 金 中 學</div>
        <div class="notice-sub-header sub-header">學 生 活 動 通 知 家 長 信(PL1)</div>
        
        <div class="notice-to">敬啟者：</div>
        <div class="notice-body"> 貴子弟已報名參加以下活動以裨益身心。是項活動由老師帶領，各學生務須服從指示，注意安全。出發前須留意可能影響活動進行的因素，如天氣、身體狀況及學校宣佈。如貴子弟因身體不適及過往病歷不適合運動或需特別照顧，務須於活動前知會負責老師。 </div>
        <div class="notice-body"> 至於貴子弟屆時是否參加，謹聽台端決定。學校籌辦活動所需資源不菲，同學應盡責出席，無故缺席以致未能完成有關活動，學校有可能要求同學補付原價全費。請將附函按時填覆，俾憑辦理，如有疑問，可致電 2340 0871 查詢。此致 </div>
        
        <div class="notice-closing-block">
            <div class="notice-date-principal-moved">
                <span>日期：<span id="pdf-notice-issue-date-moved" class="underline-value" style="min-width:40mm;"></span></span>
                <span class="principal-name" style="margin-left: auto;">馬寶紅校長：<span class="underline-value" style="min-width:30mm; margin-left:1mm;">&nbsp;</span></span>
            </div>
            <div class="notice-school-name-right">佛 教 何 南 金 中 學</div>
        </div>
        
        <hr style="border: none; border-top: 1px solid black; margin: 6mm 0;">
        
        <div class="activity-details-box">
            <div class="notice-details-header">貴 子 弟 報 名 參 加 之 活 動 情 況 如 下 :-</div>
            <div class="notice-details-grid">
                <span>活動名稱：</span><span id="pdf-activity-name"></span> 
                <span id="pdf-responsible-teacher-detail-label">負責老師：</span><span id="pdf-responsible-teacher-detail"></span>
                <span>舉行地點：</span><span id="pdf-activity-location"></span> 
                <span>舉行日期：</span><span id="pdf-activity-date"></span>
                <span>集合時間：</span><span id="pdf-assembly-time"></span> 
                <span>集合地點：</span><span id="pdf-assembly-point"></span>
                <span>解散時間：</span><span id="pdf-dismissal-time"></span> 
                <span>解散地點：</span><span id="pdf-dismissal-point"></span>
            </div>
            <div class="notice-remarks-container">
                <span class="label">備註：</span><span id="pdf-notice-remarks" class="value"></span>
            </div>
            <div class="notice-cost-info" id="pdf-notice-cost-info-container">
            </div>
        </div>
        
        <div class="notice-signatures-container">
            <div class="notice-school-stamp-area">學校蓋印: <div class="notice-school-stamp-box"></div></div>
            <div class="notice-teacher-signature-area">負責老師： <span id="pdf-responsible-teacher-sig" class="teacher-sig-line"></span></div>
        </div>

        <div class="reply-slip-section-wrapper"> 
            <div class="reply-slip-header">學 生 活 動 家 長 回 條</div>
            <div class="reply-slip-body">敬覆者：領悉家長通告第 <span id="pdf-notice-num-reply" class="underline-value" style="min-width:20mm;">&nbsp;</span> 號文內各節，茲 <span id="pdf-parent-choice-action" class="underline-value" style="min-width:30mm;">&nbsp;</span> 敝子弟參加</div>
            <div id="pdf-activity-name-reply" class="reply-slip-activity-name"></div>
            <div class="reply-slip-body">活動，並會提醒其於進行活動時應遵守各安全規則。本人明白無故缺席以致未能完成有關活動，學校有可能要求同學補付原價全費。此覆</div>
            <div class="reply-slip-school-right">佛教何南金中學</div>
            <div class="reply-slip-details-grid">
                <span>學生姓名：</span><span class="reply-underline-dynamic-container"><span class="reply-underline-dynamic">&nbsp;</span></span>
                <span>學生班別及學號：</span>
                <div><span class="class-no-span">&nbsp;</span>班 <span class="class-no-span">&nbsp;</span>號</div>
                <span>家長 / 監護人簽署：</span><span class="reply-underline-dynamic-container"><span class="reply-underline-dynamic">&nbsp;</span></span>
                <span>家長 / 監護人姓名：</span><span class="reply-underline-dynamic-container"><span class="reply-underline-dynamic">&nbsp;</span></span>
                <span>家長 / 監護人電話：</span><span class="reply-underline-dynamic-container"><span class="reply-underline-dynamic">&nbsp;</span></span>
                <span>日期：</span><span class="reply-underline-dynamic-container"><span class="reply-underline-dynamic">&nbsp;</span></span>
            </div>
        </div>
    </div>

    <div id="pdf-template-e-notice" class="pdf-page-render">
        <div class="enotice-version">表格版本:20230821</div>
        <div class="header">佛教何南金中學</div>
        <div class="sub-header">電子通告申請書</div>
        <div class="grid-container-enotice" style="margin-bottom: 12px;">
            <label>通告編號</label><span id="pdf-en-notice-no"></span>
            <label>負責老師</label><span id="pdf-en-resp-teacher"></span>
            <label>所屬委員會 / 科目 / 組別</label><span id="pdf-en-dept"></span>
            <label>通告類別</label><span id="pdf-en-notice-type"></span>
        </div>
        <hr style="margin-bottom: 8px;">
        <p class="enotice-section-a"><span class="bold">甲部：</span> <span id="pdf-en-notice-type-detail" style="font-weight:bold;"></span></p>
        <p class="enotice-instruction">填妥後請連同通告文本及所有附件(包括紙本、檔案及學生名單(如有))交校務處張淑儀小姐。</p>
        <div class="grid-container-enotice">
            <label>電子通告標題</label><span id="pdf-en-title"></span>
            <label>擬發出通告日期</label><span id="pdf-en-issue-date"></span>
            <label>結束電子通告日期</label><span id="pdf-en-end-date"></span>
            <label>通告對象</label><span id="pdf-en-target"></span>
            <label class="grid-item-enotice-full">通告內容</label><span class="grid-item-enotice-full" style="font-weight:normal !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(見附件通告文本)</span>
            <label>是否需要提供家長選項</label><span id="pdf-en-parent-option-needed"></span>
            <label>請列出家長的選項內容</label><span id="pdf-en-parent-option-content"></span>
        </div>
        <div class="signature-grid-enotice" style="margin-top: 35px;">
            <div><span style="font-weight:bold;">發電子收費通告前</span></div> <div><span style="font-weight:bold;">發電子通告後</span></div>
            <div>擬通告負責老師簽署：<span class="signature-line"></span></div> <div>發還電子收費報告日期：<span class="signature-line"></span></div>
            <div>填寫電子通告申請表日期：<span class="signature-line"></span></div> <div>負責老師簽收報告：<span class="signature-line"></span></div>
            <div>設定通告同事簽署：<span class="signature-line"></span></div> <div></div>
            <div>檢查通告後老師簽署：<span class="signature-line"></span></div> <div></div>
        </div>
    </div>

    <div id="pdf-template-external-org" class="pdf-page-render">
        <div class="header">佛教何南金中學</div>
        <div class="sub-header">外間機構出外參觀/活動/講座/工作坊/教學申請</div>
        <div class="grid-container-ext">
            <label>會否涉及校外機構或人士</label><span id="pdf-ext-involved"></span>
            <label>外間團體</label><span id="pdf-ext-org-name"></span>
            <label>活動名稱</label><span id="pdf-ext-activity-name"></span>
            <label>活動地點</label><span id="pdf-ext-activity-date-location"></span>
            <label>校內負責人姓名</label><span id="pdf-ext-internal-resp-name"></span>
            <label>校內負責人職位</label><span id="pdf-ext-internal-resp-pos"></span>
            <label>所屬組別</label><span id="pdf-ext-dept"></span>
            <label>活動/講座/工作坊/教學日期</label><span id="pdf-ext-real-activity-date"></span>
        </div>
        <hr style="margin: 8px 0;">
        <p class="small-text" style="line-height:1.5; margin-bottom:8px;">本人為是次活動的負責人， 已閱「校內負責老師須知」及「外間組織/團體須知」， 並了解任何團體/人士曾經、正在或有機會作出違法行為皆不可進行活動/講座/工作坊/教學。</p>
        <div class="section">
            <p class="bold" style="font-size:11pt;">外間組織/人士的資料:</p>
            <div style="margin-left:10px; font-size:10pt; line-height:1.7;">
                <span id="pdf-ext-data-attachment-tick" class="ext-data-source-label"></span> 見附件&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;或<br>
                <span id="pdf-ext-data-below-tick" class="ext-data-source-label"></span> 見以下資料
                <div id="pdf-ext-data-details-content" class="ext-data-details"></div>
            </div>
        </div>
        <div class="signature-area ext-signature-item" style="margin-top:25px;">
            <div>校內負責同事姓名：<span id="pdf-ext-internal-colleague-name" style="border-bottom:1px solid black; padding: 0 15px;"></span></div>
            <div style="margin-top:20px;">校內負責同事簽名：<span class="signature-line" style="width:220px;"></span></div>
            <div style="margin-top:20px;">上級校長層同事簽名：<span class="signature-line" style="width:180px;"></span> (如不涉及外間機構無需簽名)</div>
            <div style="margin-top:20px;">日期：<span class="signature-line" style="width:220px;"></span></div>
        </div>
        <hr style="margin-top:15px;">
        <div class="ext-guidelines">
            <p class="bold" style="font-size:10pt;">校內負責老師須知</p>
            <ol>
                <li>查閱時間是否有空。</li>
                <li>最少兩星期前向校長提出。</li>
                <li>需了解該團體/地點之背景， 合乎香港法律， 任何團體/組織曾經、正在或有機會作出違法行為皆不可進行活動/講座/工作坊/教學。</li>
                <li>向學校提供該機構背景的書面資料</li>
                <li>需將「出外參觀/活動/講座/工作坊/教學申請」交回校務處， 並通知校務處。</li>
                <li>需安排同事當值， 活動、講座、工作坊期間須有校內老師在場。</li>
                <li>發Teams正式通知全體老師活動/講座/工作坊細節。</li>
            </ol>
        </div>
    </div>

    <div id="pdf-template-slp-form" class="pdf-page-render">
        <div class="slp-top-container">
             <div class="slp-main-header header">佛教何南金中學</div>
             <div class="slp-top-right"><span id="pdf-slp-needs-slp"></span></div>
        </div>
        <div class="slp-sub-header sub-header">活動記錄及學生學習概覽登記(活動前)</div>

        <div class="slp-section-title" style="margin-top: 5px;">A. 活動基本資料：</div>
        <div class="slp-field"><label>負責科/組/會社:</label><span id="pdf-slp-dept"></span></div>
        <div class="slp-field"><label>活動名稱:</label><span id="pdf-slp-activity-name"></span></div>
        <div class="slp-field"><label>負責老師:</label><span id="pdf-slp-resp-teacher"></span></div>
        <div class="slp-field"><label>活動隨隊老師:</label><span id="pdf-slp-leading-teacher"></span></div>
        <div class="slp-field"><label>主辦 /合作機構:</label><span id="pdf-slp-organizer"></span></div>
        <div class="slp-field"><label>活動日期:</label><span id="pdf-slp-activity-date"></span></div>
        <div class="slp-field"><label>活動時間:</label><span id="pdf-slp-activity-time"></span></div>
        <div class="slp-field"><label>活動時數:</label><span id="pdf-slp-activity-duration"></span></div>
        <div class="slp-field"><label>活動地點:</label><span id="pdf-slp-activity-location"></span></div>
        <div class="slp-field"><label>會否影響課堂:</label><span id="pdf-slp-affects-lessons"></span></div>
        <div class="slp-field"><label>活動範圍:</label><span id="pdf-slp-activity-scope"></span></div>
        <div class="slp-field"><label>活動規模:</label><span id="pdf-slp-activity-scale"></span></div>
        <div class="slp-field"><label>活動類別:</label><span id="pdf-slp-activity-categories"></span></div>

        <div class="slp-section-title">B. 全港性校際比賽：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-inter-school-comp" class="slp-checkbox-group"></div>

        <div class="slp-section-title">C. 活動包含價值教育：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-value-edu" class="slp-checkbox-group"></div>
        
        <div class="slp-section-title">D. 價值相關學習範圍：(在適當空格加上剔號，可選多於一項)</div>
        <div id="pdf-slp-value-learning-scope" class="slp-value-scope-group"></div>

        <div class="slp-section-title">E. 出席學生名單及擔任角色</div>
        <table id="pdf-slp-student-list-table" class="slp-student-table">
            <thead><tr><th></th><th>班別</th><th>學號</th><th>姓名</th><th>主席</th><th>組長</th><th>參加者</th><th>其他<br>(請註明)</th></tr></thead>
            <tbody id="pdf-slp-student-list-tbody"></tbody>
        </table>

        <div class="slp-notes">
            <p class="bold" style="font-size:10pt;">負責老師注意事項：</p>
            <ol>
                <li>無論校內或校外舉辦活動，均須提交本表格</li>
                <li>活動前一星期填妥此表交校長批核</li>
                <li>已囑咐學生聯絡受影響科任老師交代課堂安排</li>
                <li>已發「學生活動通知家長信」及通知家長相關安排（如需要）</li>
                <li>通知警方備案(如需要)</li>
                <li>實體與電子版本的通告及本表格已交校務處MOON存檔記錄</li>
                <li>活動後，請提交下列電子版本文件：
                    <ul style="list-style-type: disc; margin-left:18px; margin-top:1px; margin-bottom:1px;">
                        <li>約10張具代表性的活動相片（必須提交）</li>
                        <li>活動後參加名單修正（如需要, 請填B表）</li>
                        <li>比賽獎項記錄表（如需要，請填B表），實體版本文件請交校長</li>
                    </ul>
                </li>
                <li>請為活動製作網頁，網頁內容交所屬科組助理協助製作</li>
                <li>傳訊組或會到活動中進行採訪或拍攝，但未必可以全程參與，故同事仍需為活動安排拍攝</li>
            </ol>
        </div>
        <div class="slp-signatures">
            <div class="slp-signature-item">負責老師簽署：<span class="signature-line"></span></div>
            <div class="slp-signature-item">校長簽署：<span class="signature-line"></span></div>
            <div class="slp-signature-item">日期：<span class="signature-line"></span></div>
        </div>
    </div>

    <div id="pdf-template-b-form" class="pdf-page-render">
        <div class="b-form-header">佛教何南金中學</div>
        <div class="b-form-sub-header">B表 - 最終名單及比賽獎項記錄表</div>
        
        <div class="b-form-section-title">基本資料</div>
        <div class="b-form-grid">
            <label>活動名稱:</label><span id="pdf-b-activity-name"></span>
            <label>負責老師:</label><span id="pdf-b-resp-teacher"></span>
            <label>合辦機構:</label><span id="pdf-b-organizer"></span>
            <label>通告編號:</label><span id="pdf-b-notice-no"></span>
        </div>

        <div class="b-form-section-title">最終名單及比賽獎項記錄表</div>
        <div id="pdf-b-student-list-render-area"></div>
        <div style="font-size:10pt; margin-top:2mm;">
            <p>總獎項數量: <span id="pdf-b-total-awards-count"></span></p>
            <p>獎項名稱列表 (不重覆):</p>
            <ul id="pdf-b-unique-awards-list" class="b-form-list"></ul>
            <p>獎品/獎金列表 (不重覆):</p>
            <ul id="pdf-b-unique-prizes-list" class="b-form-list"></ul>
        </div>

        <div class="b-form-section-title">具代表性的活動相片</div>
        <div id="pdf-b-photo-render-area" class="b-form-photo-grid">
        </div>
    </div>
    
    <script>
        const { jsPDF } = window.jspdf;
        let attachedFiles = [];
        let activityPhotos = [];
        
        let currentGlobalPdfY = 0; 
        let isFirstPageOfEntireDocumentGlobal = true;

        async function addCanvasToPdfWithSlicing(pdfInstance, canvasToAdd, startY, 
                                                isFirstPageOfDoc, marginX, marginYTop, 
                                                pagePrintableWidth, pagePrintableHeight) {
            let currentY = startY;
            let isCurrentlyFirstPageOfDoc = isFirstPageOfDoc;

            if (!canvasToAdd || canvasToAdd.width === 0 || canvasToAdd.height === 0) {
                console.warn("addCanvasToPdfWithSlicing called with an invalid or zero-dimension canvas. Skipping.", canvasToAdd);
                return { finalY: currentY, isDocStillFirstPage: isCurrentlyFirstPageOfDoc };
            }

            const masterCanvasWidth = canvasToAdd.width;
            const masterCanvasHeight = canvasToAdd.height;
            const sliceHeightInMasterCanvasPx = (pagePrintableHeight * masterCanvasWidth) / pagePrintableWidth;
            const numSlices = Math.max(1, Math.ceil(masterCanvasHeight / sliceHeightInMasterCanvasPx));

            for (let k = 0; k < numSlices; k++) {
                if (k > 0) { 
                    pdfInstance.addPage();
                    isCurrentlyFirstPageOfDoc = false;
                    currentY = marginYTop;
                } else if (isCurrentlyFirstPageOfDoc) {
                     currentY = marginYTop; 
                }
                
                const sy = k * sliceHeightInMasterCanvasPx; 
                const sHeightPx = Math.min(sliceHeightInMasterCanvasPx, masterCanvasHeight - sy); 

                const segmentCanvas = document.createElement('canvas');
                segmentCanvas.width = masterCanvasWidth;
                segmentCanvas.height = sHeightPx;
                const segmentCtx = segmentCanvas.getContext('2d');
                if (!segmentCtx) {
                     console.error("Failed to get 2D context for segment canvas");
                     continue; 
                }
                segmentCtx.drawImage(canvasToAdd, 0, sy, masterCanvasWidth, sHeightPx, 0, 0, masterCanvasWidth, sHeightPx);
                
                const segmentImgData = segmentCanvas.toDataURL('image/png', 1.0);
                const imageActualHeightInPdfMm = (sHeightPx * pagePrintableWidth) / masterCanvasWidth;

                if (currentY !== marginYTop && (currentY + imageActualHeightInPdfMm > marginYTop + pagePrintableHeight + 0.1)) { 
                    pdfInstance.addPage();
                    isCurrentlyFirstPageOfDoc = false;
                    currentY = marginYTop;
                }
                
                pdfInstance.addImage(segmentImgData, 'PNG', marginX, currentY, pagePrintableWidth, imageActualHeightInPdfMm, undefined, 'FAST');
                currentY += imageActualHeightInPdfMm;
                isCurrentlyFirstPageOfDoc = false; 
            }
            return { finalY: currentY, isDocStillFirstPage: isCurrentlyFirstPageOfDoc };
        }


        document.addEventListener('DOMContentLoaded', function() {
            const afterActivityModeCheckbox = document.getElementById('after-activity-mode-checkbox');
            const downloadOriginalBlankTemplateBtn = document.getElementById('download-original-template');
            const activityOriginalPriceGroup = document.getElementById('activity-original-price-group');
            const noticeTypeSelect = document.getElementById('notice-type');
            const parentOptionsGroup = document.getElementById('parent-options-group');
            const needsParentOptionsSelect = document.getElementById('needs-parent-options');
            const parentOptionsContentSelect = document.getElementById('parent-options-content');
            const parentOptionsOtherInput = document.getElementById('parent-options-other');
            const externalOrgDataSourceSelect = document.getElementById('external-org-data-source');
            const externalOrgDetailsGroup = document.getElementById('external-org-details-group');
            const attachmentsInput = document.getElementById('attachments-input');
            const attachmentNamesDiv = document.getElementById('attachment-names');
            const loadingOverlay = document.getElementById('loading-overlay');
            const addAssemblyGroupButton = document.getElementById('add-assembly-group');
            const assemblyGroupsContainer = document.getElementById('assembly-groups-container');
            const addActivityDateEntryButton = document.getElementById('add-activity-date-entry');
            const activityDatesContainer = document.getElementById('activity-dates-container');
            const studentListHelpBtn = document.getElementById('student-list-help-btn');
            const afterActivityDataSection = document.getElementById('after-activity-data-section');
            const generatePdfBButton = document.getElementById('generate-pdf-b');
            const photoDropZone = document.getElementById('photo-drop-zone');
            const activityPhotosInput = document.getElementById('activity-photos-input');
            const photoPreviewsContainer = document.getElementById('photo-previews');
            const selectAllStudentsCheckbox = document.getElementById('select-all-students');
            const removeSelectedStudentsBtn = document.getElementById('remove-selected-students');
            
            function showLoader() { if(loadingOverlay) loadingOverlay.classList.remove('hidden'); }
            function hideLoader() { if(loadingOverlay) loadingOverlay.classList.add('hidden'); }

            function toggleAfterActivityMode() {
                const isAfterActivity = afterActivityModeCheckbox.checked;
                document.body.classList.toggle('after-activity-mode', isAfterActivity);
                afterActivityDataSection.classList.toggle('hidden', !isAfterActivity);
                generatePdfBButton.classList.toggle('hidden', !isAfterActivity);
                document.querySelectorAll('.student-list-table .after-activity-col').forEach(el => el.style.display = isAfterActivity ? 'table-cell' : 'none');
                document.querySelectorAll('.student-list-table .after-activity-input-container').forEach(el => el.style.display = isAfterActivity ? 'block' : 'none');
                updateStudentListHelpText();
                if (isAfterActivity) {
                    updateAwardSummary();
                }
            }
            afterActivityModeCheckbox.addEventListener('change', toggleAfterActivityMode);


            function toggleOriginalPriceVisibility() {
                activityOriginalPriceGroup.classList.toggle('hidden', noticeTypeSelect.value === '無需收費通告');
            }
            
            function toggleParentOptionsVisibility() {
                const needsOptions = needsParentOptionsSelect.value === '是';
                parentOptionsGroup.classList.toggle('hidden', !needsOptions);
                if (!needsOptions) { parentOptionsOtherInput.classList.add('hidden'); } 
                else { toggleParentOptionsOtherVisibility(); }
            }

            function toggleParentOptionsOtherVisibility() {
                if (needsParentOptionsSelect.value === '是') {
                    parentOptionsOtherInput.classList.toggle('hidden', parentOptionsContentSelect.value !== '其他');
                }
            }
            
            function toggleExternalOrgDetailsVisibility() {
                externalOrgDetailsGroup.classList.toggle('hidden', externalOrgDataSourceSelect.value !== '見以下資料');
            }

            noticeTypeSelect.addEventListener('change', toggleOriginalPriceVisibility);
            needsParentOptionsSelect.addEventListener('change', toggleParentOptionsVisibility);
            parentOptionsContentSelect.addEventListener('change', toggleParentOptionsOtherVisibility);
            externalOrgDataSourceSelect.addEventListener('change', toggleExternalOrgDetailsVisibility);

            const studentListTbody = document.getElementById('student-list-tbody');
            const addStudentRowBtn = document.getElementById('add-student-row');
            let studentCounter = 0;

            function addStudentRow(studentData = {}) {
                studentCounter++;
                const row = studentListTbody.insertRow();
                row.innerHTML = `
                    <td class="col-checkbox"><input type="checkbox" class="student-select-checkbox"></td>
                    <td class="col-seq">${studentCounter}</td>
                    <td><input type="text" name="student-class-${studentCounter}" class="student-class" value="${studentData.class || ''}"></td>
                    <td><input type="text" name="student-id-${studentCounter}" class="student-id" value="${studentData.id || ''}"></td>
                    <td><input type="text" name="student-name-${studentCounter}" class="student-name" value="${studentData.name || ''}"></td>
                    <td>
                        <select name="student-role-${studentCounter}" class="student-role">
                            <option value="參加者">參加者</option> <option value="主席">主席</option> <option value="組長">組長</option> <option value="其他">其他</option>
                        </select>
                        <input type="text" name="student-role-other-${studentCounter}" class="student-role-other" placeholder="請註明其他角色" style="display:none; margin-top:4px;">
                    </td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><textarea name="student-awards-${studentCounter}" class="student-awards" placeholder="每行一個獎項">${studentData.awards || ''}</textarea></div></td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><textarea name="student-prizes-${studentCounter}" class="student-prizes" placeholder="每行一個獎品/獎金">${studentData.prizes || ''}</textarea></div></td>
                    <td class="after-activity-col">
                        <div class="after-activity-input-container">
                            <select name="student-attendance-${studentCounter}" class="student-attendance">
                                <option value="出席">出席</option> <option value="缺席">缺席</option> <option value="遲到">遲到</option>
                            </select>
                        </div>
                    </td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><input type="text" name="student-absence-reason-${studentCounter}" class="student-absence-reason" placeholder="缺席原因" style="display:none;"></div></td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><input type="text" name="student-lateness-reason-${studentCounter}" class="student-lateness-reason" placeholder="遲到原因" style="display:none;"></div></td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><input type="time" name="student-arrival-time-${studentCounter}" class="student-arrival-time" style="display:none;"></div></td>
                    <td class="after-activity-col"><div class="after-activity-input-container"><textarea name="student-remarks-${studentCounter}" class="student-remarks" placeholder="備註">${studentData.remarks || ''}</textarea></div></td>
                    <td class="col-actions"><button type="button" class="remove-student-row">移除</button></td>
                `;
                
                const roleSelect = row.querySelector('.student-role');
                const roleOtherInput = row.querySelector('.student-role-other');
                const attendanceSelect = row.querySelector('.student-attendance');
                const absenceReasonInput = row.querySelector('.student-absence-reason');
                const latenessReasonInput = row.querySelector('.student-lateness-reason');
                const arrivalTimeInput = row.querySelector('.student-arrival-time');

                if (studentData.role) {
                    const roleValue = String(studentData.role).trim(); 
                    const existingOption = Array.from(roleSelect.options).find(opt => opt.value === roleValue);
                    if (existingOption) {
                        roleSelect.value = roleValue;
                    } else { 
                        roleSelect.value = "其他";
                        roleOtherInput.value = roleValue; 
                    }
                } else {
                    roleSelect.value = "參加者"; 
                }
                roleOtherInput.style.display = roleSelect.value === '其他' ? 'block' : 'none';
                if(studentData.roleOther) roleOtherInput.value = studentData.roleOther;

                attendanceSelect.value = studentData.attendance || '出席';
                absenceReasonInput.value = studentData.absenceReason || '';
                latenessReasonInput.value = studentData.latenessReason || '';
                arrivalTimeInput.value = studentData.arrivalTime || '';

                function toggleAttendanceFields() {
                    const selectedAttendance = attendanceSelect.value;
                    absenceReasonInput.style.display = selectedAttendance === '缺席' ? 'block' : 'none';
                    latenessReasonInput.style.display = selectedAttendance === '遲到' ? 'block' : 'none';
                    arrivalTimeInput.style.display = selectedAttendance === '遲到' ? 'block' : 'none';
                }
                
                attendanceSelect.addEventListener('change', toggleAttendanceFields);
                toggleAttendanceFields();


                roleSelect.addEventListener('change', function() { roleOtherInput.style.display = this.value === '其他' ? 'block' : 'none'; });
                row.querySelector('.remove-student-row').addEventListener('click', function() { this.closest('tr').remove(); renumberStudents(); updateAwardSummary(); });
                
                row.querySelectorAll('.student-awards, .student-prizes').forEach(textarea => {
                    textarea.addEventListener('input', updateAwardSummary);
                });

                const isAfterActivity = afterActivityModeCheckbox.checked;
                row.querySelectorAll('.after-activity-col .after-activity-input-container').forEach(el => el.style.display = isAfterActivity ? 'block' : 'none');
                row.querySelectorAll('.after-activity-col').forEach(el => el.style.display = isAfterActivity ? 'table-cell' : 'none');
            }
            
            function renumberStudents() {
                const rows = studentListTbody.querySelectorAll('tr');
                studentCounter = 0;
                rows.forEach((row, index) => {
                    studentCounter = index + 1;
                    row.cells[1].innerText = studentCounter;
                    row.querySelectorAll('input, select, textarea').forEach(input => {
                        const nameAttr = input.getAttribute('name');
                        if (nameAttr) {
                            input.setAttribute('name', nameAttr.replace(/-\d+$/, `-${studentCounter}`));
                        }
                    });
                });
                selectAllStudentsCheckbox.checked = false;
            }

            addStudentRowBtn.addEventListener('click', () => { addStudentRow(); renumberStudents(); });
            addStudentRow(); 

            selectAllStudentsCheckbox.addEventListener('change', function() {
                studentListTbody.querySelectorAll('.student-select-checkbox').forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });

            removeSelectedStudentsBtn.addEventListener('click', function() {
                const selectedRows = Array.from(studentListTbody.querySelectorAll('.student-select-checkbox:checked'));
                if (selectedRows.length === 0) {
                    alert("請先選擇要移除的學生。");
                    return;
                }
                if (confirm(`確定要移除已選的 ${selectedRows.length} 名學生嗎？`)) {
                    selectedRows.forEach(checkbox => checkbox.closest('tr').remove());
                    renumberStudents();
                    updateAwardSummary();
                }
            });


            const activityCategoryCheckboxes = document.querySelectorAll('#activity-category-checkboxes input[type="checkbox"]');
            activityCategoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = Array.from(activityCategoryCheckboxes).filter(cb => cb.checked).length;
                    if (checkedCount > 3) { this.checked = false; alert('活動類別最多只可選 3 項。'); }
                });
            });
            
            attachmentsInput.addEventListener('change', function(event) {
                attachedFiles = Array.from(event.target.files);
                attachmentNamesDiv.innerHTML = attachedFiles.length > 0 ? '已選附件：' + attachedFiles.map(f => f.name).join(', ') : '';
            });

            let assemblyGroupCounter = 0;
            function addAssemblyGroup(groupData = {}) {
                assemblyGroupCounter++;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'assembly-group-item';
                groupDiv.innerHTML = `
                    <div>
                        <label for="assembly-group-name-${assemblyGroupCounter}">組別名稱 (選填)</label>
                        <input type="text" id="assembly-group-name-${assemblyGroupCounter}" class="assembly-group-name" placeholder="例如：中五級" value="${groupData.groupName || ''}">
                    </div>
                    <div>
                        <label for="assembly-group-time-${assemblyGroupCounter}">集合時間</label>
                        <input type="time" id="assembly-group-time-${assemblyGroupCounter}" class="assembly-group-time" value="${groupData.time || ''}">
                    </div>
                    <div>
                        <label for="assembly-group-point-${assemblyGroupCounter}">集合地點</label>
                        <input type="text" id="assembly-group-point-${assemblyGroupCounter}" class="assembly-group-point" value="${groupData.point || ''}">
                    </div>
                    <button type="button" class="remove-assembly-group">移除此組別</button>
                `;
                assemblyGroupsContainer.appendChild(groupDiv);
                groupDiv.querySelector('.remove-assembly-group').addEventListener('click', function() {
                    this.closest('.assembly-group-item').remove();
                });
            }

            addAssemblyGroupButton.addEventListener('click', () => addAssemblyGroup());
            addAssemblyGroup(); 

            let activityDateEntryCounter = 0;
            function addActivityDateEntryUI(entryData = {}) {
                activityDateEntryCounter++;
                const entryDiv = document.createElement('div');
                entryDiv.className = 'activity-date-entry';
                entryDiv.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="min-width: 180px;"> <label for="activity-date-start-${activityDateEntryCounter}">開始日期:</label> <input type="date" id="activity-date-start-${activityDateEntryCounter}" class="activity-date-start" value="${entryData.startDate || ''}"> </div>
                        <div class="form-group" style="min-width: 220px;"> <label for="activity-date-end-${activityDateEntryCounter}">結束日期 (如為單日則留空):</label> <input type="date" id="activity-date-end-${activityDateEntryCounter}" class="activity-date-end" value="${entryData.endDate || ''}"> </div>
                        <div class="form-group" style="flex-grow:1; min-width: 200px;"> <label for="activity-date-type-${activityDateEntryCounter}">活動註記 (選填):</label> <input type="text" id="activity-date-type-${activityDateEntryCounter}" class="activity-date-type" placeholder="例：培訓、比賽日" value="${entryData.type || ''}"> </div>
                        <button type="button" class="remove-activity-date-entry" style="padding: 9px 12px; background-color: #e74c3c; color:white; border:none; border-radius:4px; cursor:pointer; height: fit-content;">移除</button>
                    </div>
                `;
                activityDatesContainer.appendChild(entryDiv);
                entryDiv.querySelector('.remove-activity-date-entry').addEventListener('click', function() {
                    this.closest('.activity-date-entry').remove();
                });

                const startDateInput = entryDiv.querySelector('.activity-date-start');
                const endDateInput = entryDiv.querySelector('.activity-date-end');
                function validateDates() {
                    if (startDateInput.value && endDateInput.value && endDateInput.value < startDateInput.value) {
                        alert('結束日期不能早於開始日期。');
                        endDateInput.value = startDateInput.value;
                    }
                }
                startDateInput.addEventListener('change', validateDates);
                endDateInput.addEventListener('change', validateDates);
            }

            addActivityDateEntryButton.addEventListener('click', () => addActivityDateEntryUI());
            addActivityDateEntryUI(); 

            function updateStudentListHelpText() {
                const isAfterActivity = afterActivityModeCheckbox.checked;
                let helpText = "學生名單 Excel/CSV 檔案格式說明：\n\n檔案應包含以下欄位標題 (大小楷不限，次序不限):\n- 班別 (或 class)\n- 學號 (或 no, number, no.)\n- 姓名 (或 name, student name, student, 學生)\n- 活動角色 (或 role, 角色, position, post, 職務, 職位, 崗位)\n\n";
                if (isAfterActivity) {
                    helpText += "活動完成後模式額外支援欄位:\n" +
                                "- 獎項 (或 award, awards, 獎, 得獎)\n" +
                                "- 獎品/獎金 (或 prize, prizes, gift, gifts, 獎品, 獎金, 獎品 / 獎金)\n" +
                                "- 出席情況 (或 attendance, 出席, 是否出席)\n" +
                                "- 缺席原因 (或 absence reasons, absent reasons, absence reason, absent reason, abs reason, abs reasons, reason of abs, reasons of abs, reason of absence, reasons of absence)\n" +
                                "- 遲到原因 (或 late reason, late reasons, reason of late, reasons of late)\n" +
                                "- 到達時間 (或 arrival time, time of arrival, arrival, arrival at, arrive at, arrive, time, 時間, 抵達時間, 出席時間) (格式: HH:mm)\n" +
                                "- 備註 (或 remarks, remark, comment, comments)\n\n";
                }
                helpText += "第一行為標題行，之後每行為一名學生資料。所有欄位均為選填。";
                studentListHelpBtn.onclick = () => alert(helpText);
            }
            updateStudentListHelpText();


            toggleOriginalPriceVisibility(); toggleParentOptionsVisibility(); toggleExternalOrgDetailsVisibility(); toggleAfterActivityMode(); 

            async function generatePdf() {
                if (!getFormValue('responsible-teacher').trim()) {
                    alert('請填寫負責老師。');
                    document.getElementById('responsible-teacher').focus();
                    return;
                }
                showLoader();
                await new Promise(resolve => setTimeout(resolve, 100)); 

                const pdf = new jsPDF('p', 'mm', 'a4');
                const PDF_MARGIN_X_MM = 8;
                const PDF_MARGIN_Y_TOP_MM = 8;
                const PDF_MARGIN_Y_BOTTOM_MM = 8;
                const pdfPageWidth = pdf.internal.pageSize.getWidth();
                const pdfPageHeight = pdf.internal.pageSize.getHeight();
                const printablePdfWidth = pdfPageWidth - (PDF_MARGIN_X_MM * 2);
                const printablePdfHeight = pdfPageHeight - PDF_MARGIN_Y_TOP_MM - PDF_MARGIN_Y_BOTTOM_MM;

                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM; 
                isFirstPageOfEntireDocumentGlobal = true;  

                const pdfTemplates = [
                    { id: 'pdf-template-notice', populateFunc: populateNoticeTemplate }, 
                    { id: 'pdf-template-e-notice', populateFunc: populateENoticeTemplate },
                    { id: 'pdf-template-external-org', populateFunc: populateExternalOrgTemplate }, 
                    { id: 'pdf-template-slp-form', populateFunc: populateSlpFormTemplate }
                ];

                try {
                    for (let templateIndex = 0; templateIndex < pdfTemplates.length; templateIndex++) {
                        const template = pdfTemplates[templateIndex];
                        template.populateFunc();
                        const element = document.getElementById(template.id);
                        if (!element) { console.error(`PDF template element with ID '${template.id}' not found.`); continue; }

                        if (template.id === 'pdf-template-notice') {
                            const noticeElement = element;
                            const replySlipWrapper = noticeElement.querySelector('.reply-slip-section-wrapper');
                            if (!replySlipWrapper) {
                                console.error("Reply slip wrapper not found in notice template!");
                                throw new Error("Reply slip wrapper not found.");
                            }
                            
                            const prevDisplayNotice = noticeElement.style.display;
                            noticeElement.style.display = 'block'; 
                            const noticeElementWidthForOffscreenRendering = noticeElement.offsetWidth;
                            const computedNoticeStyle = window.getComputedStyle(noticeElement);
                            noticeElement.style.display = prevDisplayNotice; 

                            const originalWrapperDisplay = replySlipWrapper.style.display; 
                            replySlipWrapper.style.display = 'none'; 
                            noticeElement.style.display = 'block'; 
                            noticeElement.style.height = 'auto';
                            noticeElement.style.overflow = 'visible';

                            const mainCanvas = await html2canvas(noticeElement, { scale: 3, useCORS: true, logging: false, imageTimeout: 5000, removeContainer: false, height: noticeElement.scrollHeight, windowHeight: noticeElement.scrollHeight });
                            
                            if (mainCanvas.width === 0 || mainCanvas.height === 0) {
                                console.error("Main canvas for noticeElement has zero dimensions!", noticeElement);
                                replySlipWrapper.style.display = originalWrapperDisplay; 
                                noticeElement.style.display = 'none'; 
                                throw new Error("Main canvas rendered with zero dimensions for notice template.");
                            }
                            
                            noticeElement.style.display = 'none'; 
                            
                            let mainRenderState = await addCanvasToPdfWithSlicing(pdf, mainCanvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = mainRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = mainRenderState.isDocStillFirstPage;
                            
                            const tempOriginalNoticeDisplay_forClone = noticeElement.style.display; 
                            const tempOriginalWrapperDisplay_forClone = replySlipWrapper.style.display;

                            noticeElement.style.display = 'block';    
                            replySlipWrapper.style.display = 'block'; 
                            await new Promise(resolve => requestAnimationFrame(resolve)); 

                            const replySlipCloneForRender = replySlipWrapper.cloneNode(true);

                            replySlipWrapper.style.display = tempOriginalWrapperDisplay_forClone; 
                            noticeElement.style.display = tempOriginalNoticeDisplay_forClone;   


                            const tempRenderContainer = document.createElement('div');
                            tempRenderContainer.className = 'temp-render-container-styles'; 
                            tempRenderContainer.style.display = 'block'; 
                            tempRenderContainer.id = 'pdf-template-notice'; 

                            tempRenderContainer.style.width = noticeElementWidthForOffscreenRendering > 0 ? noticeElementWidthForOffscreenRendering + 'px' : (printablePdfWidth / 25.4 * 96) + 'px';
                            tempRenderContainer.style.fontFamily = computedNoticeStyle.fontFamily;
                            tempRenderContainer.style.fontSize = computedNoticeStyle.fontSize;
                            tempRenderContainer.style.lineHeight = computedNoticeStyle.lineHeight;
                            tempRenderContainer.style.padding = computedNoticeStyle.padding; 
                            tempRenderContainer.style.boxSizing = computedNoticeStyle.boxSizing;
                            tempRenderContainer.style.background = 'white'; 
                            
                            replySlipCloneForRender.style.display = 'block'; 
                            replySlipCloneForRender.style.width = '100%';    
                            replySlipCloneForRender.style.height = 'auto';
                            replySlipCloneForRender.style.overflow = 'visible';

                            tempRenderContainer.appendChild(replySlipCloneForRender);
                            document.body.appendChild(tempRenderContainer);
                            
                            const replyCanvas = await new Promise((resolve, reject) => {
                                requestAnimationFrame(() => { 
                                    requestAnimationFrame(async () => { 
                                        try {
                                            const cloneWidth = replySlipCloneForRender.offsetWidth;
                                            const cloneHeight = replySlipCloneForRender.scrollHeight;
                                            if (cloneWidth === 0 || cloneHeight === 0) {
                                                console.warn(`Reply slip clone has zero dimensions before html2canvas. Width: ${cloneWidth}, Height: ${cloneHeight}. Inspect tempRenderContainer and clone.`, tempRenderContainer, replySlipCloneForRender);
                                                const errorCanvas = document.createElement('canvas'); errorCanvas.width = 1; errorCanvas.height = 1; 
                                                resolve(errorCanvas); 
                                                return;
                                            }
                                            const canvas = await html2canvas(replySlipCloneForRender, {
                                                scale: 3, useCORS: true, logging: false, imageTimeout: 5000,
                                                height: cloneHeight, width: cloneWidth,
                                                windowWidth: replySlipCloneForRender.scrollWidth, windowHeight: cloneHeight
                                            });
                                            resolve(canvas);
                                        } catch (e) {
                                            console.error("Error during html2canvas for reply slip:", e);
                                            reject(e);
                                        }
                                    });
                                });
                            });
                            
                            tempRenderContainer.id = ''; 
                            document.body.removeChild(tempRenderContainer);
                            replySlipWrapper.style.display = originalWrapperDisplay; 

                            if (replyCanvas.width <= 1 && replyCanvas.height <= 1) { 
                                console.error("Reply canvas has effectively zero/minimal dimensions AFTER requestAnimationFrame! PDF part might be missing or tiny.");
                            }

                            const replyHeightInPdfMm = (replyCanvas.height * printablePdfWidth) / replyCanvas.width;
                            let spaceLeftOnCurrentPageMm = printablePdfHeight - (currentGlobalPdfY - PDF_MARGIN_Y_TOP_MM);

                            if (currentGlobalPdfY <= PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                spaceLeftOnCurrentPageMm = printablePdfHeight;
                            }
                            
                            if (replyCanvas.width > 1 && replyCanvas.height > 1 && 
                                replyHeightInPdfMm > spaceLeftOnCurrentPageMm + 0.1 && 
                                currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                pdf.addPage();
                                isFirstPageOfEntireDocumentGlobal = false;
                                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM; 
                            }
                            
                            let replyRenderState = await addCanvasToPdfWithSlicing(pdf, replyCanvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = replyRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = replyRenderState.isDocStillFirstPage;

                        } else { 
                            element.style.display = 'block';
                            element.style.height = 'auto';
                            element.style.overflow = 'visible';
                            const canvas = await html2canvas(element, { scale: 3, useCORS: true, logging: false, imageTimeout: 5000, removeContainer: true, height: element.scrollHeight, windowHeight: element.scrollHeight });
                            
                            if (canvas.width === 0 || canvas.height === 0) {
                                console.error(`Canvas for template ${template.id} has zero dimensions!`, element);
                                element.style.display = 'none';
                                throw new Error(`Canvas for ${template.id} rendered with zero dimensions.`);
                            }
                            element.style.display = 'none';
                            
                            let standardRenderState = await addCanvasToPdfWithSlicing(pdf, canvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                            currentGlobalPdfY = standardRenderState.finalY;
                            isFirstPageOfEntireDocumentGlobal = standardRenderState.isDocStillFirstPage;
                        }

                        if (template.id === 'pdf-template-notice' && templateIndex < pdfTemplates.length - 1) {
                            if (currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1 || (currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM && !isFirstPageOfEntireDocumentGlobal) ) { 
                                pdf.addPage();
                                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                isFirstPageOfEntireDocumentGlobal = false; 
                            }
                        }
                    } 


                    for (const file of attachedFiles) {
                        const textLineHeightMm = 7; 
                        const spaceForAttachmentHeader = textLineHeightMm * 2;

                        if (currentGlobalPdfY !== PDF_MARGIN_Y_TOP_MM && (currentGlobalPdfY + spaceForAttachmentHeader > PDF_MARGIN_Y_TOP_MM + printablePdfHeight) ) { 
                             pdf.addPage(); isFirstPageOfEntireDocumentGlobal = false; currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                        } else if (isFirstPageOfEntireDocumentGlobal && currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM) {
                        } else if (!isFirstPageOfEntireDocumentGlobal && currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM){
                        }


                        pdf.setFontSize(12); let fileTypeDescription = "其他附件";
                        if (file.type.startsWith('image/')) fileTypeDescription = "圖像附件";
                        else if (file.type === 'application/pdf') fileTypeDescription = "PDF附件";
                        else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || file.name.toLowerCase().endsWith('.doc') || file.name.toLowerCase().endsWith('.docx')) fileTypeDescription = "Word文件附件";
                        else if (file.type === 'application/vnd.ms-excel' || file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx')) fileTypeDescription = "Excel文件附件";
                        
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            await new Promise((resolve, reject) => {
                                reader.onload = function(e) {
                                    try {
                                        if (!isFirstPageOfEntireDocumentGlobal || currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1) { 
                                            pdf.addPage(); currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                        }
                                        isFirstPageOfEntireDocumentGlobal = false;

                                        const imgProps = pdf.getImageProperties(e.target.result);
                                        const imgRatio = imgProps.width / imgProps.height;
                                        let imgWidth = printablePdfWidth;
                                        let imgHeight = imgWidth / imgRatio;
                                        if (imgHeight > printablePdfHeight) {
                                            imgHeight = printablePdfHeight;
                                            imgWidth = imgHeight * imgRatio;
                                        }
                                        const x = PDF_MARGIN_X_MM + (printablePdfWidth - imgWidth) / 2;
                                        const y = PDF_MARGIN_Y_TOP_MM + (printablePdfHeight - imgHeight) / 2; 
                                        pdf.addImage(e.target.result, file.type.split('/')[1].toUpperCase(), x, y, imgWidth, imgHeight);
                                        currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM + printablePdfHeight; 
                                        resolve();
                                    } catch (error) { reject(error); }
                                };
                                reader.onerror = reject; reader.readAsDataURL(file);
                            });
                        } else { 
                            pdf.text(`${fileTypeDescription}: ${file.name}`, PDF_MARGIN_X_MM, currentGlobalPdfY);
                            currentGlobalPdfY += textLineHeightMm; 
                            if (currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + printablePdfHeight) { 
                                pdf.addPage(); isFirstPageOfEntireDocumentGlobal = false; currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                                 pdf.text(`${fileTypeDescription}: ${file.name}`, PDF_MARGIN_X_MM, currentGlobalPdfY); 
                                 currentGlobalPdfY += textLineHeightMm;
                            }
                            pdf.text("此類附件將不會在PDF中直接顯示。", PDF_MARGIN_X_MM, currentGlobalPdfY);
                            currentGlobalPdfY += textLineHeightMm;
                            isFirstPageOfEntireDocumentGlobal = false;
                        }
                    }
                    pdf.save('學生活動通告_綜合.pdf');
                } catch (error) {
                    console.error("生成PDF時發生錯誤:", error);
                    alert("生成PDF時發生錯誤，請檢查瀏覽器控制台以獲取更多資訊。\n" + (error.message || error));
                } finally { 
                    pdfTemplates.forEach(template => {
                        const el = document.getElementById(template.id);
                        if (el) { el.style.display = 'none'; } 
                    });
                    hideLoader(); 
                }
            }

            document.getElementById('generate-pdf-main').addEventListener('click', () => generatePdf());
            
            function getFormValue(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
            function getFormDate(id) { 
                const val = getFormValue(id); if (!val) return '';
                try { 
                    const date = new Date(val); 
                    if (isNaN(date.getTime())) return ''; 
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`; 
                } catch (e) { return ''; }
            }
            function formatSingleDateForPDF(dateStr) {
                if (!dateStr) return '\u00A0';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return '\u00A0';
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                } catch (e) { return '\u00A0'; }
            }
            function getFormTimeFromRaw(timeValue) { 
                if (!timeValue) return '';
                const [hours, minutes] = timeValue.split(':');
                if (hours === undefined || minutes === undefined) return timeValue; 
                const H = parseInt(hours);
                if (isNaN(H)) return timeValue;
                const ampm = H >= 12 ? '下午' : '上午';
                const displayH = H % 12 || 12;
                return `${ampm}${displayH}:${minutes.padStart(2, '0')}`;
            }

            function setElementText(id, text) { 
                const el = document.getElementById(id); 
                if(el) el.innerText = text || '\u00A0';
            }
            function setElementHtml(id, html) { 
                const el = document.getElementById(id); 
                if(el) el.innerHTML = html || '\u00A0';
            }

            function getActivityDatesData() {
                const dates = [];
                document.querySelectorAll('#activity-dates-container .activity-date-entry').forEach(entryEl => {
                    const startDate = entryEl.querySelector('.activity-date-start').value;
                    const endDate = entryEl.querySelector('.activity-date-end').value;
                    const type = entryEl.querySelector('.activity-date-type').value;
                    if (startDate) { 
                        dates.push({ startDate, endDate: endDate || startDate, type });
                    }
                });
                return dates;
            }
            
            function formatActivityDateEntryForDisplay(entry) {
                if (!entry || !entry.startDate) return '';
                const start = new Date(entry.startDate);
                const end = entry.endDate ? new Date(entry.endDate) : start;
                let dateStr = `${start.getFullYear()}年${start.getMonth() + 1}月${start.getDate()}日`;
                if (entry.endDate && entry.startDate !== entry.endDate) {
                    dateStr += ` 至 ${end.getFullYear()}年${end.getMonth() + 1}月${end.getDate()}日`;
                }
                if (entry.type) {
                    dateStr += ` (${entry.type})`;
                }
                return dateStr;
            }

            function calculateActivityDetails() {
                const activityDates = getActivityDatesData();
                const assemblyGroups = getAssemblyGroupsData();
                const dismissalTimeValue = getFormValue('dismissal-time');
                let displayTime = "N/A";
                let displayDuration = "N/A";
                let durationUnit = "";

                if (activityDates.length === 0) {
                    return { displayTime, displayDuration, durationUnit };
                }

                if (activityDates.length === 1) {
                    const entry = activityDates[0];
                    const startDate = new Date(entry.startDate + "T00:00:00");
                    const endDate = new Date(entry.endDate + "T00:00:00");

                    if (startDate.getTime() === endDate.getTime()) { 
                        let earliestAssemblyTime = null;
                        assemblyGroups.forEach(group => {
                            if (group.time) {
                                if (!earliestAssemblyTime || group.time < earliestAssemblyTime) {
                                    earliestAssemblyTime = group.time;
                                }
                            }
                        });

                        if (earliestAssemblyTime && dismissalTimeValue) {
                            const assemblyDateTime = new Date(`${entry.startDate}T${earliestAssemblyTime}`);
                            const dismissalDateTime = new Date(`${entry.startDate}T${dismissalTimeValue}`);
                            if (dismissalDateTime > assemblyDateTime) {
                                const durationMs = dismissalDateTime - assemblyDateTime;
                                const durationHours = durationMs / (1000 * 60 * 60);
                                displayDuration = `${durationHours.toFixed(1)}`;
                                durationUnit = "小時";
                                displayTime = `${getFormTimeFromRaw(earliestAssemblyTime)}至${getFormTimeFromRaw(dismissalTimeValue)}`;
                            }
                        }
                    } else { 
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        displayDuration = `${diffDays}`;
                        durationUnit = "天";
                    }
                } else { 
                    let totalDays = 0;
                    activityDates.forEach(entry => {
                        const startDate = new Date(entry.startDate + "T00:00:00");
                        const endDate = new Date(entry.endDate + "T00:00:00");
                        const diffTime = Math.abs(endDate - startDate);
                        totalDays += Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    });
                    displayDuration = `${totalDays}`;
                    durationUnit = "天";
                }
                return { displayTime, displayDuration, durationUnit };
            }


            function getAssemblyGroupsData() {
                const groups = [];
                document.querySelectorAll('#assembly-groups-container .assembly-group-item').forEach(item => {
                    groups.push({
                        groupName: item.querySelector('.assembly-group-name').value,
                        time: item.querySelector('.assembly-group-time').value,
                        point: item.querySelector('.assembly-group-point').value
                    });
                });
                return groups;
            }

            function populateNoticeTemplate() {
                setElementText('pdf-notice-num-header', getFormValue('notice-number'));
                setElementText('pdf-notice-issue-date-moved', getFormDate('notice-issue-date'));
                setElementText('pdf-activity-name', getFormValue('activity-name'));
                setElementText('pdf-activity-location', getFormValue('activity-location'));

                const activityDates = getActivityDatesData();
                const activityDateHtml = activityDates.map(entry => `<div>${formatActivityDateEntryForDisplay(entry) || '\u00A0'}</div>`).join('');
                setElementHtml('pdf-activity-date', activityDateHtml || '<div>\u00A0</div>');
                

                const assemblyGroups = getAssemblyGroupsData();
                let timeHtml = '';
                let pointHtml = '';
                if (assemblyGroups.length > 0 && assemblyGroups.some(g => g.time || g.point)) {
                    assemblyGroups.forEach(group => {
                        const groupLabel = group.groupName ? `${group.groupName}: ` : '';
                        if (group.time) timeHtml += `<div>${groupLabel}${getFormTimeFromRaw(group.time) || '\u00A0'}</div>`;
                        if (group.point) pointHtml += `<div>${groupLabel}${group.point || '\u00A0'}</div>`;
                    });
                }
                setElementHtml('pdf-assembly-time', timeHtml || '<div>\u00A0</div>');
                setElementHtml('pdf-assembly-point', pointHtml || '<div>\u00A0</div>');
                
                setElementText('pdf-dismissal-time', getFormTimeFromRaw(getFormValue('dismissal-time')));
                setElementText('pdf-dismissal-point', getFormValue('dismissal-point'));
                setElementText('pdf-notice-remarks', getFormValue('notice-remarks')); 
                
                const originalPrice = getFormValue('activity-original-price') || '0'; 
                const numPrice = parseFloat(originalPrice);
                const formattedPrice = numPrice % 1 === 0 ? numPrice.toFixed(0) : numPrice.toFixed(1);
                
                const costInfoEl = document.getElementById('pdf-notice-cost-info-container');
                if (costInfoEl) {
                    if (getFormValue('notice-type') === '無需收費通告') { 
                        costInfoEl.innerHTML = `是項活動原價全費為 $${formattedPrice}，經學校及其他津貼現無需收取費用。`; 
                    } else { 
                        costInfoEl.innerHTML = `是項活動費用為每位港幣 $${formattedPrice}，經學校及其他津貼現無需收取費用。`; 
                    }
                }

                setElementText('pdf-notice-num-reply', getFormValue('notice-number'));
                setElementHtml('pdf-activity-name-reply', getFormValue('activity-name'));
                let parentChoice = "批准 / 不批准";
                if (getFormValue('needs-parent-options') === '是') {
                    const optionContent = getFormValue('parent-options-content');
                    if (optionContent === '其他') { parentChoice = getFormValue('parent-options-other') || "\u00A0"; } 
                    else { parentChoice = optionContent; }
                }
                setElementText('pdf-parent-choice-action', parentChoice);

                const responsibleTeacherName = getFormValue('responsible-teacher');
                const teacherDetailSpan = document.getElementById('pdf-responsible-teacher-detail');
                const teacherDetailLabelSpan = document.getElementById('pdf-responsible-teacher-detail-label');
                const teacherSigElement = document.getElementById('pdf-responsible-teacher-sig');
                const teacherSigAreaContainer = teacherSigElement ? teacherSigElement.closest('.notice-teacher-signature-area') : null;

                if (!responsibleTeacherName || responsibleTeacherName.trim() === '') {
                    if (teacherDetailSpan) {
                        teacherDetailSpan.innerHTML = '\u00A0'; 
                        teacherDetailSpan.style.borderBottom = '0.5px solid black'; 
                        teacherDetailSpan.style.display = ''; 
                    }
                    if (teacherDetailLabelSpan) {
                         teacherDetailLabelSpan.style.display = 'none'; 
                    }
                     if (teacherDetailSpan) teacherDetailSpan.style.display = 'none';


                    if (teacherSigAreaContainer) {
                        teacherSigAreaContainer.style.display = 'none';
                    }
                } else {
                    if (teacherDetailSpan) {
                        setElementText('pdf-responsible-teacher-detail', responsibleTeacherName);
                        teacherDetailSpan.style.display = ''; 
                        teacherDetailSpan.style.borderBottom = '0.5px solid black'; 
                    }
                    if (teacherDetailLabelSpan) {
                        teacherDetailLabelSpan.innerText = '負責老師：';
                        teacherDetailLabelSpan.style.display = '';
                    }
                    if (teacherSigAreaContainer) {
                        teacherSigAreaContainer.style.display = '';
                    }
                    setElementText('pdf-responsible-teacher-sig', responsibleTeacherName);
                }
                if (responsibleTeacherName && responsibleTeacherName.trim() !== '') {
                     setElementText('pdf-responsible-teacher-sig', responsibleTeacherName);
                } else if (teacherSigElement){ 
                     teacherSigElement.innerHTML = '&nbsp;';
                }


                document.querySelectorAll('#pdf-template-notice .reply-slip-details-grid .reply-underline-dynamic').forEach(span => {
                    span.innerHTML = '&nbsp;'; 
                });

            }

            function populateENoticeTemplate() {
                setElementText('pdf-en-notice-no', getFormValue('notice-number'));
                setElementText('pdf-en-resp-teacher', getFormValue('responsible-teacher'));
                setElementText('pdf-en-dept', getFormValue('responsible-dept'));
                setElementText('pdf-en-notice-type', getFormValue('notice-type'));
                setElementText('pdf-en-notice-type-detail', getFormValue('notice-type'));
                setElementText('pdf-en-title', getFormValue('activity-name'));
                setElementText('pdf-en-issue-date', getFormDate('notice-issue-date'));
                setElementText('pdf-en-end-date', getFormDate('e-notice-end-date'));
                setElementText('pdf-en-target', getFormValue('notice-target'));
                setElementText('pdf-en-parent-option-needed', getFormValue('needs-parent-options'));
                let parentOptContent = getFormValue('parent-options-content');
                if(parentOptContent === '其他') parentOptContent = getFormValue('parent-options-other');
                setElementText('pdf-en-parent-option-content', getFormValue('needs-parent-options') === '是' ? parentOptContent : '不適用');
            }

            function populateExternalOrgTemplate() {
                setElementText('pdf-ext-involved', getFormValue('involves-external'));
                setElementText('pdf-ext-org-name', getFormValue('involves-external') === '會' ? getFormValue('organizer') : '不適用');
                setElementText('pdf-ext-activity-name', getFormValue('activity-name'));
                setElementText('pdf-ext-activity-date-location', getFormValue('activity-location')); 
                
                const activityDates = getActivityDatesData();
                const firstStartDate = activityDates.length > 0 ? activityDates[0].startDate : '';
                setElementText('pdf-ext-real-activity-date', formatSingleDateForPDF(firstStartDate)); 
                
                setElementText('pdf-ext-internal-resp-name', getFormValue('responsible-teacher'));
                setElementText('pdf-ext-internal-resp-pos', getFormValue('responsible-teacher-position'));
                setElementText('pdf-ext-dept', getFormValue('responsible-dept'));
                setElementText('pdf-ext-internal-colleague-name', getFormValue('responsible-teacher'));
                const dataSource = getFormValue('external-org-data-source');
                const detailsContentEl = document.getElementById('pdf-ext-data-details-content');
                setElementText('pdf-ext-data-attachment-tick', dataSource === '見附件' ? '✓' : '\u00A0\u00A0');
                setElementText('pdf-ext-data-below-tick', dataSource === '見以下資料' ? '✓' : '\u00A0\u00A0');
                if (detailsContentEl) {
                    if (dataSource === '見以下資料') { detailsContentEl.innerText = getFormValue('external-org-details') || '\u00A0'; detailsContentEl.style.display = 'block'; } 
                    else { detailsContentEl.innerText = '\u00A0'; detailsContentEl.style.display = 'none'; }
                }
            }

            function populateSlpFormTemplate() {
                setElementText('pdf-slp-needs-slp', getFormValue('needs-slp') + " 輸入SLP");
                setElementText('pdf-slp-dept', getFormValue('responsible-dept'));
                setElementText('pdf-slp-activity-name', getFormValue('activity-name'));
                setElementText('pdf-slp-resp-teacher', getFormValue('responsible-teacher'));
                setElementText('pdf-slp-leading-teacher', getFormValue('leading-teacher'));
                setElementText('pdf-slp-organizer', getFormValue('organizer'));
                
                const activityDates = getActivityDatesData();
                const activityDateHtml = activityDates.map(entry => `<span>${formatActivityDateEntryForDisplay(entry) || '\u00A0'}</span>`).join('');
                setElementHtml('pdf-slp-activity-date', activityDateHtml || '<span>\u00A0</span>');

                const { displayTime, displayDuration, durationUnit } = calculateActivityDetails();
                setElementText('pdf-slp-activity-time', displayTime);
                setElementText('pdf-slp-activity-duration', displayDuration + (durationUnit ? " " + durationUnit : ""));


                setElementText('pdf-slp-activity-location', getFormValue('activity-location'));
                setElementText('pdf-slp-affects-lessons', getFormValue('affects-lessons'));
                setElementText('pdf-slp-activity-scope', getFormValue('activity-scope'));
                setElementText('pdf-slp-activity-scale', getFormValue('activity-scale'));
                const activityCategories = Array.from(document.querySelectorAll('input[name="activity-category"]:checked')).map(cb => cb.value).join(', ');
                setElementText('pdf-slp-activity-categories', activityCategories);

                const interSchoolCompOrder = ["國民教育", "STEAM教育", "兩文三語", "體藝", "其他"];
                let compHtml = '';
                interSchoolCompOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="inter-school-competition"][value="${val}"]`);
                    if (cb) {
                        compHtml += `<span class="slp-checkbox-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}`;
                        if (val === "其他" && cb.checked) { const otherText = document.querySelector('input[name="inter-school-competition-other"]').value; compHtml += ` (${otherText || '未註明'})`; }
                        else if (val === "其他" && !cb.checked) { const otherText = document.querySelector('input[name="inter-school-competition-other"]').value; if(otherText) compHtml += ` (${otherText})` }
                        compHtml += `</span>`;
                    }
                });
                setElementHtml('pdf-slp-inter-school-comp', compHtml || '無');

                let valueEduHtml = '';
                const valueEduOrder = ["堅毅", "尊重他人", "責任感", "國民身份認同", "承擔精神", "誠信", "關愛", "守法", "同理心", "勤勞"];
                valueEduOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="value-education"][value="${val}"]`);
                    if (cb) { valueEduHtml += `<span class="slp-checkbox-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}</span>`; }
                });
                setElementHtml('pdf-slp-value-edu', valueEduHtml || '無');
                
                let valueLearnHtml = '';
                const valueLearnOrder = [ "品德及倫理範疇", "公民教育", "國民教育", "《憲法》及《基本法》教育", "國家安全教育", "禁毒教育", "生命教育", "性教育", "媒體及資訊素養教育", "可持續發展教育", "人權教育", "誠信教育", "守法教育", "健康生活教育", "家庭生活教育"];
                valueLearnOrder.forEach(val => {
                    const cb = document.querySelector(`input[name="value-learning-scope"][value="${val}"]`);
                    if (cb) { valueLearnHtml += `<div class="slp-value-scope-item">${cb.checked ? '✓ ' : '\u00A0\u00A0 '}${val}</div>`;}
                });
                setElementHtml('pdf-slp-value-learning-scope', valueLearnHtml || '無');

                const slpStudentTbody = document.getElementById('pdf-slp-student-list-tbody');
                if (slpStudentTbody) slpStudentTbody.innerHTML = ''; 
                const studentRows = studentListTbody.querySelectorAll('tr');
                studentRows.forEach((row, index) => {
                    const studentClass = row.querySelector('.student-class').value;
                    const studentId = row.querySelector('.student-id').value;
                    const studentName = row.querySelector('.student-name').value;
                    const roleSelect = row.querySelector('.student-role');
                    const roleOtherInput = row.querySelector('.student-role-other');
                    let roleChairman = '', roleLeader = '', roleParticipant = '', roleOtherText = '';
                    if (roleSelect.value === '主席') roleChairman = '✓'; else if (roleSelect.value === '組長') roleLeader = '✓';
                    else if (roleSelect.value === '參加者') roleParticipant = '✓'; else if (roleSelect.value === '其他') roleOtherText = roleOtherInput.value || '✓';
                    if (slpStudentTbody) {
                        const slpRow = slpStudentTbody.insertRow();
                        slpRow.innerHTML = `<td>${index + 1}.</td><td>${studentClass}</td><td>${studentId}</td><td>${studentName}</td><td>${roleChairman}</td><td>${roleLeader}</td><td>${roleParticipant}</td><td>${roleOtherText}</td>`;
                    }
                });
                if (slpStudentTbody && studentRows.length < 10) { 
                    for (let i = studentRows.length; i < 10; i++) {
                        const emptyRow = slpStudentTbody.insertRow();
                        emptyRow.innerHTML = `<td>${i + 1}.</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
                    }
                }
            }
            
            document.getElementById('export-inputs-excel').addEventListener('click', function() {
                const data = [ ["欄位", "內容"], 
                    ["負責科/組/會社", getFormValue('responsible-dept')], ["活動名稱", getFormValue('activity-name')], 
                    ["負責老師", getFormValue('responsible-teacher')], ["負責老師職位", getFormValue('responsible-teacher-position')], 
                    ["領隊老師", getFormValue('leading-teacher')], ["主辦/合作機構", getFormValue('organizer')], 
                    ["活動日期資料", JSON.stringify(getActivityDatesData())],
                    ["集合安排", JSON.stringify(getAssemblyGroupsData())], 
                    ["解散時間", getFormValue('dismissal-time')], ["解散地點", getFormValue('dismissal-point')], 
                    ["活動地點", getFormValue('activity-location')], ["會否影響課堂", getFormValue('affects-lessons')], 
                    ["活動範圍", getFormValue('activity-scope')], ["活動規模", getFormValue('activity-scale')], 
                    ["活動類別1", document.querySelectorAll('input[name="activity-category"]:checked')[0]?.value || ''], 
                    ["活動類別2", document.querySelectorAll('input[name="activity-category"]:checked')[1]?.value || ''], 
                    ["活動類別3", document.querySelectorAll('input[name="activity-category"]:checked')[2]?.value || ''], 
                    ["是否需要輸入SLP", getFormValue('needs-slp')], ["會否涉及校外機構或人士", getFormValue('involves-external')], 
                    ["通告編號", getFormValue('notice-number')], ["通告類別", getFormValue('notice-type')], 
                    ["活動原價（$）", getFormValue('activity-original-price')], ["擬發出通告日期", getFormValue('notice-issue-date')], 
                    ["結束電子通告日期", getFormValue('e-notice-end-date')], ["通告對象", getFormValue('notice-target')], 
                    ["是否需要提供家長選項", getFormValue('needs-parent-options')], ["家長的選項內容", getFormValue('parent-options-content')], 
                    ["家長選項其他", getFormValue('parent-options-other')], ["通告備註", getFormValue('notice-remarks')], 
                    ["外間組織/人士的資料提供方式", getFormValue('external-org-data-source')], ["外間組織/人士的資料", getFormValue('external-org-details')],
                    ["活動完成後模式", afterActivityModeCheckbox.checked]
                ];
                const interSchoolComp = []; document.querySelectorAll('input[name="inter-school-competition"]').forEach(cb => { if (cb.type === 'checkbox') interSchoolComp.push(`${cb.value}:${cb.checked}`); else if (cb.type === 'text') interSchoolComp.push(`other_text:${cb.value}`); });
                data.push(["全港性校際比賽", interSchoolComp.join(',')]);
                const valueEducation = Array.from(document.querySelectorAll('input[name="value-education"]:checked')).map(cb => cb.value).join(','); data.push(["活動包含價值教育", valueEducation]);
                const valueLearningScope = Array.from(document.querySelectorAll('input[name="value-learning-scope"]:checked')).map(cb => cb.value).join(','); data.push(["價值相關學習範圍", valueLearningScope]);
                
                const students = []; 
                studentListTbody.querySelectorAll('tr').forEach(row => { 
                    const studentEntry = { 
                        class: row.querySelector('.student-class').value, 
                        id: row.querySelector('.student-id').value, 
                        name: row.querySelector('.student-name').value, 
                        role: row.querySelector('.student-role').value, 
                        roleOther: row.querySelector('.student-role-other').value
                    };
                    if (afterActivityModeCheckbox.checked) {
                        studentEntry.awards = row.querySelector('.student-awards').value;
                        studentEntry.prizes = row.querySelector('.student-prizes').value;
                        studentEntry.attendance = row.querySelector('.student-attendance').value;
                        studentEntry.absenceReason = row.querySelector('.student-absence-reason').value;
                        studentEntry.latenessReason = row.querySelector('.student-lateness-reason').value;
                        studentEntry.arrivalTime = row.querySelector('.student-arrival-time').value;
                        studentEntry.remarks = row.querySelector('.student-remarks').value;
                    }
                    students.push(JSON.stringify(studentEntry));
                });
                data.push(["出席學生名單", students.join('||')]); 
                const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "活動資料收集_Save"); XLSX.writeFile(wb, "活動通告輸入備份.xlsx");
            });

            document.getElementById('import-excel-input').addEventListener('change', function(event) {
                const file = event.target.files[0]; 
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0]; 
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); const formData = {};
                        jsonData.slice(1).forEach(row => { if(row[0] && row[1] !== undefined) formData[row[0]] = row[1];});
                        function setFormValue(id, value) { if(document.getElementById(id) && value !== undefined && value !== null) document.getElementById(id).value = value; }
                        setFormValue('responsible-dept', formData['負責科/組/會社']); setFormValue('activity-name', formData['活動名稱']); setFormValue('responsible-teacher', formData['負責老師']); setFormValue('responsible-teacher-position', formData['負責老師職位']); setFormValue('leading-teacher', formData['領隊老師']); setFormValue('organizer', formData['主辦/合作機構']); 
                        
                        activityDatesContainer.innerHTML = ''; 
                        activityDateEntryCounter = 0;
                        if (formData['活動日期資料']) {
                            try {
                                const importedActivityDates = JSON.parse(formData['活動日期資料']);
                                if (Array.isArray(importedActivityDates) && importedActivityDates.length > 0) {
                                    importedActivityDates.forEach(dateEntry => addActivityDateEntryUI(dateEntry));
                                } else { addActivityDateEntryUI(); }
                            } catch (err) { console.error("Error parsing 活動日期資料 from Excel:", err); addActivityDateEntryUI(); }
                        } else { addActivityDateEntryUI(); }


                        setFormValue('dismissal-time', formData['解散時間']); setFormValue('dismissal-point', formData['解散地點']); 
                        setFormValue('activity-location', formData['活動地點']); setFormValue('affects-lessons', formData['會否影響課堂']); setFormValue('activity-scope', formData['活動範圍']); setFormValue('activity-scale', formData['活動規模']);
                        
                        assemblyGroupsContainer.innerHTML = ''; 
                        assemblyGroupCounter = 0;
                        if (formData['集合安排']) {
                            try {
                                const importedAssemblyGroups = JSON.parse(formData['集合安排']);
                                if (Array.isArray(importedAssemblyGroups) && importedAssemblyGroups.length > 0) {
                                    importedAssemblyGroups.forEach(group => addAssemblyGroup(group));
                                } else { addAssemblyGroup(); }
                            } catch (err) { console.error("Error parsing 集合安排 from Excel:", err); addAssemblyGroup(); }
                        } else { addAssemblyGroup(); }


                        document.querySelectorAll('input[name="activity-category"]').forEach(cb => cb.checked = false);
                        const cat1 = formData['活動類別1']; if(cat1) { const cb = document.querySelector(`input[name="activity-category"][value="${cat1}"]`); if(cb) cb.checked = true; }
                        const cat2 = formData['活動類別2']; if(cat2) { const cb = document.querySelector(`input[name="activity-category"][value="${cat2}"]`); if(cb) cb.checked = true; }
                        const cat3 = formData['活動類別3']; if(cat3) { const cb = document.querySelector(`input[name="activity-category"][value="${cat3}"]`); if(cb) cb.checked = true; }
                        setFormValue('needs-slp', formData['是否需要輸入SLP']); setFormValue('involves-external', formData['會否涉及校外機構或人士']); setFormValue('notice-number', formData['通告編號']); setFormValue('notice-type', formData['通告類別']); setFormValue('activity-original-price', formData['活動原價（$）']); setFormValue('notice-issue-date', formData['擬發出通告日期']); setFormValue('e-notice-end-date', formData['結束電子通告日期']); setFormValue('notice-target', formData['通告對象']); setFormValue('needs-parent-options', formData['是否需要提供家長選項']); setFormValue('parent-options-content', formData['家長的選項內容']); setFormValue('parent-options-other', formData['家長選項其他']); setFormValue('notice-remarks', formData['通告備註']); setFormValue('external-org-data-source', formData['外間組織/人士的資料提供方式']); setFormValue('external-org-details', formData['外間組織/人士的資料']);
                        if (formData['全港性校際比賽']) { const compData = formData['全港性校際比賽'].toString().split(','); document.querySelectorAll('input[name="inter-school-competition"]').forEach(cb => { if (cb.type === 'checkbox') { cb.checked = !!compData.find(d => d === `${cb.value}:true`); } else if (cb.type === 'text' && cb.name === 'inter-school-competition-other') { const match = compData.find(d => d.startsWith(`other_text:`)); if (match) cb.value = match.split(':')[1]; }});}
                        if (formData['活動包含價值教育']) { const values = formData['活動包含價值教育'].toString().split(','); document.querySelectorAll('input[name="value-education"]').forEach(cb => cb.checked = values.includes(cb.value));}
                        if (formData['價值相關學習範圍']) { const scopes = formData['價值相關學習範圍'].toString().split(','); document.querySelectorAll('input[name="value-learning-scope"]').forEach(cb => cb.checked = scopes.includes(cb.value));}
                        
                        if (formData['活動完成後模式'] === true || formData['活動完成後模式'] === 'true') {
                            afterActivityModeCheckbox.checked = true;
                        } else {
                            afterActivityModeCheckbox.checked = false;
                        }
                        toggleAfterActivityMode();


                        studentListTbody.innerHTML = ''; studentCounter = 0;
                        if (formData['出席學生名單'] && formData['出席學生名單'].length > 0) {
                            const studentStrings = formData['出席學生名單'].toString().split('||');
                            studentStrings.forEach(s => { if (s) { try { const student = JSON.parse(s); addStudentRow(student); } catch(e){console.error("Error parsing student data from Excel:", s, e)} }}); 
                        } if (studentListTbody.children.length === 0) { addStudentRow(); }
                        renumberStudents();
                        updateAwardSummary();
                        noticeTypeSelect.dispatchEvent(new Event('change')); needsParentOptionsSelect.dispatchEvent(new Event('change')); parentOptionsContentSelect.dispatchEvent(new Event('change')); externalOrgDataSourceSelect.dispatchEvent(new Event('change'));
                        alert('資料已成功匯入！');
                    };
                    reader.readAsArrayBuffer(file); 
                    event.target.value = null; 
                }
            });

            document.getElementById('import-student-list-input').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                showLoader();
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        let jsonData;
                        if (file.name.endsWith('.csv')) {
                            const csvData = XLSX.read(data, {type: 'string', raw: true}); 
                            const worksheet = csvData.Sheets[csvData.SheetNames[0]];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        } else { 
                            const workbook = XLSX.read(data, {type: 'array'});
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        }

                        if (!jsonData || jsonData.length < 1) {
                            alert('學生名單檔案為空或格式不正確。'); return;
                        }
                        
                        const headers = jsonData[0].map(h => String(h || '').toLowerCase().trim()); 
                        const colMap = { class: -1, no: -1, name: -1, role: -1, awards: -1, prizes: -1, attendance: -1, absenceReason: -1, latenessReason: -1, arrivalTime: -1, remarks: -1 };

                        headers.forEach((header, index) => {
                            if (["class", "班別"].includes(header)) colMap.class = index;
                            else if (["no", "number", "no.", "學號"].includes(header)) colMap.no = index;
                            else if (["name", "student name", "姓名", "student", "學生"].includes(header)) colMap.name = index;
                            else if (["role", "活動角色", "角色", "position", "post", "職務", "職位", "崗位"].includes(header)) colMap.role = index;
                            else if (["awards", "award", "獎項", "獎", "得獎"].includes(header)) colMap.awards = index;
                            else if (["prizes", "prize", "gift", "gifts", "獎品/獎金", "獎品 / 獎金", "獎品", "獎金"].includes(header)) colMap.prizes = index;
                            else if (["attendance", "出席情況", "出席", "是否出席"].includes(header)) colMap.attendance = index;
                            else if (["absence reason", "absencereason", "absent reason", "absentreason", "缺席原因", "abs reason", "reason of absence", "reasons of absence"].includes(header)) colMap.absenceReason = index;
                            else if (["late reason", "latereason", "遲到原因", "reason of late", "reasons of late"].includes(header)) colMap.latenessReason = index;
                            else if (["arrival time", "arrivaltime", "time of arrival", "arrival", "arrival at", "arrive at", "arrive", "time", "到達時間", "時間", "抵達時間", "出席時間"].includes(header)) colMap.arrivalTime = index;
                            else if (["remarks", "remark", "comment", "comments", "備註"].includes(header)) colMap.remarks = index;
                        });

                        studentListTbody.innerHTML = ''; 
                        studentCounter = 0; 

                        jsonData.slice(1).forEach(row => {
                            if (row.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '')) { 
                                const studentData = {
                                    class: colMap.class !== -1 ? (row[colMap.class] || '') : '',
                                    id: colMap.no !== -1 ? (row[colMap.no] || '') : '',
                                    name: colMap.name !== -1 ? (row[colMap.name] || '') : '',
                                    role: colMap.role !== -1 ? (String(row[colMap.role] || '').trim()) : '參加者',
                                    awards: colMap.awards !== -1 ? (row[colMap.awards] || '') : '',
                                    prizes: colMap.prizes !== -1 ? (row[colMap.prizes] || '') : '',
                                    attendance: colMap.attendance !== -1 ? (row[colMap.attendance] || '出席') : '出席',
                                    absenceReason: colMap.absenceReason !== -1 ? (row[colMap.absenceReason] || '') : '',
                                    latenessReason: colMap.latenessReason !== -1 ? (row[colMap.latenessReason] || '') : '',
                                    arrivalTime: colMap.arrivalTime !== -1 ? (row[colMap.arrivalTime] || '') : '',
                                    remarks: colMap.remarks !== -1 ? (row[colMap.remarks] || '') : ''
                                };
                                addStudentRow(studentData);
                            }
                        });
                        if (studentListTbody.children.length === 0) addStudentRow(); 
                        renumberStudents();
                        updateAwardSummary();
                        alert('學生名單已成功匯入！');
                    } catch (err) {
                        console.error("匯入學生名單時發生錯誤:", err);
                        alert("匯入學生名單時發生錯誤: " + err.message);
                    } finally {
                        hideLoader();
                        event.target.value = null; 
                    }
                };
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            downloadOriginalBlankTemplateBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.href = 'PL1 通告綜合版_無需收費__BLANK_20250214.xlsx'; 
                link.download = 'PL1 通告綜合版_無需收費__BLANK_20250214.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });


            photoDropZone.addEventListener('click', () => activityPhotosInput.click());
            photoDropZone.addEventListener('dragover', (event) => {
                event.preventDefault();
                photoDropZone.classList.add('dragover');
            });
            photoDropZone.addEventListener('dragleave', () => photoDropZone.classList.remove('dragover'));
            photoDropZone.addEventListener('drop', (event) => {
                event.preventDefault();
                photoDropZone.classList.remove('dragover');
                if (event.dataTransfer.files) {
                    handlePhotoFiles(event.dataTransfer.files);
                }
            });
            activityPhotosInput.addEventListener('change', (event) => handlePhotoFiles(event.target.files));

            function handlePhotoFiles(files) {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        if (!activityPhotos.find(f => f.name === file.name && f.size === file.size)) {
                             activityPhotos.push(file);
                        }
                    }
                }
                renderPhotoPreviews();
                activityPhotosInput.value = null; 
            }

            function renderPhotoPreviews() {
                photoPreviewsContainer.innerHTML = '';
                activityPhotos.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'photo-preview-item';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-photo-btn';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.title = '移除此相片';
                        removeBtn.onclick = () => {
                            activityPhotos.splice(index, 1);
                            renderPhotoPreviews();
                        };
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        photoPreviewsContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function updateAwardSummary() {
                if (!afterActivityModeCheckbox.checked) return;

                let totalAwardsCount = 0;
                const uniqueAwards = new Set();
                const uniquePrizes = new Set();

                studentListTbody.querySelectorAll('tr').forEach(row => {
                    const awardsText = row.querySelector('.student-awards')?.value || '';
                    const prizesText = row.querySelector('.student-prizes')?.value || '';

                    awardsText.split('\n').forEach(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine) {
                            totalAwardsCount++;
                            uniqueAwards.add(trimmedLine);
                        }
                    });
                    prizesText.split('\n').forEach(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine) {
                            uniquePrizes.add(trimmedLine);
                        }
                    });
                });

                document.getElementById('total-awards-count').textContent = totalAwardsCount;
                const uniqueAwardsListEl = document.getElementById('unique-awards-list');
                uniqueAwardsListEl.innerHTML = '';
                if (uniqueAwards.size > 0) {
                    uniqueAwards.forEach(award => {
                        const li = document.createElement('li');
                        li.textContent = award;
                        uniqueAwardsListEl.appendChild(li);
                    });
                } else {
                    uniqueAwardsListEl.innerHTML = '<li>尚無獎項</li>';
                }

                const uniquePrizesListEl = document.getElementById('unique-prizes-list');
                uniquePrizesListEl.innerHTML = '';
                if (uniquePrizes.size > 0) {
                    uniquePrizes.forEach(prize => {
                        const li = document.createElement('li');
                        li.textContent = prize;
                        uniquePrizesListEl.appendChild(li);
                    });
                } else {
                    uniquePrizesListEl.innerHTML = '<li>尚無獎品/獎金</li>';
                }
            }
            
            function populateBFormTemplate() {
                setElementText('pdf-b-activity-name', getFormValue('activity-name'));
                setElementText('pdf-b-resp-teacher', getFormValue('responsible-teacher'));
                setElementText('pdf-b-organizer', getFormValue('organizer'));
                setElementText('pdf-b-notice-no', getFormValue('notice-number'));

                const studentListRenderArea = document.getElementById('pdf-b-student-list-render-area');
                studentListRenderArea.innerHTML = '';
                const table = document.createElement('table');
                table.className = 'b-form-student-table';
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                const headers = ["序號", "班別", "學號", "姓名", "角色", "獎項", "獎品/獎金", "出席情況", "缺席原因", "遲到原因", "到達時間", "備註"];
                headers.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                const tbody = table.createTBody();
                studentListTbody.querySelectorAll('tr').forEach((row, index) => {
                    const tr = tbody.insertRow();
                    tr.insertCell().textContent = index + 1;
                    tr.insertCell().textContent = row.querySelector('.student-class').value;
                    tr.insertCell().textContent = row.querySelector('.student-id').value;
                    tr.insertCell().textContent = row.querySelector('.student-name').value;
                    let role = row.querySelector('.student-role').value;
                    if (role === '其他') role = row.querySelector('.student-role-other').value || '其他';
                    tr.insertCell().textContent = role;
                    tr.insertCell().textContent = row.querySelector('.student-awards').value.replace(/\n/g, '; ');
                    tr.insertCell().textContent = row.querySelector('.student-prizes').value.replace(/\n/g, '; ');
                    tr.insertCell().textContent = row.querySelector('.student-attendance').value;
                    tr.insertCell().textContent = row.querySelector('.student-absence-reason').value;
                    tr.insertCell().textContent = row.querySelector('.student-lateness-reason').value;
                    tr.insertCell().textContent = getFormTimeFromRaw(row.querySelector('.student-arrival-time').value);
                    tr.insertCell().textContent = row.querySelector('.student-remarks').value;
                });
                studentListRenderArea.appendChild(table);

                setElementText('pdf-b-total-awards-count', document.getElementById('total-awards-count').textContent);
                document.getElementById('pdf-b-unique-awards-list').innerHTML = document.getElementById('unique-awards-list').innerHTML;
                document.getElementById('pdf-b-unique-prizes-list').innerHTML = document.getElementById('unique-prizes-list').innerHTML;
            }

            async function generateBFormPdf() {
                if (activityPhotos.length === 0) {
                    alert("請至少上載一張具代表性的活動相片。");
                    return;
                }
                showLoader();
                await new Promise(resolve => setTimeout(resolve, 50));

                const pdf = new jsPDF('p', 'mm', 'a4');
                const PDF_MARGIN_X_MM = 10;
                const PDF_MARGIN_Y_TOP_MM = 10;
                const PDF_MARGIN_Y_BOTTOM_MM = 10;
                const pdfPageWidth = pdf.internal.pageSize.getWidth();
                const pdfPageHeight = pdf.internal.pageSize.getHeight();
                const printablePdfWidth = pdfPageWidth - (PDF_MARGIN_X_MM * 2);
                const printablePdfHeight = pdfPageHeight - PDF_MARGIN_Y_TOP_MM - PDF_MARGIN_Y_BOTTOM_MM;
                
                currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                isFirstPageOfEntireDocumentGlobal = true;

                try {
                    populateBFormTemplate();
                    const bFormElement = document.getElementById('pdf-template-b-form');
                    const photoRenderArea = bFormElement.querySelector('#pdf-b-photo-render-area');
                    photoRenderArea.style.display = 'none'; 

                    bFormElement.style.display = 'block';
                    bFormElement.style.height = 'auto';
                    bFormElement.style.overflow = 'visible';

                    const canvas = await html2canvas(bFormElement, { scale: 2.5, useCORS: true, logging: false, imageTimeout: 5000, height: bFormElement.scrollHeight, windowHeight: bFormElement.scrollHeight });
                    bFormElement.style.display = 'none';
                    photoRenderArea.style.display = ''; 

                    let renderState = await addCanvasToPdfWithSlicing(pdf, canvas, currentGlobalPdfY, isFirstPageOfEntireDocumentGlobal, PDF_MARGIN_X_MM, PDF_MARGIN_Y_TOP_MM, printablePdfWidth, printablePdfHeight);
                    currentGlobalPdfY = renderState.finalY;
                    isFirstPageOfEntireDocumentGlobal = renderState.isDocStillFirstPage;

                    const PHOTO_COLS = 2;
                    const PHOTO_GAP_MM = 4;
                    const photoWidthMm = (printablePdfWidth - (PHOTO_COLS - 1) * PHOTO_GAP_MM) / PHOTO_COLS;
                    
                    if (activityPhotos.length > 0) {
                         if (currentGlobalPdfY > PDF_MARGIN_Y_TOP_MM + 0.1 || (currentGlobalPdfY === PDF_MARGIN_Y_TOP_MM && !isFirstPageOfEntireDocumentGlobal) ) {
                            pdf.addPage();
                            currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                            isFirstPageOfEntireDocumentGlobal = false;
                         }
                    }


                    for (let i = 0; i < activityPhotos.length; i++) {
                        const file = activityPhotos[i];
                        const reader = new FileReader();
                        const imgDataUrl = await new Promise((resolve, reject) => {
                            reader.onload = e => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });

                        const imgProps = pdf.getImageProperties(imgDataUrl);
                        const imgRatio = imgProps.width / imgProps.height;
                        const photoHeightMm = photoWidthMm / imgRatio;

                        const colIndex = i % PHOTO_COLS;
                        
                        let currentX = PDF_MARGIN_X_MM + colIndex * (photoWidthMm + PHOTO_GAP_MM);
                        
                        if (colIndex === 0 && i > 0) { 
                             currentGlobalPdfY += PHOTO_GAP_MM; 
                        }

                        if (currentGlobalPdfY + photoHeightMm > PDF_MARGIN_Y_TOP_MM + printablePdfHeight) {
                            pdf.addPage();
                            currentGlobalPdfY = PDF_MARGIN_Y_TOP_MM;
                            isFirstPageOfEntireDocumentGlobal = false;
                            currentX = PDF_MARGIN_X_MM; 
                        }
                        
                        pdf.addImage(imgDataUrl, 'PNG', currentX, currentGlobalPdfY, photoWidthMm, photoHeightMm, undefined, 'FAST');

                        if (colIndex === PHOTO_COLS - 1 || i === activityPhotos.length - 1) { 
                            currentGlobalPdfY += photoHeightMm;
                        }
                    }
                    pdf.save('B表_最終名單及比賽獎項記錄表.pdf');
                } catch (error) {
                    console.error("生成B表 PDF時發生錯誤:", error);
                    alert("生成B表 PDF時發生錯誤: " + (error.message || error));
                } finally {
                    document.getElementById('pdf-template-b-form').style.display = 'none';
                    hideLoader();
                }
            }
            generatePdfBButton.addEventListener('click', generateBFormPdf);

        }); 
    </script>
</body>
</html>
